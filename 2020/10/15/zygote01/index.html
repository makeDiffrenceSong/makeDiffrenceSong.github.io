<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>启动Zygote进程与java虚拟机 | Make a difference</title><meta name="keywords" content="zygote"><meta name="author" content="SongSong"><meta name="copyright" content="SongSong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Zygote进程简介Zygote进程的主要作用通过Zygote进程共享已运行的虚拟机的代码与内存信息, 缩短应用程序运行所耗费的时间. 也就是说, Zygote进程会事先将应用程序要使用的Android Framework中的类与资源加载到内存中, 并组织形成所用资源的链接信息. 这样, 新运行的Android应用程序在使用所需资源时不必每次形成资源的链接信息, 这样就大大提升了程序的运行时间.Z">
<meta property="og:type" content="article">
<meta property="og:title" content="启动Zygote进程与java虚拟机">
<meta property="og:url" content="http://example.com/2020/10/15/zygote01/index.html">
<meta property="og:site_name" content="Make a difference">
<meta property="og:description" content="Zygote进程简介Zygote进程的主要作用通过Zygote进程共享已运行的虚拟机的代码与内存信息, 缩短应用程序运行所耗费的时间. 也就是说, Zygote进程会事先将应用程序要使用的Android Framework中的类与资源加载到内存中, 并组织形成所用资源的链接信息. 这样, 新运行的Android应用程序在使用所需资源时不必每次形成资源的链接信息, 这样就大大提升了程序的运行时间.Z">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2020-10-15T08:31:28.000Z">
<meta property="article:modified_time" content="2020-11-17T00:51:34.021Z">
<meta property="article:author" content="SongSong">
<meta property="article:tag" content="zygote">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/10/15/zygote01/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-11-17 08:51:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Make a difference" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/friend.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">69</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">10</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">19</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zygote%E8%BF%9B%E7%A8%8B%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">Zygote进程简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-zygote%E5%90%AF%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">1.zygote启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%90%AF%E5%8A%A8zygote%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 启动zygote进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%89%A7%E8%A1%8Capp-main-cpp-%E4%B8%AD%E7%9A%84main%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 执行app_main.cpp 中的main方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 创建虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-AppRuntime"><span class="toc-number">2.3.1.</span> <span class="toc-text">1.3.1 AppRuntime</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-AndroidRuntime%E7%9A%84start%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.2.</span> <span class="toc-text">1.3.2 AndroidRuntime的start函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-1-JniInvocation-init%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">1.3.2.1 JniInvocation.init初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-2-startVm%E5%A4%84%E7%90%86"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">1.3.2.2 startVm处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-3-startReg"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">1.3.2.3 startReg</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-zygote%E5%90%AF%E5%8A%A8System-Server%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">2.zygote启动System_Server进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E5%90%AF%E5%8A%A8%E8%99%9A%E6%8B%9F%E6%9C%BAZygoteInit%E7%9A%84main%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text">2.1启动虚拟机ZygoteInit的main方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-registerServerSocketFromEnv"><span class="toc-number">3.1.1.</span> <span class="toc-text">2.4.1 registerServerSocketFromEnv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-preload"><span class="toc-number">3.1.2.</span> <span class="toc-text">2.4.2 preload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-forkSystemServer"><span class="toc-number">3.1.3.</span> <span class="toc-text">2.4.3 forkSystemServer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-1-forkSystemServer"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">2.4.3.1 forkSystemServer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-2-handleSystemServerProcess"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">2.4.3.2 handleSystemServerProcess</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-3-ZygoteInit-zygoteInit"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">2.4.3.3 ZygoteInit.zygoteInit()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-fork%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">3.fork应用进程</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Make a difference</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">启动Zygote进程与java虚拟机</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-10-15T08:31:28.000Z" title="Created 2020-10-15 16:31:28">2020-10-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-11-17T00:51:34.021Z" title="Updated 2020-11-17 08:51:34">2020-11-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/zygote/">zygote</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Zygote进程简介"><a href="#Zygote进程简介" class="headerlink" title="Zygote进程简介"></a>Zygote进程简介</h1><p>Zygote进程的主要作用通过Zygote进程共享已运行的虚拟机的代码与内存信息, 缩短应用程序运行所耗费的时间. 也就是说, Zygote进程会事先将应用程序要使用的Android Framework中的类与资源加载到内存中, 并组织形成所用资源的链接信息. 这样, 新运行的Android应用程序在使用所需资源时不必每次形成资源的链接信息, 这样就大大提升了程序的运行时间.Zygote进程起到了预加载资源和类到虚拟机 加快启动应用程序的作用。</p>
<p>Zygote进程的启动流程，以下是Zygote进程fork出system_server和应用进程的主要类的关系图：</p>
<p><img src="/images/zygote01/Zygote&aSystem_server.bmp" alt="Zygote&amp;aSystem_server"></p>
<h1 id="1-zygote启动"><a href="#1-zygote启动" class="headerlink" title="1.zygote启动"></a>1.zygote启动</h1><h2 id="1-1-启动zygote进程"><a href="#1-1-启动zygote进程" class="headerlink" title="1.1 启动zygote进程"></a>1.1 启动zygote进程</h2><p>zygote进程是由init进程通过解析init.zygote.rc文件而创建的，zygote锁对应的可执行程序为app_process，所对应的源文件是 app_main.cpp ，进程名为zygote  。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat system/core/rootdir/init.zygote64.rc </span><br><span class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">    class main</span><br><span class="line">    priority -20</span><br><span class="line">    user root</span><br><span class="line">    group root readproc reserved_disk</span><br><span class="line">    socket zygote stream 660 root system</span><br><span class="line">    onrestart write /sys/android_power/request_state wake</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    onrestart restart audioserver</span><br><span class="line">    onrestart restart cameraserver</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    onrestart restart wificond</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="1-2-执行app-main-cpp-中的main方法"><a href="#1-2-执行app-main-cpp-中的main方法" class="headerlink" title="1.2 执行app_main.cpp 中的main方法"></a>1.2 执行app_main.cpp 中的main方法</h2><p>下面我们来分析一下app_process 这个进程：</p>
<p>app_process 这个进程不仅能启动zygote 而且也是可以启动一个普通的类的，他会根据你参数的不同来实现不同的功能。</p>
<p>-Xzygote 这个参数是传给虚拟机的，并不是传给app_process 的，表示需要<strong>重新初始化一个新的jvm</strong></p>
<p>–zygote: 这个参数传给app_process 表示启动zygote 模式。</p>
<p>–start-system-server：这个参数表示启动systemServer 服务。一般情况下，这个参数只有zygote 模式才有，因为其他模式貌似不需要这个东西。</p>
<p>–socket-name=zygote：这个参数表示socket 的名称，因为zygote 启动完毕后，并不会退出，他还负责为其他应用创建进程，ams就是通过这个socket与zygote 通讯来完成进程创建的。</p>
<p>–application：这个其实是另外一种模式的标志，表示启动的为普通应用，</p>
<p>–nice-name= 这个表示创建的进程的名字，zygote 模式没有这个东西。</p>
<p>-classpath 或者-cp 这个为创建普通应用时的class路径，我猜的。</p>
<p>app_process 的main函数主要是对于以上的参数的处理，除了这个之外就是新建APPRuntime类</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</span><br></pre></td></tr></table></figure>

<p>这个类负责启动java的main class</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ..........</span><br><span class="line"></span><br><span class="line">   <span class="comment">//通过执行system/bin/app_process命令，根据service zygote /system/bin/app_process -Xzygote /system/bin -	-zygote --start-system-server传入参数</span></span><br><span class="line">	<span class="comment">//argc是传入参数的参数数目：argc=5</span></span><br><span class="line">	<span class="comment">//argv是传入的参数值：</span></span><br><span class="line">	<span class="comment">//                 argv[0]=&quot;/system/bin/app_process&quot; </span></span><br><span class="line">	<span class="comment">//                 argv[1]=&quot;-Xzygote&quot; </span></span><br><span class="line">	<span class="comment">//                 argv[2]=&quot;/system/bin&quot;</span></span><br><span class="line">	<span class="comment">//                 argv[3]=&quot;--zygote&quot;</span></span><br><span class="line">	<span class="comment">//                 argv[4]=&quot;--start-system-server&quot;</span></span><br><span class="line">    <span class="function">AppRuntime <span class="title">runtime</span><span class="params">(argv[<span class="number">0</span>], computeArgBlockSize(argc, argv))</span></span>;</span><br><span class="line">    <span class="comment">// Process command line arguments</span></span><br><span class="line">    <span class="comment">// ignore argv[0]</span></span><br><span class="line">    argc--;</span><br><span class="line">    argv++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* spaced_commands[] = &#123; <span class="string">&quot;-cp&quot;</span>, <span class="string">&quot;-classpath&quot;</span> &#125;;</span><br><span class="line">    <span class="comment">// Allow &quot;spaced commands&quot; to be succeeded by exactly 1 argument (regardless of -s).</span></span><br><span class="line">    <span class="keyword">bool</span> known_command = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//把以“-”打头的参数传递给虚拟机，对于zygote，是把”-Xzygote”传入虚拟机</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (known_command == <span class="literal">true</span>) &#123;</span><br><span class="line">          runtime.addOption(strdup(argv[i]));</span><br><span class="line">          <span class="comment">// The static analyzer gets upset that we don&#x27;t ever free the above</span></span><br><span class="line">          <span class="comment">// string. Since the allocation is from main, leaking it doesn&#x27;t seem</span></span><br><span class="line">          <span class="comment">// problematic. NOLINTNEXTLINE</span></span><br><span class="line">          ALOGV(<span class="string">&quot;app_process main add known option &#x27;%s&#x27;&quot;</span>, argv[i]);</span><br><span class="line">          known_command = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">             j &lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(<span class="keyword">sizeof</span>(spaced_commands) / <span class="keyword">sizeof</span>(spaced_commands[<span class="number">0</span>]));</span><br><span class="line">             ++j) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], spaced_commands[j]) == <span class="number">0</span>) &#123;</span><br><span class="line">            known_command = <span class="literal">true</span>;</span><br><span class="line">            ALOGV(<span class="string">&quot;app_process main found known command &#x27;%s&#x27;&quot;</span>, argv[i]);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">&#x27;-&#x27;</span> &amp;&amp; argv[i][<span class="number">2</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            ++i; <span class="comment">// Skip --.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        runtime.addOption(strdup(argv[i]));</span><br><span class="line">        <span class="comment">// The static analyzer gets upset that we don&#x27;t ever free the above</span></span><br><span class="line">        <span class="comment">// string. Since the allocation is from main, leaking it doesn&#x27;t seem</span></span><br><span class="line">        <span class="comment">// problematic. NOLINTNEXTLINE</span></span><br><span class="line">        ALOGV(<span class="string">&quot;app_process main add option &#x27;%s&#x27;&quot;</span>, argv[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line">    </span><br><span class="line">	++i;  <span class="comment">// Skip unused &quot;parent dir&quot; argument.</span></span><br><span class="line">    <span class="comment">//解析剩余传入的参数，根据上一个语句块的处理，此时剩余参数值为：”/system/bin”、”–zygote”和”–start-system-server”</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="comment">//根据参数&quot;--zygote&quot;,表示当前进程是zygote进程，zygote=true，并设置nicename为zygote64（64位）或zygote。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--zygote&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--start-system-server&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//根据参数&quot;--start-system-server&quot;，需要启动System Server。</span></span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--application&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--nice-name=&quot;</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--&quot;</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	Vector&lt;String8&gt; args;</span><br><span class="line">    <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;re not in zygote mode, the only argument we need to pass</span></span><br><span class="line">        <span class="comment">// to RuntimeInit is the application argument.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// The Remainder of args get passed to startup class main(). Make</span></span><br><span class="line">        <span class="comment">// copies of them before we overwrite them with the process name.</span></span><br><span class="line">        args.add(application ? String8(<span class="string">&quot;application&quot;</span>) : String8(<span class="string">&quot;tool&quot;</span>));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!LOG_NDEBUG) &#123;</span><br><span class="line">          String8 restOfArgs;</span><br><span class="line">          <span class="keyword">char</span>* <span class="keyword">const</span>* argv_new = argv + i;</span><br><span class="line">          <span class="keyword">int</span> argc_new = argc - i;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; argc_new; ++k) &#123;</span><br><span class="line">            restOfArgs.append(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">            restOfArgs.append(argv_new[k]);</span><br><span class="line">            restOfArgs.append(<span class="string">&quot;\&quot; &quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          ALOGV(<span class="string">&quot;Class name = %s, args = %s&quot;</span>, className.<span class="built_in">string</span>(), restOfArgs.<span class="built_in">string</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We&#x27;re in zygote mode.</span></span><br><span class="line">        maybeCreateDalvikCache();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            args.add(String8(<span class="string">&quot;start-system-server&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> prop[PROP_VALUE_MAX];</span><br><span class="line">        <span class="keyword">if</span> (property_get(ABI_LIST_PROPERTY, prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">&quot;app_process: Unable to determine ABI list from property %s.&quot;</span>,</span><br><span class="line">                ABI_LIST_PROPERTY);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">&quot;--abi-list=&quot;</span>)</span></span>;</span><br><span class="line">        abiFlag.append(prop);</span><br><span class="line">        args.add(abiFlag);</span><br><span class="line">	<span class="comment">// In zygote mode, pass all remaining arguments to the zygote</span></span><br><span class="line">        <span class="comment">// main() method.</span></span><br><span class="line">        <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</span><br><span class="line">            args.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!niceName.isEmpty()) &#123;</span><br><span class="line">        runtime.setArgv0(niceName.<span class="built_in">string</span>(), <span class="literal">true</span> <span class="comment">/* setProcName */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//负责初始化zygote 模式的叫ZytoteInit 类，负责初始化其他进程的叫RuntimeInit 类。</span></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;<span class="comment">// 调用AppRuntime启动ZygoteInit</span></span><br><span class="line">        runtime.start(<span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.start(<span class="string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">                    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总结以上代码的逻辑，可以知道，main函数主要做了以下几件事：</p>
<p><strong>1）创建了AppRuntime runtime对象。</strong></p>
<p><strong>2）对传入的五个参数进行解析：</strong></p>
<p>​             argv[0]=”/system/bin/app_process”<br>​                     argv[1]=”-Xzygote”                                        —–&gt;  传入虚拟机中<br>​                     argv[2]=”/system/bin”<br>​                     argv[3]=”–zygote”                                         —–&gt; 表示启动虚拟机，将zygote变量置为true<br>​                     argv[4]=”–start-system-server”                  —–&gt; 表示启动SystemServer，将startSystemServer变量置为true</p>
<p><strong>3）调用AppRuntime的start方法，并传递”com.android.internal.os.ZygoteInit”与zygote=true，来创建虚拟机。</strong></p>
<h2 id="1-3-创建虚拟机"><a href="#1-3-创建虚拟机" class="headerlink" title="1.3 创建虚拟机"></a>1.3 创建虚拟机</h2><h3 id="1-3-1-AppRuntime"><a href="#1-3-1-AppRuntime" class="headerlink" title="1.3.1 AppRuntime"></a>1.3.1 AppRuntime</h3><p>下面通过AndroidRuntime来看虚拟机是如何被创建的。AppRuntime是app_main的内部类。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    AppRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength)</span><br><span class="line">        : AndroidRuntime(argBlockStart, argBlockLength)</span><br><span class="line">        , mClass(<span class="literal">NULL</span>)</span><br><span class="line">    &#123; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setClassNameAndArgs</span><span class="params">(<span class="keyword">const</span> String8&amp; className, <span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> *argv)</span> </span>&#123;</span><br><span class="line">        mClassName = className;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argc; ++i) &#123;</span><br><span class="line">             mArgs.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onVmCreated</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClassName.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// Zygote. Nothing to do here.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This is a little awkward because the JNI FindClass call uses the</span></span><br><span class="line"><span class="comment">         * class loader associated with the native method we&#x27;re executing in.</span></span><br><span class="line"><span class="comment">         * If called in onStarted (from RuntimeInit.finishInit because we&#x27;re</span></span><br><span class="line"><span class="comment">         * launching &quot;am&quot;, for example), FindClass would see that we&#x27;re calling</span></span><br><span class="line"><span class="comment">         * from a boot class&#x27; native method, and so wouldn&#x27;t look for the class</span></span><br><span class="line"><span class="comment">         * we&#x27;re trying to look up in CLASSPATH. Unfortunately it needs to,</span></span><br><span class="line"><span class="comment">         * because the &quot;am&quot; classes are not boot classes.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The easiest fix is to call FindClass here, early on before we start</span></span><br><span class="line"><span class="comment">         * executing boot class Java code and thereby deny ourselves access to</span></span><br><span class="line"><span class="comment">         * non-boot classes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">char</span>* slashClassName = toSlashClassName(mClassName.<span class="built_in">string</span>());</span><br><span class="line">        mClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">        <span class="keyword">if</span> (mClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;ERROR: could not find class &#x27;%s&#x27;\n&quot;</span>, mClassName.<span class="built_in">string</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">        mClass = <span class="keyword">reinterpret_cast</span>&lt;jclass&gt;(env-&gt;NewGlobalRef(mClass));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">&quot;App process: starting thread pool.\n&quot;</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">        AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">        ar-&gt;callMain(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">        IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">&quot;App process: starting thread pool.\n&quot;</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onExit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClassName.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// if zygote</span></span><br><span class="line">            IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">            hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AndroidRuntime::onExit(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String8 mClassName;</span><br><span class="line">    Vector&lt;String8&gt; mArgs;</span><br><span class="line">    jclass mClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>由于AppRuntime继承自AndroidRuntime，当调用AppRuntime的start函数时，其实是调用的父类AndroidRuntime的start函数。</p>
<h3 id="1-3-2-AndroidRuntime的start函数"><a href="#1-3-2-AndroidRuntime的start函数" class="headerlink" title="1.3.2 AndroidRuntime的start函数"></a>1.3.2 AndroidRuntime的start函数</h3><p>下面看AndroidRuntime的start函数，当时调用为runtime.start(“com.android.internal.os.ZygoteInit”, args, zygote);</p>
<p>由于从app_main的main函数中传递的参数为：”com.android.internal.os.ZygoteInit”, args, zygote=true</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start the Android runtime.  This involves starting the virtual machine</span></span><br><span class="line"><span class="comment"> * and calling the &quot;static void main(String[] args)&quot; method in the class</span></span><br><span class="line"><span class="comment"> * named by &quot;className&quot;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Passes the main function two arguments, the class name and the specified</span></span><br><span class="line"><span class="comment"> * options string.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AndroidRuntime::start</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGD(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n&quot;</span>,</span><br><span class="line">            className != <span class="literal">NULL</span> ? className : <span class="string">&quot;(unknown)&quot;</span>, getuid());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">&quot;start-system-server&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * &#x27;startSystemServer == true&#x27; means runtime is obsolete and not run from</span></span><br><span class="line"><span class="comment">     * init.rc anymore, so we print out the boot start event here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">           <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">           <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">           LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">&quot;ANDROID_ROOT&quot;</span>);<span class="comment">//获取Android的根目录</span></span><br><span class="line">    <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rootDir = <span class="string">&quot;/system&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hasDir(<span class="string">&quot;/system&quot;</span>)) &#123;</span><br><span class="line">            LOG_FATAL(<span class="string">&quot;No root directory specified, and /android does not exist.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setenv(<span class="string">&quot;ANDROID_ROOT&quot;</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//const char* kernelHack = getenv(&quot;LD_ASSUME_KERNEL&quot;);</span></span><br><span class="line">    <span class="comment">//ALOGD(&quot;Found LD_ASSUME_KERNEL=&#x27;%s&#x27;\n&quot;, kernelHack);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* start the virtual machine */</span></span><br><span class="line">    <span class="comment">//开始启动虚拟机，但是在创建虚拟机之前，需要先初始化JniInvocation</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="comment">//初始化JniInvocation后，开始创建虚拟机。</span></span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onVmCreated(env);<span class="comment">//并调用onVmCreated方法，表示虚拟机创建完成，这个方法会调到子类的onVmCreated方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Register android functions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Unable to register all android natives\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We want to call main() with a String array with arguments in it.</span></span><br><span class="line"><span class="comment">     * At present we have two arguments, the class name and an option string.</span></span><br><span class="line"><span class="comment">     * Create an array to hold them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    assert(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    assert(strArray != <span class="literal">NULL</span>);</span><br><span class="line">    classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">    assert(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</span><br><span class="line">        assert(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment">     * not return until the VM exits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 将 &quot;com.android.internal.os.ZygoteInit&quot;转换为&quot;com/android/internal/os/ZygoteInit&quot;</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className != <span class="literal">NULL</span> ? className : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">                threadExitUncaughtException(env);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">&quot;Shutting down VM\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">        ALOGW(<span class="string">&quot;Warning: unable to detach main thread\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">        ALOGW(<span class="string">&quot;Warning: VM did not shut down cleanly\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AndroidRuntime的start方法主要做了以下几件事：</p>
<p><strong>1）初始化JniInvocation，jni_invocation.Init(NULL);</strong></p>
<p><strong>2）创建虚拟机，startVm(&amp;mJavaVM, &amp;env, zygote)</strong></p>
<p><strong>3）调用onVmCreated方法，表示虚拟机创建完成，这个方法会调到子类的onVmCreated方法</strong></p>
<p><strong>4）Android虚拟机注册Android native处理函数</strong></p>
<p><strong>5）通过反射启动虚拟机，env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</strong></p>
<h4 id="1-3-2-1-JniInvocation-init初始化"><a href="#1-3-2-1-JniInvocation-init初始化" class="headerlink" title="1.3.2.1 JniInvocation.init初始化"></a>1.3.2.1 JniInvocation.init初始化</h4><p>JniInvocation，是一个外部和虚拟机之间的一个中间层，是外部访问虚拟机的API接口，允许外部动态的调用虚拟机内部的实现。</p>
<p>其主要实现如下功能：</p>
<ul>
<li>指定加载的虚拟机。现在Android系统中有两种虚拟机：dalvik和art。现在已基本使用art虚拟机了。</li>
<li>封装虚拟机的对象接口</li>
</ul>
<p><img src="/images/binder02/image-20201016105922219.png" alt="image-20201016105922219"></p>
<p>JniInvocation API可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/jackie_xiaonan/article/details/24922299?utm_source=blogxgwz0">https://blog.csdn.net/jackie_xiaonan/article/details/24922299?utm_source=blogxgwz0</a></p>
<p><strong>init函数功能</strong></p>
<p>获取到library库的名称（libart.so）后,通过dlopen把他打开并加载到内存，C语言为处理动态链接库提供了一些函数，如dlopen,dlsym,dladdr等，对应的实现在bionic/linker中，dlopen是以指定的模式打开动态链接库，RTLD_NOW表示在dlopen时直接解析所有未定义的符号，RTLD_NODELETE表示dlclose时不卸载动态库，那么后续如果该动态库重新被加载的话，其中的静态变量就不需要重新初始化了。</p>
<p>然后查找３个关键的接口实现，JNI_GetDefaultJavaVMInitArgs,JNI_CreateJavaVM,JNI_GetCreatedJavaVMs，分别保存在相应的变量中（JNI_GetDefaultJavaVMInitArgs_,JNI_CreateJavaVM_,JNI_GetCreatedJavaVMs_），这三个函数可以认为是Android虚拟机必须实现的通用接口，不管是art还是dalvik都要实现这３个接口，这样就能保证Android系统正确的使用他们。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">JniInvocation::Init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* library)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID__</span></span><br><span class="line">  <span class="keyword">char</span> buffer[PROP_VALUE_MAX];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">char</span>* buffer = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  library = GetLibrary(library, buffer);</span><br><span class="line">  <span class="comment">// Load with RTLD_NODELETE in order to ensure that libart.so is not unmapped when it is closed.</span></span><br><span class="line">  <span class="comment">// This is due to the fact that it is possible that some threads might have yet to finish</span></span><br><span class="line">  <span class="comment">// exiting even after JNI_DeleteJavaVM returns, which can lead to segfaults if the library is</span></span><br><span class="line">  <span class="comment">// unloaded.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> kDlopenFlags = RTLD_NOW | RTLD_NODELETE;</span><br><span class="line">  handle_ = dlopen(library, kDlopenFlags);</span><br><span class="line">  <span class="keyword">if</span> (handle_ == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(library, kLibraryFallback) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Nothing else to try.</span></span><br><span class="line">      ALOGE(<span class="string">&quot;Failed to dlopen %s: %s&quot;</span>, library, dlerror());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Note that this is enough to get something like the zygote</span></span><br><span class="line">    <span class="comment">// running, we can&#x27;t property_set here to fix this for the future</span></span><br><span class="line">    <span class="comment">// because we are root and not the system user. See</span></span><br><span class="line">    <span class="comment">// RuntimeInit.commonInit for where we fix up the property to</span></span><br><span class="line">    <span class="comment">// avoid future fallbacks. http://b/11463182</span></span><br><span class="line">    ALOGW(<span class="string">&quot;Falling back from %s to %s after dlopen error: %s&quot;</span>,</span><br><span class="line">          library, kLibraryFallback, dlerror());</span><br><span class="line">    library = kLibraryFallback;</span><br><span class="line">    handle_ = dlopen(library, kDlopenFlags);</span><br><span class="line">    <span class="keyword">if</span> (handle_ == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      ALOGE(<span class="string">&quot;Failed to dlopen %s: %s&quot;</span>, library, dlerror());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!FindSymbol(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;JNI_GetDefaultJavaVMInitArgs_),</span><br><span class="line">                  <span class="string">&quot;JNI_GetDefaultJavaVMInitArgs&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!FindSymbol(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;JNI_CreateJavaVM_),</span><br><span class="line">                  <span class="string">&quot;JNI_CreateJavaVM&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!FindSymbol(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;JNI_GetCreatedJavaVMs_),</span><br><span class="line">                  <span class="string">&quot;JNI_GetCreatedJavaVMs&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结来说JniInvocation的Init()函数主要做了以下几件事：</strong></p>
<p><strong>1）加载虚拟机库文件。虚拟机库文件有两种获取方式：</strong></p>
<p>​    ①用户指定</p>
<p>​    ②系统默认</p>
<p><strong>2）接口的初始化</strong></p>
<p>​    ①初始化JNI_GetDefaultJavaVMInitArgs_，调用JNI_GetDefaultJavaVMInitArgs_实际上就是调用虚拟机库函数JNI_GetDefaultJavaVMInitArgs</p>
<p>​    ②初始化JNI_CreateJavaVM_，调用JNI_CreateJavaVM_实际上就是调用虚拟机库函数JNI_CreateJavaVM。</p>
<p>​    ③初始化JNI_GetCreatedJavaVMs_，调用JNI_GetCreatedJavaVMs_实际上就是调用虚拟机库函数JNI_GetCreatedJavaVMs。</p>
<h4 id="1-3-2-2-startVm处理"><a href="#1-3-2-2-startVm处理" class="headerlink" title="1.3.2.2 startVm处理"></a>1.3.2.2 startVm处理</h4><p>在JniInvocation初始化之后，虚拟机库文件被加载且接口函数也已被初始化。从JniInvocation的初始化中，我们知道，Android N以后的默认虚拟机已是ART虚拟机。startVm()函数就是用来创建ART虚拟机的。整个的处理过程就是配置虚拟机的属性然后调用虚拟机库函数JNI_CreateJavaVM()来创建。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start the Dalvik Virtual Machine.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Various arguments, most determined by system properties, are passed in.</span></span><br><span class="line"><span class="comment"> * The &quot;mOptions&quot; vector is updated.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * CAUTION: when adding options in here, be careful not to put the</span></span><br><span class="line"><span class="comment"> * char buffer inside a nested scope.  Adding the buffer to the</span></span><br><span class="line"><span class="comment"> * options using mOptions.add() does not copy the buffer, so if the</span></span><br><span class="line"><span class="comment"> * buffer goes out of scope the option may be overwritten.  It&#x27;s best</span></span><br><span class="line"><span class="comment"> * to put the buffer at the top of the function so that it is more</span></span><br><span class="line"><span class="comment"> * unlikely that someone will surround it in a scope at a later time</span></span><br><span class="line"><span class="comment"> * and thus introduce a bug.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns 0 on success.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">AndroidRuntime::startVm</span><span class="params">(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="keyword">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    JavaVMInitArgs initArgs;</span><br><span class="line">    <span class="keyword">char</span> propBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> stackTraceFileBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xstacktracefile:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> jniOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjniopts:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="comment">//虚拟机堆的起始大小，启动时申请的堆内存大小 prop:dalvik.vm.heapstartsize指定</span></span><br><span class="line">    <span class="keyword">char</span> heapstartsizeOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xms&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="comment">//虚拟机堆使用的虚拟内存最大大小 prop: dalvik.vm.heapsize 指定</span></span><br><span class="line">    <span class="keyword">char</span> heapsizeOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xmx&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="comment">//非largeHeap应用最大使用的堆内存 prop: dalvik.vm.heapgrowthlimit</span></span><br><span class="line">    <span class="keyword">char</span> heapgrowthlimitOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-XX:HeapGrowthLimit=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="comment">//堆最小空闲值，空闲值小于该值时应该扩容堆（调整软限制） prop:dalvik.vm.heapminfree 指定</span></span><br><span class="line">    <span class="keyword">char</span> heapminfreeOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-XX:HeapMinFree=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="comment">//堆最大空闲值，大于该值时应该堆缩容（调整软限制） prop: dalvik.vm.heapmaxfree</span></span><br><span class="line">    <span class="keyword">char</span> heapmaxfreeOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-XX:HeapMaxFree=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> usejitOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xusejit:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> jitmaxsizeOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjitmaxsize:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> jitinitialsizeOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjitinitialsize:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> jitthresholdOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjitthreshold:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> useJitProfilesOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjitsaveprofilinginfo:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> jitprithreadweightOptBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjitprithreadweight:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> jittransitionweightOptBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjittransitionweight:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> hotstartupsamplesOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xps-hot-startup-method-samples:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> madviseRandomOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-XX:MadviseRandomAccess:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> gctypeOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xgc:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> backgroundgcOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-XX:BackgroundGC=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> heaptargetutilizationOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-XX:HeapTargetUtilization=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> foregroundHeapGrowthMultiplierOptsBuf[</span><br><span class="line">            <span class="keyword">sizeof</span>(<span class="string">&quot;-XX:ForegroundHeapGrowthMultiplier=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> cachePruneBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xzygote-max-boot-retry=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatXmsImageFlagsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xms&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatXmxImageFlagsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xmx&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatXmsFlagsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xms&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatXmxFlagsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xmx&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatCompilerFilterBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;--compiler-filter=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatImageCompilerFilterBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;--compiler-filter=&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatThreadsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-j&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatThreadsImageBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-j&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oat_isa_variant_key[PROPERTY_KEY_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oat_isa_variant[<span class="keyword">sizeof</span>(<span class="string">&quot;--instruction-set-variant=&quot;</span>) <span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oat_isa_features_key[PROPERTY_KEY_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oat_isa_features[<span class="keyword">sizeof</span>(<span class="string">&quot;--instruction-set-features=&quot;</span>) <span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatFlagsBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> dex2oatImageFlagsBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> extraOptsBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> voldDecryptBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">      kEMDefault,</span><br><span class="line">      kEMIntPortable,</span><br><span class="line">      kEMIntFast,</span><br><span class="line">      kEMJitCompiler,</span><br><span class="line">    &#125; executionMode = kEMDefault;</span><br><span class="line">    <span class="keyword">char</span> localeOption[<span class="keyword">sizeof</span>(<span class="string">&quot;-Duser.locale=&quot;</span>) + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> lockProfThresholdBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xlockprofthreshold:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> nativeBridgeLibrary[<span class="keyword">sizeof</span>(<span class="string">&quot;-XX:NativeBridge=&quot;</span>) + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> cpuAbiListBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;--cpu-abilist=&quot;</span>) + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> methodTraceFileBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xmethod-trace-file:&quot;</span>) + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">char</span> methodTraceFileSizeBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xmethod-trace-file-size:&quot;</span>) + PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> fingerprintBuf;</span><br><span class="line">    <span class="keyword">char</span> jdwpProviderBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-XjdwpProvider:&quot;</span>) - <span class="number">1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JNI检测功能，用于native层调用jni函数时进行常规检测，比较弱字符串格式是否符合要求，资源是否正确释放。</span></span><br><span class="line">    <span class="comment">// 该功能一般用于早期系统调试或手机Eng版，对于User版往往不会开启，引用该功能比较消耗系统CPU资源，降低系统性能。</span></span><br><span class="line">    <span class="keyword">bool</span> checkJni = <span class="literal">false</span>;</span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.checkjni&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        checkJni = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;false&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* property is neither true nor false; fall back on kernel parameter */</span></span><br><span class="line">        property_get(<span class="string">&quot;ro.kernel.android.checkjni&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (propBuf[<span class="number">0</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">            checkJni = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGV(<span class="string">&quot;CheckJNI is %s\n&quot;</span>, checkJni ? <span class="string">&quot;ON&quot;</span> : <span class="string">&quot;OFF&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (checkJni) &#123;</span><br><span class="line">        <span class="comment">/* extended JNI checking */</span></span><br><span class="line">        addOption(<span class="string">&quot;-Xcheck:jni&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* with -Xcheck:jni, this provides a JNI function call trace */</span></span><br><span class="line">        <span class="comment">//addOption(&quot;-verbose:jni&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//执行模式的配置。执行模式是在属性”dalvik.vm.execution-mode”里配置的</span></span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.execution-mode&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;int:portable&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        executionMode = kEMIntPortable;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;int:fast&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        executionMode = kEMIntFast;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;int:jit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        executionMode = kEMJitCompiler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If dalvik.vm.stack-trace-dir is set, it enables the &quot;new&quot; stack trace</span></span><br><span class="line">    <span class="comment">// dump scheme and a new file is created for each stack dump. If it isn&#x27;t set,</span></span><br><span class="line">    <span class="comment">// the old scheme is enabled.</span></span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.stack-trace-dir&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(propBuf) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xusetombstonedtraces&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parseRuntimeOption(<span class="string">&quot;dalvik.vm.stack-trace-file&quot;</span>, stackTraceFileBuf, <span class="string">&quot;-Xstacktracefile:&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(jniOptsBuf, <span class="string">&quot;-Xjniopts:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (parseRuntimeOption(<span class="string">&quot;dalvik.vm.jniopts&quot;</span>, jniOptsBuf, <span class="string">&quot;-Xjniopts:&quot;</span>)) &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;JNI options: &#x27;%s&#x27;\n&quot;</span>, jniOptsBuf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* route exit() to our handler */</span></span><br><span class="line">    addOption(<span class="string">&quot;exit&quot;</span>, (<span class="keyword">void</span>*) runtime_exit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* route fprintf() to our handler */</span></span><br><span class="line">    addOption(<span class="string">&quot;vfprintf&quot;</span>, (<span class="keyword">void</span>*) runtime_vfprintf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* register the framework-specific &quot;is sensitive thread&quot; hook */</span></span><br><span class="line">    addOption(<span class="string">&quot;sensitiveThread&quot;</span>, (<span class="keyword">void</span>*) runtime_isSensitiveThread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* enable verbose; standard options are &#123; jni, gc, class &#125; */</span></span><br><span class="line">    <span class="comment">//addOption(&quot;-verbose:jni&quot;);</span></span><br><span class="line">    addOption(<span class="string">&quot;-verbose:gc&quot;</span>);</span><br><span class="line">    <span class="comment">//addOption(&quot;-verbose:class&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 对于不同的软硬件环境，这些参数往往需要调整、优化，从而使系统达到最佳性能</span></span><br><span class="line"><span class="comment">     * The default starting and maximum size of the heap.  Larger</span></span><br><span class="line"><span class="comment">     * values should be specified in a product property override.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//虚拟机的heapstartsize和heapsize分别被设置为4M和16M。这表明在Java的进程空间中，内存堆栈只有16M的空间</span></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.heapstartsize&quot;</span>, heapstartsizeOptsBuf, <span class="string">&quot;-Xms&quot;</span>, <span class="string">&quot;4m&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.heapsize&quot;</span>, heapsizeOptsBuf, <span class="string">&quot;-Xmx&quot;</span>, <span class="string">&quot;16m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.heapgrowthlimit&quot;</span>, heapgrowthlimitOptsBuf, <span class="string">&quot;-XX:HeapGrowthLimit=&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.heapminfree&quot;</span>, heapminfreeOptsBuf, <span class="string">&quot;-XX:HeapMinFree=&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.heapmaxfree&quot;</span>, heapmaxfreeOptsBuf, <span class="string">&quot;-XX:HeapMaxFree=&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.heaptargetutilization&quot;</span>,</span><br><span class="line">                       heaptargetutilizationOptsBuf,</span><br><span class="line">                       <span class="string">&quot;-XX:HeapTargetUtilization=&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Foreground heap growth multiplier option */</span></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.foreground-heap-growth-multiplier&quot;</span>,</span><br><span class="line">                       foregroundHeapGrowthMultiplierOptsBuf,</span><br><span class="line">                       <span class="string">&quot;-XX:ForegroundHeapGrowthMultiplier=&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * JIT related options.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.usejit&quot;</span>, usejitOptsBuf, <span class="string">&quot;-Xusejit:&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.jitmaxsize&quot;</span>, jitmaxsizeOptsBuf, <span class="string">&quot;-Xjitmaxsize:&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.jitinitialsize&quot;</span>, jitinitialsizeOptsBuf, <span class="string">&quot;-Xjitinitialsize:&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.jitthreshold&quot;</span>, jitthresholdOptsBuf, <span class="string">&quot;-Xjitthreshold:&quot;</span>);</span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.usejitprofiles&quot;</span>, useJitProfilesOptsBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(useJitProfilesOptsBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xjitsaveprofilinginfo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.jitprithreadweight&quot;</span>,</span><br><span class="line">                       jitprithreadweightOptBuf,</span><br><span class="line">                       <span class="string">&quot;-Xjitprithreadweight:&quot;</span>);</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.jittransitionweight&quot;</span>,</span><br><span class="line">                       jittransitionweightOptBuf,</span><br><span class="line">                       <span class="string">&quot;-Xjittransitionweight:&quot;</span>);</span><br><span class="line"></span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.profilebootimage&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xps-profile-boot-class-path&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;-Xps-profile-aot-code&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Madvise related options.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.madvise-random&quot;</span>, madviseRandomOptsBuf, <span class="string">&quot;-XX:MadviseRandomAccess:&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Profile related options.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.hot-startup-method-samples&quot;</span>, hotstartupsamplesOptsBuf,</span><br><span class="line">            <span class="string">&quot;-Xps-hot-startup-method-samples:&quot;</span>);</span><br><span class="line"></span><br><span class="line">    property_get(<span class="string">&quot;ro.config.low_ram&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      addOption(<span class="string">&quot;-XX:LowMemoryMode&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.gctype&quot;</span>, gctypeOptsBuf, <span class="string">&quot;-Xgc:&quot;</span>);</span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.backgroundgctype&quot;</span>, backgroundgcOptsBuf, <span class="string">&quot;-XX:BackgroundGC=&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Enable debugging only for apps forked from zygote.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">      <span class="comment">// Set the JDWP provider and required arguments. By default let the runtime choose how JDWP is</span></span><br><span class="line">      <span class="comment">// implemented. When this is not set the runtime defaults to not allowing JDWP.</span></span><br><span class="line">      addOption(<span class="string">&quot;-XjdwpOptions:suspend=n,server=y&quot;</span>);</span><br><span class="line">      parseRuntimeOption(<span class="string">&quot;dalvik.vm.jdwp-provider&quot;</span>,</span><br><span class="line">                         jdwpProviderBuf,</span><br><span class="line">                         <span class="string">&quot;-XjdwpProvider:&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;default&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.lockprof.threshold&quot;</span>,</span><br><span class="line">                       lockProfThresholdBuf,</span><br><span class="line">                       <span class="string">&quot;-Xlockprofthreshold:&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (executionMode == kEMIntPortable) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xint:portable&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (executionMode == kEMIntFast) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xint:fast&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (executionMode == kEMJitCompiler) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xint:jit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we are booting without the real /data, don&#x27;t spend time compiling.</span></span><br><span class="line">    property_get(<span class="string">&quot;vold.decrypt&quot;</span>, voldDecryptBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">bool</span> skip_compilation = ((<span class="built_in">strcmp</span>(voldDecryptBuf, <span class="string">&quot;trigger_restart_min_framework&quot;</span>) == <span class="number">0</span>) ||</span><br><span class="line">                             (<span class="built_in">strcmp</span>(voldDecryptBuf, <span class="string">&quot;1&quot;</span>) == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extra options for boot.art/boot.oat image generation.</span></span><br><span class="line">    parseCompilerRuntimeOption(<span class="string">&quot;dalvik.vm.image-dex2oat-Xms&quot;</span>, dex2oatXmsImageFlagsBuf,</span><br><span class="line">                               <span class="string">&quot;-Xms&quot;</span>, <span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">    parseCompilerRuntimeOption(<span class="string">&quot;dalvik.vm.image-dex2oat-Xmx&quot;</span>, dex2oatXmxImageFlagsBuf,</span><br><span class="line">                               <span class="string">&quot;-Xmx&quot;</span>, <span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (skip_compilation) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--compiler-filter=assume-verified&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parseCompilerOption(<span class="string">&quot;dalvik.vm.image-dex2oat-filter&quot;</span>, dex2oatImageCompilerFilterBuf,</span><br><span class="line">                            <span class="string">&quot;--compiler-filter=&quot;</span>, <span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there is a boot profile, it takes precedence over the image and preloaded classes.</span></span><br><span class="line">    <span class="comment">// preloaded-classes文件内容是由WritePreloadedClassFile.java生成的，</span></span><br><span class="line">    <span class="comment">// 在ZygoteInit类中会预加载工作将其中的classes提前加载到内存，以提高系统性能</span></span><br><span class="line">    <span class="keyword">if</span> (hasFile(<span class="string">&quot;/system/etc/boot-image.prof&quot;</span>)) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--profile-file=/system/etc/boot-image.prof&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--compiler-filter=speed-profile&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Make sure there is a preloaded-classes file.</span></span><br><span class="line">        <span class="keyword">if</span> (!hasFile(<span class="string">&quot;/system/etc/preloaded-classes&quot;</span>)) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;Missing preloaded-classes file, /system/etc/preloaded-classes not found: %s\n&quot;</span>,</span><br><span class="line">                  strerror(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        addOption(<span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--image-classes=/system/etc/preloaded-classes&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there is a compiled-classes file, push it.</span></span><br><span class="line">        <span class="keyword">if</span> (hasFile(<span class="string">&quot;/system/etc/compiled-classes&quot;</span>)) &#123;</span><br><span class="line">            addOption(<span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">            addOption(<span class="string">&quot;--compiled-classes=/system/etc/compiled-classes&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there is a dirty-image-objects file, push it.</span></span><br><span class="line">        <span class="keyword">if</span> (hasFile(<span class="string">&quot;/system/etc/dirty-image-objects&quot;</span>)) &#123;</span><br><span class="line">            addOption(<span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">            addOption(<span class="string">&quot;--dirty-image-objects=/system/etc/dirty-image-objects&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.image-dex2oat-flags&quot;</span>, dex2oatImageFlagsBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    parseExtraOpts(dex2oatImageFlagsBuf, <span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extra options for DexClassLoader.</span></span><br><span class="line">    parseCompilerRuntimeOption(<span class="string">&quot;dalvik.vm.dex2oat-Xms&quot;</span>, dex2oatXmsFlagsBuf,</span><br><span class="line">                               <span class="string">&quot;-Xms&quot;</span>, <span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">    parseCompilerRuntimeOption(<span class="string">&quot;dalvik.vm.dex2oat-Xmx&quot;</span>, dex2oatXmxFlagsBuf,</span><br><span class="line">                               <span class="string">&quot;-Xmx&quot;</span>, <span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (skip_compilation) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--compiler-filter=assume-verified&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We skip compilation when a minimal runtime is brought up for decryption. In that case</span></span><br><span class="line">        <span class="comment">// /data is temporarily backed by a tmpfs, which is usually small.</span></span><br><span class="line">        <span class="comment">// If the system image contains prebuilts, they will be relocated into the tmpfs. In this</span></span><br><span class="line">        <span class="comment">// specific situation it is acceptable to *not* relocate and run out of the prebuilts</span></span><br><span class="line">        <span class="comment">// directly instead.</span></span><br><span class="line">        addOption(<span class="string">&quot;--runtime-arg&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;-Xnorelocate&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parseCompilerOption(<span class="string">&quot;dalvik.vm.dex2oat-filter&quot;</span>, dex2oatCompilerFilterBuf,</span><br><span class="line">                            <span class="string">&quot;--compiler-filter=&quot;</span>, <span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    parseCompilerOption(<span class="string">&quot;dalvik.vm.dex2oat-threads&quot;</span>, dex2oatThreadsBuf, <span class="string">&quot;-j&quot;</span>, <span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">    parseCompilerOption(<span class="string">&quot;dalvik.vm.image-dex2oat-threads&quot;</span>, dex2oatThreadsImageBuf, <span class="string">&quot;-j&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The runtime will compile a boot image, when necessary, not using installd. Thus, we need to</span></span><br><span class="line">    <span class="comment">// pass the instruction-set-features/variant as an image-compiler-option.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Find a better way for the instruction-set.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__arm__)</span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keyword">char</span>* instruction_set = <span class="string">&quot;arm&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__aarch64__)</span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keyword">char</span>* instruction_set = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__mips__) &amp;&amp; !defined(__LP64__)</span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keyword">char</span>* instruction_set = <span class="string">&quot;mips&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__mips__) &amp;&amp; defined(__LP64__)</span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keyword">char</span>* instruction_set = <span class="string">&quot;mips64&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__i386__)</span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keyword">char</span>* instruction_set = <span class="string">&quot;x86&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__x86_64__)</span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keyword">char</span>* instruction_set = <span class="string">&quot;x86_64&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keyword">char</span>* instruction_set = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// Note: it is OK to reuse the buffer, as the values are exactly the same between</span></span><br><span class="line">    <span class="comment">//       * compiler-option, used for runtime compilation (DexClassLoader)</span></span><br><span class="line">    <span class="comment">//       * image-compiler-option, used for boot-image compilation on device</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy the variant.</span></span><br><span class="line">    <span class="built_in">sprintf</span>(dex2oat_isa_variant_key, <span class="string">&quot;dalvik.vm.isa.%s.variant&quot;</span>, instruction_set);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_variant_key, dex2oat_isa_variant,</span><br><span class="line">                        <span class="string">&quot;--instruction-set-variant=&quot;</span>, <span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_variant_key, dex2oat_isa_variant,</span><br><span class="line">                        <span class="string">&quot;--instruction-set-variant=&quot;</span>, <span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">    <span class="comment">// Copy the features.</span></span><br><span class="line">    <span class="built_in">sprintf</span>(dex2oat_isa_features_key, <span class="string">&quot;dalvik.vm.isa.%s.features&quot;</span>, instruction_set);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_features_key, dex2oat_isa_features,</span><br><span class="line">                        <span class="string">&quot;--instruction-set-features=&quot;</span>, <span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_features_key, dex2oat_isa_features,</span><br><span class="line">                        <span class="string">&quot;--instruction-set-features=&quot;</span>, <span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.dex2oat-flags&quot;</span>, dex2oatFlagsBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    parseExtraOpts(dex2oatFlagsBuf, <span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* extra options; parse this late so it overrides others */</span></span><br><span class="line">    property_get(<span class="string">&quot;dalvik.vm.extra-opts&quot;</span>, extraOptsBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    parseExtraOpts(extraOptsBuf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the properties for locale */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(localeOption, <span class="string">&quot;-Duser.locale=&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> locale = readLocale();</span><br><span class="line">        <span class="built_in">strncat</span>(localeOption, locale.c_str(), PROPERTY_VALUE_MAX);</span><br><span class="line">        addOption(localeOption);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trace files are stored in /data/misc/trace which is writable only in debug mode.</span></span><br><span class="line">    property_get(<span class="string">&quot;ro.debuggable&quot;</span>, propBuf, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;1&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        property_get(<span class="string">&quot;dalvik.vm.method-trace&quot;</span>, propBuf, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            addOption(<span class="string">&quot;-Xmethod-trace&quot;</span>);</span><br><span class="line">            parseRuntimeOption(<span class="string">&quot;dalvik.vm.method-trace-file&quot;</span>,</span><br><span class="line">                               methodTraceFileBuf,</span><br><span class="line">                               <span class="string">&quot;-Xmethod-trace-file:&quot;</span>);</span><br><span class="line">            parseRuntimeOption(<span class="string">&quot;dalvik.vm.method-trace-file-siz&quot;</span>,</span><br><span class="line">                               methodTraceFileSizeBuf,</span><br><span class="line">                               <span class="string">&quot;-Xmethod-trace-file-size:&quot;</span>);</span><br><span class="line">            property_get(<span class="string">&quot;dalvik.vm.method-trace-stream&quot;</span>, propBuf, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                addOption(<span class="string">&quot;-Xmethod-trace-stream&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Native bridge library. &quot;0&quot; means that native bridge is disabled.</span></span><br><span class="line">    property_get(<span class="string">&quot;ro.dalvik.vm.native.bridge&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (propBuf[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;ro.dalvik.vm.native.bridge is not expected to be empty&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;0&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(nativeBridgeLibrary, <span class="keyword">sizeof</span>(<span class="string">&quot;-XX:NativeBridge=&quot;</span>) + PROPERTY_VALUE_MAX,</span><br><span class="line">                 <span class="string">&quot;-XX:NativeBridge=%s&quot;</span>, propBuf);</span><br><span class="line">        addOption(nativeBridgeLibrary);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* cpu_abilist_property_name = <span class="string">&quot;ro.product.cpu.abilist64&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* cpu_abilist_property_name = <span class="string">&quot;ro.product.cpu.abilist32&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// defined(__LP64__)</span></span></span><br><span class="line">    property_get(cpu_abilist_property_name, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (propBuf[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;%s is not expected to be empty&quot;</span>, cpu_abilist_property_name);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span>(cpuAbiListBuf, <span class="keyword">sizeof</span>(cpuAbiListBuf), <span class="string">&quot;--cpu-abilist=%s&quot;</span>, propBuf);</span><br><span class="line">    addOption(cpuAbiListBuf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dalvik-cache pruning counter.</span></span><br><span class="line">    parseRuntimeOption(<span class="string">&quot;dalvik.vm.zygote.max-boot-retry&quot;</span>, cachePruneBuf,</span><br><span class="line">                       <span class="string">&quot;-Xzygote-max-boot-retry=&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * When running with debug.generate-debug-info, add --generate-debug-info to</span></span><br><span class="line"><span class="comment">     * the compiler options so that the boot image, if it is compiled on device,</span></span><br><span class="line"><span class="comment">     * will include native debugging information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    property_get(<span class="string">&quot;debug.generate-debug-info&quot;</span>, propBuf, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--generate-debug-info&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;-Ximage-compiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--generate-debug-info&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The mini-debug-info makes it possible to backtrace through JIT code.</span></span><br><span class="line">    <span class="keyword">if</span> (property_get_bool(<span class="string">&quot;dalvik.vm.minidebuginfo&quot;</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">        addOption(<span class="string">&quot;-Xcompiler-option&quot;</span>);</span><br><span class="line">        addOption(<span class="string">&quot;--generate-mini-debug-info&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Retrieve the build fingerprint and provide it to the runtime. That way, ANR dumps will</span></span><br><span class="line"><span class="comment">     * contain the fingerprint and can be parsed.</span></span><br><span class="line"><span class="comment">     * Fingerprints are potentially longer than PROPERTY_VALUE_MAX, so parseRuntimeOption() cannot</span></span><br><span class="line"><span class="comment">     * be used here.</span></span><br><span class="line"><span class="comment">     * Do not ever re-assign fingerprintBuf as its c_str() value is stored in mOptions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> fingerprint = GetProperty(<span class="string">&quot;ro.build.fingerprint&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fingerprint.empty()) &#123;</span><br><span class="line">        fingerprintBuf = <span class="string">&quot;-Xfingerprint:&quot;</span> + fingerprint;</span><br><span class="line">        addOption(fingerprintBuf.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initArgs.version = JNI_VERSION_1_4;</span><br><span class="line">    initArgs.options = mOptions.editArray();</span><br><span class="line">    initArgs.nOptions = mOptions.size();</span><br><span class="line">    initArgs.ignoreUnrecognized = JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Initialize the VM.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread.</span></span><br><span class="line"><span class="comment">     * If this call succeeds, the VM is ready, and we can start issuing</span></span><br><span class="line"><span class="comment">     * JNI calls.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;JNI_CreateJavaVM failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然这段代码比较长，但是总结起来，主要做了以下两件事：</p>
<p><strong>1）对虚拟机的参数进行设置</strong></p>
<p><strong>2）调用JNI_CreateJavaVM，创建虚拟机</strong></p>
<h4 id="1-3-2-3-startReg"><a href="#1-3-2-3-startReg" class="headerlink" title="1.3.2.3 startReg"></a>1.3.2.3 startReg</h4><p>在创建Android虚拟机成功后，Android 运行环境也已准备就绪并运行。在Android系统服务运行的过程中，需要Java层和C/C++层的相互访问。在Android系统中，虚拟机提供JNI机制来实现Java层和C/C++层代码的相互访问。</p>
<p>JNI机制的实现，主要依赖于虚拟机的native method注册机制，使Java类的方法和C/C++函数关联起来。在Java类中调用相应方法的时候能直接寻找到对应的native函数并调用之。</p>
<p>为了相关服务能正常运行，在zygote中就需要对相关服务的JNI功能进行初始化，以使在相关服务运行的时候能够使用底层提供的功能。</p>
<p>此阶段就是来处理系统级的JNI的native函数注册的。用户级别的native函数的注册是通过System.loadLibrary(libraryname)中处理，此部分将在JNI处理中介绍。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Register android native functions with the VM.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*static*/</span> <span class="function"><span class="keyword">int</span> <span class="title">AndroidRuntime::startReg</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ATRACE_NAME(<span class="string">&quot;RegisterAndroidNatives&quot;</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This hook causes all future threads created in this process to be</span></span><br><span class="line"><span class="comment">     * attached to the JavaVM.  (This needs to go away in favor of JNI</span></span><br><span class="line"><span class="comment">     * Attach calls.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">&quot;--- registering native functions ---\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Every &quot;register&quot; function calls one or more things that return</span></span><br><span class="line"><span class="comment">     * a local reference (e.g. FindClass).  Because we haven&#x27;t really</span></span><br><span class="line"><span class="comment">     * started the VM yet, they&#x27;re all getting stored in the base frame</span></span><br><span class="line"><span class="comment">     * and never released.  Use Push/Pop to manage the storage.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    env-&gt;PushLocalFrame(<span class="number">200</span>);</span><br><span class="line">    <span class="comment">// 注册JNI方法，其中gRegJNI是一个数组，记录所有需要注册的jni方法，</span></span><br><span class="line">    <span class="comment">//其中有一项便是REG_JNI(register_android_os_Binder)</span></span><br><span class="line">    <span class="keyword">if</span> (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//createJavaThread(&quot;fubar&quot;, quickTest, (void*) &quot;hello&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">register_jni_procs</span><span class="params">(<span class="keyword">const</span> RegJNIRec <span class="built_in">array</span>[], <span class="keyword">size_t</span> count, JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">array</span>[i].mProc(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NDEBUG</span></span><br><span class="line">            ALOGD(<span class="string">&quot;----------!!! %s failed to load\n&quot;</span>, <span class="built_in">array</span>[i].mName);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册的过程是分别调用gRegJNI数组中每个元素，展开REG_JNI宏定义，实际执行的就是REG_JNI()括号中的函数，通过AndroidRuntime，这个函数最终会调用Java虚拟机中的RegisterNativeMethods方法，注册的过程就是把Java层的函数跟本地层的实现建立关联，这些java层函数和native函数的映射关系以JNINativeMethod gMethods[]数组来定义的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature;</span><br><span class="line">    <span class="keyword">void</span>*       fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure>

<p>需要注册的函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> RegJNIRec gRegJNI[] = &#123;</span><br><span class="line">    REG_JNI(register_com_android_internal_os_RuntimeInit),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_ZygoteInit_nativeZygoteInit),</span><br><span class="line">    REG_JNI(register_android_os_SystemClock),</span><br><span class="line">    REG_JNI(register_android_util_EventLog),</span><br><span class="line">    REG_JNI(register_android_util_Log),</span><br><span class="line">    REG_JNI(register_android_util_MemoryIntArray),</span><br><span class="line">    REG_JNI(register_android_util_PathParser),</span><br><span class="line">    REG_JNI(register_android_util_StatsLog),</span><br><span class="line">    REG_JNI(register_android_app_admin_SecurityLog),</span><br><span class="line">    REG_JNI(register_android_content_AssetManager),</span><br><span class="line">    REG_JNI(register_android_content_StringBlock),</span><br><span class="line">    REG_JNI(register_android_content_XmlBlock),</span><br><span class="line">    REG_JNI(register_android_content_res_ApkAssets),</span><br><span class="line">    REG_JNI(register_android_text_AndroidCharacter),</span><br><span class="line">    REG_JNI(register_android_text_Hyphenator),</span><br><span class="line">    REG_JNI(register_android_text_MeasuredParagraph),</span><br><span class="line">    REG_JNI(register_android_text_StaticLayout),</span><br><span class="line">    REG_JNI(register_android_view_InputDevice),</span><br><span class="line">    REG_JNI(register_android_view_KeyCharacterMap),</span><br><span class="line">    REG_JNI(register_android_os_Process),</span><br><span class="line">    REG_JNI(register_android_os_SystemProperties),</span><br><span class="line">    REG_JNI(register_android_os_Binder),</span><br><span class="line">    REG_JNI(register_android_os_Parcel),</span><br><span class="line">    REG_JNI(register_android_os_HidlSupport),</span><br><span class="line">    REG_JNI(register_android_os_HwBinder),</span><br><span class="line">    REG_JNI(register_android_os_HwBlob),</span><br><span class="line">    REG_JNI(register_android_os_HwParcel),</span><br><span class="line">    REG_JNI(register_android_os_HwRemoteBinder),</span><br><span class="line">    REG_JNI(register_android_os_VintfObject),</span><br><span class="line">    REG_JNI(register_android_os_VintfRuntimeInfo),</span><br><span class="line">    REG_JNI(register_android_nio_utils),</span><br><span class="line">    REG_JNI(register_android_graphics_Canvas),</span><br><span class="line">    REG_JNI(register_android_graphics_Graphics),</span><br><span class="line">    REG_JNI(register_android_view_DisplayEventReceiver),</span><br><span class="line">    REG_JNI(register_android_view_RenderNode),</span><br><span class="line">    REG_JNI(register_android_view_RenderNodeAnimator),</span><br><span class="line">    REG_JNI(register_android_view_DisplayListCanvas),</span><br><span class="line">    REG_JNI(register_android_view_TextureLayer),</span><br><span class="line">    REG_JNI(register_android_view_ThreadedRenderer),</span><br><span class="line">    REG_JNI(register_android_view_Surface),</span><br><span class="line">    REG_JNI(register_android_view_SurfaceControl),</span><br><span class="line">    REG_JNI(register_android_view_SurfaceSession),</span><br><span class="line">    REG_JNI(register_android_view_TextureView),</span><br><span class="line">    REG_JNI(register_com_android_internal_view_animation_NativeInterpolatorFactoryHelper),</span><br><span class="line">    REG_JNI(register_com_google_android_gles_jni_EGLImpl),</span><br><span class="line">    REG_JNI(register_com_google_android_gles_jni_GLImpl),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_EGL14),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_EGLExt),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES10),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES10Ext),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES11),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES11Ext),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES20),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES30),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES31),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES31Ext),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES32),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_graphics_Bitmap),</span><br><span class="line">    REG_JNI(register_android_graphics_BitmapFactory),</span><br><span class="line">    REG_JNI(register_android_graphics_BitmapRegionDecoder),</span><br><span class="line">    REG_JNI(register_android_graphics_ByteBufferStreamAdaptor),</span><br><span class="line">    REG_JNI(register_android_graphics_Camera),</span><br><span class="line">    REG_JNI(register_android_graphics_CreateJavaOutputStreamAdaptor),</span><br><span class="line">    REG_JNI(register_android_graphics_CanvasProperty),</span><br><span class="line">    REG_JNI(register_android_graphics_ColorFilter),</span><br><span class="line">    REG_JNI(register_android_graphics_DrawFilter),</span><br><span class="line">    REG_JNI(register_android_graphics_FontFamily),</span><br><span class="line">    REG_JNI(register_android_graphics_GraphicBuffer),</span><br><span class="line">    REG_JNI(register_android_graphics_ImageDecoder),</span><br><span class="line">    REG_JNI(register_android_graphics_drawable_AnimatedImageDrawable),</span><br><span class="line">    REG_JNI(register_android_graphics_Interpolator),</span><br><span class="line">    REG_JNI(register_android_graphics_MaskFilter),</span><br><span class="line">    REG_JNI(register_android_graphics_Matrix),</span><br><span class="line">    REG_JNI(register_android_graphics_Movie),</span><br><span class="line">    REG_JNI(register_android_graphics_NinePatch),</span><br><span class="line">    REG_JNI(register_android_graphics_Paint),</span><br><span class="line">    REG_JNI(register_android_graphics_Path),</span><br><span class="line">    REG_JNI(register_android_graphics_PathMeasure),</span><br><span class="line">    REG_JNI(register_android_graphics_PathEffect),</span><br><span class="line">    REG_JNI(register_android_graphics_Picture),</span><br><span class="line">    REG_JNI(register_android_graphics_Region),</span><br><span class="line">    REG_JNI(register_android_graphics_Shader),</span><br><span class="line">    REG_JNI(register_android_graphics_SurfaceTexture),</span><br><span class="line">    REG_JNI(register_android_graphics_Typeface),</span><br><span class="line">    REG_JNI(register_android_graphics_YuvImage),</span><br><span class="line">    REG_JNI(register_android_graphics_drawable_AnimatedVectorDrawable),</span><br><span class="line">    REG_JNI(register_android_graphics_drawable_VectorDrawable),</span><br><span class="line">    REG_JNI(register_android_graphics_pdf_PdfDocument),</span><br><span class="line">    REG_JNI(register_android_graphics_pdf_PdfEditor),</span><br><span class="line">    REG_JNI(register_android_graphics_pdf_PdfRenderer),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_database_CursorWindow),</span><br><span class="line">    REG_JNI(register_android_database_SQLiteConnection),</span><br><span class="line">    REG_JNI(register_android_database_SQLiteGlobal),</span><br><span class="line">    REG_JNI(register_android_database_SQLiteDebug),</span><br><span class="line">    REG_JNI(register_android_os_Debug),</span><br><span class="line">    REG_JNI(register_android_os_FileObserver),</span><br><span class="line">    REG_JNI(register_android_os_GraphicsEnvironment),</span><br><span class="line">    REG_JNI(register_android_os_MessageQueue),</span><br><span class="line">    REG_JNI(register_android_os_SELinux),</span><br><span class="line">    REG_JNI(register_android_os_Trace),</span><br><span class="line">    REG_JNI(register_android_os_UEventObserver),</span><br><span class="line">    REG_JNI(register_android_net_LocalSocketImpl),</span><br><span class="line">    REG_JNI(register_android_net_NetworkUtils),</span><br><span class="line">    REG_JNI(register_android_os_MemoryFile),</span><br><span class="line">    REG_JNI(register_android_os_SharedMemory),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_ClassLoaderFactory),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_Zygote),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_ZygoteInit),</span><br><span class="line">    REG_JNI(register_com_android_internal_util_VirtualRefBasePtr),</span><br><span class="line">    REG_JNI(register_android_hardware_Camera),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_CameraMetadata),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_legacy_LegacyCameraDevice),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_legacy_PerfMeasurement),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_DngCreator),</span><br><span class="line">    REG_JNI(register_android_hardware_HardwareBuffer),</span><br><span class="line">    REG_JNI(register_android_hardware_SensorManager),</span><br><span class="line">    REG_JNI(register_android_hardware_SerialPort),</span><br><span class="line">    REG_JNI(register_android_hardware_SoundTrigger),</span><br><span class="line">    REG_JNI(register_android_hardware_UsbDevice),</span><br><span class="line">    REG_JNI(register_android_hardware_UsbDeviceConnection),</span><br><span class="line">    REG_JNI(register_android_hardware_UsbRequest),</span><br><span class="line">    REG_JNI(register_android_hardware_location_ActivityRecognitionHardware),</span><br><span class="line">    REG_JNI(register_android_media_AudioRecord),</span><br><span class="line">    REG_JNI(register_android_media_AudioSystem),</span><br><span class="line">    REG_JNI(register_android_media_AudioTrack),</span><br><span class="line">    REG_JNI(register_android_media_JetPlayer),</span><br><span class="line">    REG_JNI(register_android_media_MicrophoneInfo),</span><br><span class="line">    REG_JNI(register_android_media_RemoteDisplay),</span><br><span class="line">    REG_JNI(register_android_media_ToneGenerator),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_opengl_classes),</span><br><span class="line">    REG_JNI(register_android_server_NetworkManagementSocketTagger),</span><br><span class="line">    REG_JNI(register_android_ddm_DdmHandleNativeHeap),</span><br><span class="line">    REG_JNI(register_android_backup_BackupDataInput),</span><br><span class="line">    REG_JNI(register_android_backup_BackupDataOutput),</span><br><span class="line">    REG_JNI(register_android_backup_FileBackupHelperBase),</span><br><span class="line">    REG_JNI(register_android_backup_BackupHelperDispatcher),</span><br><span class="line">    REG_JNI(register_android_app_backup_FullBackup),</span><br><span class="line">    REG_JNI(register_android_app_Activity),</span><br><span class="line">    REG_JNI(register_android_app_ActivityThread),</span><br><span class="line">    REG_JNI(register_android_app_NativeActivity),</span><br><span class="line">    REG_JNI(register_android_util_jar_StrictJarFile),</span><br><span class="line">    REG_JNI(register_android_view_InputChannel),</span><br><span class="line">    REG_JNI(register_android_view_InputEventReceiver),</span><br><span class="line">    REG_JNI(register_android_view_InputEventSender),</span><br><span class="line">    REG_JNI(register_android_view_InputQueue),</span><br><span class="line">    REG_JNI(register_android_view_KeyEvent),</span><br><span class="line">    REG_JNI(register_android_view_MotionEvent),</span><br><span class="line">    REG_JNI(register_android_view_PointerIcon),</span><br><span class="line">    REG_JNI(register_android_view_VelocityTracker),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_content_res_ObbScanner),</span><br><span class="line">    REG_JNI(register_android_content_res_Configuration),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_animation_PropertyValuesHolder),</span><br><span class="line">    REG_JNI(register_android_security_Scrypt),</span><br><span class="line">    REG_JNI(register_com_android_internal_content_NativeLibraryHelper),</span><br><span class="line">    REG_JNI(register_com_android_internal_net_NetworkStatsFactory),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_FuseAppLoop),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="2-zygote启动System-Server进程"><a href="#2-zygote启动System-Server进程" class="headerlink" title="2.zygote启动System_Server进程"></a>2.zygote启动System_Server进程</h1><h2 id="2-1启动虚拟机ZygoteInit的main方法"><a href="#2-1启动虚拟机ZygoteInit的main方法" class="headerlink" title="2.1启动虚拟机ZygoteInit的main方法"></a>2.1启动虚拟机ZygoteInit的main方法</h2><p>这段是AndroidRuntime类中的start函数最后的部分，在创建好虚拟机、注册好java与Native互相调用的函数之后，通过反射，调用ZygoteInit的main方法来启动虚拟机。开启了java端代码的执行，<strong>即java的第一个进程。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment">     * not return until the VM exits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 将 &quot;com.android.internal.os.ZygoteInit&quot;转换为&quot;com/android/internal/os/ZygoteInit&quot;</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className != <span class="literal">NULL</span> ? className : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">                threadExitUncaughtException(env);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>代码路径：/base/core/java/com/android/internal/os/ZygoteInit.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">        ZygoteServer zygoteServer = <span class="keyword">new</span> ZygoteServer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark zygote start. This ensures that thread creation will throw</span></span><br><span class="line">        <span class="comment">// an error.</span></span><br><span class="line">    	<span class="comment">//这个处理保证在Zygote Init处理的时候没有线程被创建，也就是说，在Zygote进程中是没有线程存在的。</span></span><br><span class="line">        ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zygote goes into its own process group.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Os.setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failed to setpgid(0,0)&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Runnable caller;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Report Zygote start time to tron unless it is a runtime restart</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;1&quot;</span>.equals(SystemProperties.get(<span class="string">&quot;sys.boot_completed&quot;</span>))) &#123;</span><br><span class="line">                MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">&quot;boot_zygote_init&quot;</span>,</span><br><span class="line">                        (<span class="keyword">int</span>) SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String bootTimeTag = Process.is64Bit() ? <span class="string">&quot;Zygote64Timing&quot;</span> : <span class="string">&quot;Zygote32Timing&quot;</span>;</span><br><span class="line">            TimingsTraceLog bootTimingsTraceLog = <span class="keyword">new</span> TimingsTraceLog(bootTimeTag,</span><br><span class="line">                    Trace.TRACE_TAG_DALVIK);</span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygoteInit&quot;</span>);</span><br><span class="line">            RuntimeInit.enableDdms();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//zygote socket是应用程序通过Zygote进程来创建应用进程的一个通道，</span></span><br><span class="line">            <span class="comment">//其主要被用在zygote select loop中来进行应用程序进程的创建处理。</span></span><br><span class="line">            <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">            String socketName = <span class="string">&quot;zygote&quot;</span>;<span class="comment">//socketName为zygote</span></span><br><span class="line">            String abiList = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> enableLazyPreload = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    startSystemServer = <span class="keyword">true</span>;<span class="comment">//需要启动system server</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    enableLazyPreload = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                    abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                    socketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (abiList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No ABI list supplied.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 注册 ZygoteSocket 进程间通信</span></span><br><span class="line">            zygoteServer.registerServerSocketFromEnv(socketName);</span><br><span class="line">            <span class="comment">// In some configurations, we avoid preloading resources and classes eagerly.</span></span><br><span class="line">            <span class="comment">// In such cases, we will preload things prior to our first fork.</span></span><br><span class="line">            <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">                bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygotePreload&quot;</span>);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">                <span class="comment">// 预加载 类和资源（fork 进程共享）</span></span><br><span class="line">                <span class="comment">//Android的相关资源被预加载到Zygote进程空间中。这些资源在后续所有的应用程序进程中都是共享的，</span></span><br><span class="line">                <span class="comment">//因为Android Java层进程都是Zygote的子进程。</span></span><br><span class="line">                preload(bootTimingsTraceLog);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">                bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygotePreload</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Zygote.resetNicePriority();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Do an initial gc to clean up after startup</span></span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">&quot;PostZygoteInitGC&quot;</span>);</span><br><span class="line">            gcAndFinalize();</span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// PostZygoteInitGC</span></span><br><span class="line"></span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygoteInit</span></span><br><span class="line">            <span class="comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span></span><br><span class="line">            <span class="comment">// Zygote.</span></span><br><span class="line">            Trace.setTracingEnabled(<span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            Zygote.nativeSecurityInit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Zygote process unmounts root storage spaces.</span></span><br><span class="line">            Zygote.nativeUnmountStorageOnInit();</span><br><span class="line"></span><br><span class="line">            ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">                <span class="comment">// 启动 SystemServer 此处会fork出服务进程</span></span><br><span class="line">                Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">                <span class="comment">// child (system_server) process.</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The select loop returns early in the child process after a fork and</span></span><br><span class="line">            <span class="comment">// loops forever in the zygote.</span></span><br><span class="line">            <span class="comment">// 开启无限循环模式 处理进程消息</span></span><br><span class="line">            caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;System zygote died with exception&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;re in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">        <span class="comment">// command.</span></span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            caller.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>总结下来，在ZygoteInit类的main()方法里，主要做了以下几件事：</p>
<p><strong>1）保证在Zygote进程中没有创建线程</strong></p>
<p><strong>2）创建zygote socket并监听</strong>：zygoteServer.registerServerSocketFromEnv(socketName);</p>
<p><strong>3）preload Android资源</strong>：preload(bootTimingsTraceLog);</p>
<p><strong>4）GC初始化并启动</strong></p>
<p><strong>5）启动System server进程</strong>：forkSystemServer(abiList, socketName, zygoteServer);</p>
<p><strong>6）运行zygote进程的select loop</strong>：zygoteServer.runSelectLoop(abiList)</p>
<h3 id="2-4-1-registerServerSocketFromEnv"><a href="#2-4-1-registerServerSocketFromEnv" class="headerlink" title="2.4.1 registerServerSocketFromEnv"></a>2.4.1 registerServerSocketFromEnv</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerServerSocketFromEnv</span><span class="params">(String socketName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.mServerSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//fullSocketName为“ANDROID_SOCKET_zygote”</span></span><br><span class="line">            String fullSocketName = <span class="string">&quot;ANDROID_SOCKET_&quot;</span> + socketName;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> fileDesc;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                 <span class="comment">//获取ANDROID_SOCKET_zygote的坏境变量（即为/dev/socket/zygote的文件描述符的值）</span></span><br><span class="line">            	<span class="comment">//是init进程在启动zygote进程时保存到环境变量中的</span></span><br><span class="line">                String env = System.getenv(fullSocketName);</span><br><span class="line">                fileDesc = Integer.parseInt(env);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">&quot; unset or invalid&quot;</span>, var6);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//绑定socket，在后面用来接收Android应用启动请求</span></span><br><span class="line">                FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">                fd.setInt$(fileDesc);</span><br><span class="line">                <span class="keyword">this</span>.mServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</span><br><span class="line">                <span class="keyword">this</span>.mCloseSocketFd = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Error binding to local socket &#x27;&quot;</span> + fileDesc + <span class="string">&quot;&#x27;&quot;</span>, var5);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-2-preload"><a href="#2-4-2-preload" class="headerlink" title="2.4.2 preload"></a>2.4.2 preload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">(TimingsTraceLog bootTimingsTraceLog)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;begin preload&quot;</span>);</span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;BeginIcuCachePinning&quot;</span>);</span><br><span class="line">        beginIcuCachePinning();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// BeginIcuCachePinning</span></span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;PreloadClasses&quot;</span>);</span><br><span class="line">        preloadClasses();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// PreloadClasses</span></span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;PreloadResources&quot;</span>);</span><br><span class="line">        preloadResources();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// PreloadResources</span></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">&quot;PreloadAppProcessHALs&quot;</span>);</span><br><span class="line">        nativePreloadAppProcessHALs();</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">&quot;PreloadOpenGL&quot;</span>);</span><br><span class="line">        preloadOpenGL();</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</span><br><span class="line">        preloadSharedLibraries();</span><br><span class="line">        preloadTextResources();</span><br><span class="line">        <span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></span><br><span class="line">        <span class="comment">// for memory sharing purposes.</span></span><br><span class="line">        WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">        endIcuCachePinning();</span><br><span class="line">        warmUpJcaProviders();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;end preload&quot;</span>);</span><br><span class="line"></span><br><span class="line">        sPreloadComplete = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>preload主要是将class类、系统资源、显示资源、共享库、语言库等加载进虚拟机。</p>
<p>1）preloadClasses</p>
<p>2）preloadResources：加载系统资源</p>
<p>3）preloadOpenGL: 加载显示资源</p>
<p>4）preloadSharedLibraries： 加载共享库，包含android.so、compiler_rt.so和jnigraphics.so</p>
<p>5）preloadTextResources：加载语言库</p>
<p>1）class加载</p>
<p>主要是加载类，加载的类主要是在preloaded-classes文件中：</p>
<p>find ./ -name preloaded-classes<br>        ./frameworks/base/config/preloaded-classes<br>        ./out/target/product/msmnile_gvmq/system/etc/preloaded-classes</p>
<p>虚拟机会通过classloader把preloaded-classes文件中指定的类都加载到虚拟机中，方便应用程序的调用处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs Zygote process initialization. Loads and initializes</span></span><br><span class="line"><span class="comment">     * commonly used classes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Most classes only cause a few hundred bytes to be allocated, but</span></span><br><span class="line"><span class="comment">     * a few will allocate a dozen Kbytes (in one case, 500+K).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadClasses</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> VMRuntime runtime = VMRuntime.getRuntime();</span><br><span class="line"></span><br><span class="line">        InputStream is;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = <span class="keyword">new</span> FileInputStream(PRELOADED_CLASSES);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Couldn&#x27;t find &quot;</span> + PRELOADED_CLASSES + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;Preloading classes...&quot;</span>);</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Drop root perms while running static initializers.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> reuid = Os.getuid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> regid = Os.getgid();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We need to drop root perms only if we&#x27;re already root. In the case of &quot;wrapped&quot;</span></span><br><span class="line">        <span class="comment">// processes (see WrapperInit), this function is called from an unprivileged uid</span></span><br><span class="line">        <span class="comment">// and gid.</span></span><br><span class="line">        <span class="keyword">boolean</span> droppedPriviliges = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (reuid == ROOT_UID &amp;&amp; regid == ROOT_GID) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Os.setregid(ROOT_GID, UNPRIVILEGED_GID);</span><br><span class="line">                Os.setreuid(ROOT_UID, UNPRIVILEGED_UID);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failed to drop root&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            droppedPriviliges = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Alter the target heap utilization.  With explicit GCs this</span></span><br><span class="line">        <span class="comment">// is not likely to have any effect.</span></span><br><span class="line">        <span class="keyword">float</span> defaultUtilization = runtime.getTargetHeapUtilization();</span><br><span class="line">        runtime.setTargetHeapUtilization(<span class="number">0.8f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedReader br</span><br><span class="line">                = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is), <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Skip comments and blank lines.</span></span><br><span class="line">                line = line.trim();</span><br><span class="line">                <span class="keyword">if</span> (line.startsWith(<span class="string">&quot;#&quot;</span>) || line.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_DALVIK, line);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                        Log.v(TAG, <span class="string">&quot;Preloading &quot;</span> + line + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Load and explicitly initialize the given class. Use</span></span><br><span class="line">                    <span class="comment">// Class.forName(String, boolean, ClassLoader) to avoid repeated stack lookups</span></span><br><span class="line">                    <span class="comment">// (to derive the caller&#x27;s class-loader). Use true to force initialization, and</span></span><br><span class="line">                    <span class="comment">// null for the boot classpath class-loader (could as well cache the</span></span><br><span class="line">                    <span class="comment">// class-loader of this class in a variable).</span></span><br><span class="line">                    Class.forName(line, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">&quot;Class not found for preloading: &quot;</span> + line);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError e) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">&quot;Problem preloading &quot;</span> + line + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;Error preloading &quot;</span> + line + <span class="string">&quot;.&quot;</span>, t);</span><br><span class="line">                    <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> (Error) t;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> (RuntimeException) t;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(t);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(TAG, <span class="string">&quot;...preloaded &quot;</span> + count + <span class="string">&quot; classes in &quot;</span></span><br><span class="line">                    + (SystemClock.uptimeMillis()-startTime) + <span class="string">&quot;ms.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Error reading &quot;</span> + PRELOADED_CLASSES + <span class="string">&quot;.&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(is);</span><br><span class="line">            <span class="comment">// Restore default.</span></span><br><span class="line">            runtime.setTargetHeapUtilization(defaultUtilization);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Fill in dex caches with classes, fields, and methods brought in by preloading.</span></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">&quot;PreloadDexCaches&quot;</span>);</span><br><span class="line">            runtime.preloadDexCaches();</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Bring back root. We&#x27;ll need it later if we&#x27;re in the zygote.</span></span><br><span class="line">            <span class="keyword">if</span> (droppedPriviliges) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Os.setreuid(ROOT_UID, ROOT_UID);</span><br><span class="line">                    Os.setregid(ROOT_GID, ROOT_GID);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failed to restore root&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最重要的函数是 Class.forName(line, true, null);</p>
<p><strong><em>Class.forName：*</em></strong>返回与给定的字符串名称相关联<strong>类</strong>或<strong>接口</strong>的Class对象。</p>
<p><strong><em>Class.forName</em></strong>：是一个静态方法，同样可以用来加载类。该方法有两种形式：Class.forName(String name, boolean initialize, ClassLoader loader)和 Class.forName(String className)。第一种形式的参数 name表示的是类的全名；initialize表示是否初始化类；loader表示加载时使用的类加载器。第二种形式则相当于设置了参数 initialize的值为 true，loader的值为当前类的类加载器。</p>
<h3 id="2-4-3-forkSystemServer"><a href="#2-4-3-forkSystemServer" class="headerlink" title="2.4.3 forkSystemServer"></a>2.4.3 forkSystemServer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 准备参数，并forks出system server 进程</span></span><br><span class="line"><span class="comment">    * Prepare the arguments and forks for the system server process.</span></span><br><span class="line"><span class="comment">    * 返回一个Runable对象，并提供system_server的入口函数</span></span><br><span class="line"><span class="comment">    * Returns an &#123;<span class="doctag">@code</span> Runnable&#125; that provides an entrypoint into system_server code in the</span></span><br><span class="line"><span class="comment">    * child process, and &#123;<span class="doctag">@code</span> null&#125; in the parent.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title">forkSystemServer</span><span class="params">(String abiList, String socketName,</span></span></span><br><span class="line"><span class="function"><span class="params">           ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> capabilities = posixCapabilitiesAsBits(</span><br><span class="line">           OsConstants.CAP_IPC_LOCK,</span><br><span class="line">           OsConstants.CAP_KILL,</span><br><span class="line">           OsConstants.CAP_NET_ADMIN,</span><br><span class="line">           OsConstants.CAP_NET_BIND_SERVICE,</span><br><span class="line">           OsConstants.CAP_NET_BROADCAST,</span><br><span class="line">           OsConstants.CAP_NET_RAW,</span><br><span class="line">           OsConstants.CAP_SYS_MODULE,</span><br><span class="line">           OsConstants.CAP_SYS_NICE,</span><br><span class="line">           OsConstants.CAP_SYS_PTRACE,</span><br><span class="line">           OsConstants.CAP_SYS_TIME,</span><br><span class="line">           OsConstants.CAP_SYS_TTY_CONFIG,</span><br><span class="line">           OsConstants.CAP_WAKE_ALARM,</span><br><span class="line">           OsConstants.CAP_BLOCK_SUSPEND</span><br><span class="line">       );</span><br><span class="line">       <span class="comment">/* Containers run without some capabilities, so drop any caps that are not available. */</span></span><br><span class="line">       StructCapUserHeader header = <span class="keyword">new</span> StructCapUserHeader(</span><br><span class="line">               OsConstants._LINUX_CAPABILITY_VERSION_3, <span class="number">0</span>);</span><br><span class="line">       StructCapUserData[] data;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           data = Os.capget(header);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failed to capget()&quot;</span>, ex);</span><br><span class="line">       &#125;</span><br><span class="line">       capabilities &amp;= ((<span class="keyword">long</span>) data[<span class="number">0</span>].effective) | (((<span class="keyword">long</span>) data[<span class="number">1</span>].effective) &lt;&lt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/* Hardcoded command line to start the system server */</span></span><br><span class="line">       String args[] = &#123;</span><br><span class="line">           <span class="string">&quot;--setuid=1000&quot;</span>,</span><br><span class="line">           <span class="string">&quot;--setgid=1000&quot;</span>,</span><br><span class="line">           <span class="string">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1024,1032,1065,3001,3002,3003,3006,3007,3009,3010&quot;</span>,</span><br><span class="line">           <span class="string">&quot;--capabilities=&quot;</span> + capabilities + <span class="string">&quot;,&quot;</span> + capabilities,</span><br><span class="line">           <span class="string">&quot;--nice-name=system_server&quot;</span>,</span><br><span class="line">           <span class="string">&quot;--runtime-args&quot;</span>,</span><br><span class="line">           <span class="string">&quot;--target-sdk-version=&quot;</span> + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,</span><br><span class="line">           <span class="string">&quot;com.android.server.SystemServer&quot;</span>,</span><br><span class="line">       &#125;;</span><br><span class="line">       ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">           ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">           ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">boolean</span> profileSystemServer = SystemProperties.getBoolean(</span><br><span class="line">                   <span class="string">&quot;dalvik.vm.profilesystemserver&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">           <span class="keyword">if</span> (profileSystemServer) &#123;</span><br><span class="line">               parsedArgs.runtimeFlags |= Zygote.PROFILE_SYSTEM_SERVER;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/* Request to fork the system server process */</span></span><br><span class="line">           pid = Zygote.forkSystemServer(</span><br><span class="line">                   parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                   parsedArgs.gids,</span><br><span class="line">                   parsedArgs.runtimeFlags,</span><br><span class="line">                   <span class="keyword">null</span>,</span><br><span class="line">                   parsedArgs.permittedCapabilities,</span><br><span class="line">                   parsedArgs.effectiveCapabilities);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/* For child process */</span></span><br><span class="line">       <span class="comment">//在system_server进程创建之后，如果运行的是子进程，即system_server进程，则通过命令执行到</span></span><br><span class="line">       <span class="comment">//com.android.server.SystemServer类的main()方法。</span></span><br><span class="line">       <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">//子进程（system_server）</span></span><br><span class="line">           <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">               waitForSecondaryZygote(socketName);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           zygoteServer.closeServerSocket();</span><br><span class="line">           <span class="keyword">return</span> handleSystemServerProcess(parsedArgs);</span><br><span class="line">       &#125;</span><br><span class="line">	<span class="comment">//父进程（zygote）,返回的是null，继续往下执行</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>1）forks出system server 进程：Zygote.forkSystemServer</p>
<p>2）通过命令执行到com.android.server.SystemServer类的main()方法： handleSystemServerProcess</p>
<p>ZygoteInit的<code>forkSystemServer</code>方法会调用Zygote的<code>forkSystemServer</code>方法，如果是子进程（system_server）就返回<code>handleSystemServerProcess()</code>,父进程（zygote）就返回null。</p>
<h4 id="2-4-3-1-forkSystemServer"><a href="#2-4-3-1-forkSystemServer" class="headerlink" title="2.4.3.1 forkSystemServer"></a>2.4.3.1 forkSystemServer</h4><p>调用<code>nativeForkSystemServer</code> fork出子进程，<code>nativeForkSystemServer</code>是本地方法，在前面已经通过<code>startReg</code>方法中的<code>register_com_android_internal_os_Zygote</code>将<code>nativeForkSystemServer</code>方法映射到<code>com_android_internal_os_Zygote_nativeForkSystemServer</code>方法上fork出子进程之后，子进程就开始调用<code>handleSystemServerProcess()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Special method to start the system server process. In addition to the</span></span><br><span class="line"><span class="comment">     * common actions performed in forkAndSpecialize, the pid of the child</span></span><br><span class="line"><span class="comment">     * process is recorded such that the death of the child process will cause</span></span><br><span class="line"><span class="comment">     * zygote to exit.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid the UNIX uid that the new process should setuid() to after</span></span><br><span class="line"><span class="comment">     * fork()ing and and before spawning any threads.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gid the UNIX gid that the new process should setgid() to after</span></span><br><span class="line"><span class="comment">     * fork()ing and and before spawning any threads.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gids null-ok; a list of UNIX gids that the new process should</span></span><br><span class="line"><span class="comment">     * setgroups() to after fork and before spawning any threads.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runtimeFlags bit flags that enable ART features.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rlimits null-ok an array of rlimit tuples, with the second</span></span><br><span class="line"><span class="comment">     * dimension having a length of 3 and representing</span></span><br><span class="line"><span class="comment">     * (resource, rlim_cur, rlim_max). These are set via the posix</span></span><br><span class="line"><span class="comment">     * setrlimit(2) call.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permittedCapabilities argument for setcap()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> effectiveCapabilities argument for setcap()</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 0 if this is the child, pid of the child</span></span><br><span class="line"><span class="comment">     * if this is the parent, or -1 on error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkSystemServer</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[][] rlimits, <span class="keyword">long</span> permittedCapabilities, <span class="keyword">long</span> effectiveCapabilities)</span> </span>&#123;</span><br><span class="line">        VM_HOOKS.preFork();</span><br><span class="line">        <span class="comment">// Resets nice priority for zygote process.</span></span><br><span class="line">        resetNicePriority();</span><br><span class="line">        <span class="keyword">int</span> pid = nativeForkSystemServer(</span><br><span class="line">                uid, gid, gids, runtimeFlags, rlimits, permittedCapabilities, effectiveCapabilities);</span><br><span class="line">        <span class="comment">// Enable tracing as soon as we enter the system_server.</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            Trace.setTracingEnabled(<span class="keyword">true</span>, runtimeFlags);</span><br><span class="line">        &#125;</span><br><span class="line">        VM_HOOKS.postForkCommon();</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-2-handleSystemServerProcess"><a href="#2-4-3-2-handleSystemServerProcess" class="headerlink" title="2.4.3.2 handleSystemServerProcess"></a>2.4.3.2 handleSystemServerProcess</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish remaining work for the newly forked system server process.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title">handleSystemServerProcess</span><span class="params">(ZygoteConnection.Arguments parsedArgs)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// set umask to 0077 so new files and directories will default to owner-only permissions.</span></span><br><span class="line">    Os.umask(S_IRWXG | S_IRWXO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//从环境变量SYSTEMSERVERCLASSPATH获取到SystemServer类文件相应jar包的路径</span></span><br><span class="line">    <span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">&quot;SYSTEMSERVERCLASSPATH&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//对相应的jar包做dex优化处理</span></span><br><span class="line">        performSystemServerDexOpt(systemServerClasspath);</span><br><span class="line">        <span class="comment">// Capturing profiles is only supported for debug or eng builds since selinux normally</span></span><br><span class="line">        <span class="comment">// prevents it.</span></span><br><span class="line">        <span class="keyword">boolean</span> profileSystemServer = SystemProperties.getBoolean(</span><br><span class="line">                <span class="string">&quot;dalvik.vm.profilesystemserver&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (profileSystemServer &amp;&amp; (Build.IS_USERDEBUG || Build.IS_ENG)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                prepareSystemServerProfile(systemServerClasspath);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;Failed to set up system server profile&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String[] args = parsedArgs.remainingArgs;</span><br><span class="line">        <span class="comment">// If we have a non-null system server class path, we&#x27;ll have to duplicate the</span></span><br><span class="line">        <span class="comment">// existing arguments and append the classpath to it. ART will handle the classpath</span></span><br><span class="line">        <span class="comment">// correctly when we exec a new process.</span></span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String[] amendedArgs = <span class="keyword">new</span> String[args.length + <span class="number">2</span>];</span><br><span class="line">            amendedArgs[<span class="number">0</span>] = <span class="string">&quot;-cp&quot;</span>;</span><br><span class="line">            amendedArgs[<span class="number">1</span>] = systemServerClasspath;</span><br><span class="line">            System.arraycopy(args, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, args.length);</span><br><span class="line">            args = amendedArgs;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                VMRuntime.getCurrentInstructionSet(), <span class="keyword">null</span>, args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unexpected return from WrapperInit.execApplication&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ClassLoader cl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//创建类加载器classloader</span></span><br><span class="line">            cl = createPathClassLoader(systemServerClasspath, parsedArgs.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">            Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Pass the remaining arguments to SystemServer.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//parsedArgs.remainingArgs剩余参数的值就是SystemServer的类路径</span></span><br><span class="line">        <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* should never reach here */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先从<code>SYSTEMSERVERCLASSPATH</code>环境中获取到SystemServer的classpath,然后使用<code>performSystemServerDexOpt</code>对classpath对应的jar包做dex优化处理。然后创建对应的classloader,后续用来加载SystemServer类，<code>ZygoteInit.zygoteInit()</code>继续往下执行：</p>
<h4 id="2-4-3-3-ZygoteInit-zygoteInit"><a href="#2-4-3-3-ZygoteInit-zygoteInit" class="headerlink" title="2.4.3.3 ZygoteInit.zygoteInit()"></a>2.4.3.3 ZygoteInit.zygoteInit()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The main function called when started through the zygote process. This</span></span><br><span class="line"><span class="comment">    * could be unified with main(), if the native code in nativeFinishInit()</span></span><br><span class="line"><span class="comment">    * were rationalized with Zygote startup.&lt;p&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Current recognized args:</span></span><br><span class="line"><span class="comment">    * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">    *   &lt;li&gt; &lt;code&gt; [--] &amp;lt;start class name&amp;gt;  &amp;lt;args&amp;gt;</span></span><br><span class="line"><span class="comment">    * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> targetSdkVersion target SDK version</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> argv arg strings</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Runnable <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (RuntimeInit.DEBUG) &#123;</span><br><span class="line">           Slog.d(RuntimeInit.TAG, <span class="string">&quot;RuntimeInit: Starting application from zygote&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ZygoteInit&quot;</span>);</span><br><span class="line">       <span class="comment">//将标准输出流和标准错误流重定向到Android log中</span></span><br><span class="line">       RuntimeInit.redirectLogStreams();</span><br><span class="line"></span><br><span class="line">       RuntimeInit.commonInit();</span><br><span class="line">       <span class="comment">//本地方法，startReg映射，主要是开启ProcessState线程池，用来进行binder通信</span></span><br><span class="line">       ZygoteInit.nativeZygoteInit();</span><br><span class="line">       <span class="keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, argv, classLoader);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后通过RuntimeInit的applicationInit()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invokes a static &quot;main(argv[]) method on class &quot;className&quot;.</span></span><br><span class="line"><span class="comment">     * Converts various failing exceptions into RuntimeExceptions, with</span></span><br><span class="line"><span class="comment">     * the assumption that they will then cause the VM instance to exit.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className Fully-qualified class name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> argv Argument vector for main()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classLoader the classLoader to load &#123;<span class="doctag">@className</span>&#125; with</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	String args[] = &#123;</span></span><br><span class="line"><span class="comment">            &quot;--setuid=1000&quot;,</span></span><br><span class="line"><span class="comment">            &quot;--setgid=1000&quot;,</span></span><br><span class="line"><span class="comment">            &quot;--				     setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010&quot;,</span></span><br><span class="line"><span class="comment">            &quot;--capabilities=&quot; + capabilities + &quot;,&quot; + capabilities,</span></span><br><span class="line"><span class="comment">            &quot;--nice-name=system_server&quot;,</span></span><br><span class="line"><span class="comment">            &quot;--runtime-args&quot;,</span></span><br><span class="line"><span class="comment">            &quot;com.android.server.SystemServer&quot;,</span></span><br><span class="line"><span class="comment">        &#125;;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title">findStaticMain</span><span class="params">(String className, String[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">            ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Missing class when invoking static main &quot;</span> + className,</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method m;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m = cl.getMethod(<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Missing static main on &quot;</span> + className, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Problem getting static main on &quot;</span> + className, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> modifiers = m.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Main method is not public and static on &quot;</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This throw gets caught in ZygoteInit.main(), which responds</span></span><br><span class="line"><span class="comment">         * by invoking the exception&#x27;s run() method. This arrangement</span></span><br><span class="line"><span class="comment">         * clears up all the stack frames that were required in setting</span></span><br><span class="line"><span class="comment">         * up the process.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MethodAndArgsCaller(m, argv);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>findStaicMain获取到SystemServer的类类型，并且获取到SystemServer中的main方法的方法id。然后new MethodAndArgsCaller(m,argv)</p>
<p>通过以上的分析return new MethodAndArgsCaller(m, argv);返回的就是forkSystemServer的返回值。接着分析 r.run();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">    <span class="comment">// 启动 SystemServer 此处会fork出服务进程</span></span><br><span class="line">    Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">    <span class="comment">// child (system_server) process.</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.run();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Helper class which holds a method and arguments and can call them. This is used as part of</span></span><br><span class="line"><span class="comment">    * a trampoline to get rid of the initial process setup stack frames.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">       <span class="comment">/** method to call */</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/** argument array */</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> String[] mArgs;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">MethodAndArgsCaller</span><span class="params">(Method method, String[] args)</span> </span>&#123;</span><br><span class="line">           mMethod = method;</span><br><span class="line">           mArgs = args;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//说白了这里就是通过反射的方式调用SystemServer类的main方法</span></span><br><span class="line">               mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">               Throwable cause = ex.getCause();</span><br><span class="line">               <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h1 id="3-fork应用进程"><a href="#3-fork应用进程" class="headerlink" title="3.fork应用进程"></a>3.fork应用进程</h1><p>Zygote 服务在被 init 服务创建的时候就启动了一个 Socket 服务，等待着 AMS 的接入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zygoteServer.runSelectLoop(abiList)；</span><br></pre></td></tr></table></figure>

<p>当AMS发起创建应用进程后，zygoteServer的runSelectLoop(abiList)；方法会接收来自AMS的socket信息，并根据是socket的信息创建出应用进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Runnable <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        fds.add(<span class="keyword">this</span>.mServerSocket.getFileDescriptor());</span><br><span class="line">        peers.add((Object)<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">                pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">                pollFds[i].fd = (FileDescriptor)fds.get(i);</span><br><span class="line">                pollFds[i].events = (<span class="keyword">short</span>)OsConstants.POLLIN;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//开启轮询</span></span><br><span class="line">                Os.poll(pollFds, -<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException var13) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;poll failed&quot;</span>, var13);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((pollFds[i].revents &amp; OsConstants.POLLIN) != <span class="number">0</span>) &#123;</span><br><span class="line">                    ZygoteConnection connection;</span><br><span class="line">                    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;<span class="comment">//如果是新的socket链接请求(建立新连接)</span></span><br><span class="line">                        connection = <span class="keyword">this</span>.acceptCommandPeer(abiList);<span class="comment">//新建ZygoteConnection链接</span></span><br><span class="line">                        peers.add(connection);<span class="comment">//添加到链接数组中</span></span><br><span class="line">                        fds.add(connection.getFileDesciptor());<span class="comment">//添加到文件描述符数组中</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;<span class="comment">//如果是之前已经建立的socket链接（在已有连接上）</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;<span class="comment">//获取对应的ZygoteConnection</span></span><br><span class="line">                            connection = (ZygoteConnection)peers.get(i);</span><br><span class="line">                            <span class="comment">//会执行ZygoteConnection发送过来的命令</span></span><br><span class="line">                            Runnable command = connection.processOneCommand(<span class="keyword">this</span>);</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">this</span>.mIsForkChild) &#123;<span class="comment">//子进程走这儿</span></span><br><span class="line">                                <span class="keyword">if</span> (command == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;command == null&quot;</span>);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                Runnable var8 = command;</span><br><span class="line">                                <span class="keyword">return</span> var8;<span class="comment">//退出，var8就是④中的caller</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//由于上面是fork出的子进程，运行就会返回</span></span><br><span class="line">							<span class="comment">//父进程走这儿，上面是while无限循环，zygote进程永远不会退出</span></span><br><span class="line">                            <span class="keyword">if</span> (command != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;command != null&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (connection.isClosedByPeer()) &#123;</span><br><span class="line">                                connection.closeSocket();</span><br><span class="line">                                peers.remove(i);</span><br><span class="line">                                fds.remove(i);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">this</span>.mIsForkChild) &#123;</span><br><span class="line">                                Log.e(<span class="string">&quot;ZygoteServer&quot;</span>, <span class="string">&quot;Caught post-fork exception in child process.&quot;</span>, var14);</span><br><span class="line">                                <span class="keyword">throw</span> var14;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            Slog.e(<span class="string">&quot;ZygoteServer&quot;</span>, <span class="string">&quot;Exception executing zygote command: &quot;</span>, var14);</span><br><span class="line">                            ZygoteConnection conn = (ZygoteConnection)peers.remove(i);</span><br><span class="line">                            conn.closeSocket();</span><br><span class="line">                            fds.remove(i);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.mIsForkChild = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面的流程概括来说，就是会轮询/dev/socket/zygote的socket,如果有新的链接，就新建ZygoteConnection，并将对应的socket fd添加到fds(轮询数组中)，继续轮询，如果是新的链接，就重复上面的操作，如果是已经建立的链接，就执行该链接上读取到的command,也就是<code>connection.processOneCommand()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reads one start command from the command socket. If successful, a child is forked and a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> Runnable&#125; that calls the childs main method (or equivalent) is returned in the child</span></span><br><span class="line"><span class="comment"> * process. &#123;<span class="doctag">@code</span> null&#125; is always returned in the parent process (the zygote).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the client closes the socket, an &#123;<span class="doctag">@code</span> EOF&#125; condition is set, which callers can test</span></span><br><span class="line"><span class="comment"> * for by calling &#123;<span class="doctag">@code</span> ZygoteConnection.isClosedByPeer&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Runnable <span class="title">processOneCommand</span><span class="params">(ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class="line">    String args[];</span><br><span class="line">    Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">    FileDescriptor[] descriptors;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//读取命令</span></span><br><span class="line">        args = readArgumentList();</span><br><span class="line">        descriptors = mSocket.getAncillaryFileDescriptors();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;IOException on command socket&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// readArgumentList returns null only when it has reached EOF with no available</span></span><br><span class="line">    <span class="comment">// data to read. This will only happen when the remote socket has disconnected.</span></span><br><span class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">        isEof = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid = -<span class="number">1</span>;</span><br><span class="line">    FileDescriptor childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">    FileDescriptor serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    parsedArgs = <span class="keyword">new</span> Arguments(args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.abiListQuery) &#123;</span><br><span class="line">        handleAbiListQuery();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.preloadDefault) &#123;</span><br><span class="line">        handlePreload();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.preloadPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handlePreloadPackage(parsedArgs.preloadPackage, parsedArgs.preloadPackageLibs,</span><br><span class="line">                parsedArgs.preloadPackageLibFileName, parsedArgs.preloadPackageCacheKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.apiBlacklistExemptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleApiBlacklistExemptions(parsedArgs.apiBlacklistExemptions);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.hiddenApiAccessLogSampleRate != -<span class="number">1</span>) &#123;</span><br><span class="line">        handleHiddenApiAccessLogSampleRate(parsedArgs.hiddenApiAccessLogSampleRate);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.permittedCapabilities != <span class="number">0</span> || parsedArgs.effectiveCapabilities != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteSecurityException(<span class="string">&quot;Client may not specify capabilities: &quot;</span> +</span><br><span class="line">                <span class="string">&quot;permitted=0x&quot;</span> + Long.toHexString(parsedArgs.permittedCapabilities) +</span><br><span class="line">                <span class="string">&quot;, effective=0x&quot;</span> + Long.toHexString(parsedArgs.effectiveCapabilities));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    applyUidSecurityPolicy(parsedArgs, peer);</span><br><span class="line">    applyInvokeWithSecurityPolicy(parsedArgs, peer);</span><br><span class="line"></span><br><span class="line">    applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">    applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[][] rlimits = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.rlimits != <span class="keyword">null</span>) &#123;</span><br><span class="line">        rlimits = parsedArgs.rlimits.toArray(intArray2d);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] fdsToIgnore = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileDescriptor[] pipeFds = Os.pipe2(O_CLOEXEC);</span><br><span class="line">            childPipeFd = pipeFds[<span class="number">1</span>];</span><br><span class="line">            serverPipeFd = pipeFds[<span class="number">0</span>];</span><br><span class="line">            Os.fcntlInt(childPipeFd, F_SETFD, <span class="number">0</span>);</span><br><span class="line">            fdsToIgnore = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;childPipeFd.getInt$(), serverPipeFd.getInt$()&#125;;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException errnoEx) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unable to set up pipe for invoke-with&quot;</span>, errnoEx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * In order to avoid leaking descriptors to the Zygote child,</span></span><br><span class="line"><span class="comment">     * the native code must close the two Zygote socket descriptors</span></span><br><span class="line"><span class="comment">     * in the child process before it switches from Zygote-root to</span></span><br><span class="line"><span class="comment">     * the UID and privileges of the application being launched.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * In order to avoid &quot;bad file descriptor&quot; errors when the</span></span><br><span class="line"><span class="comment">     * two LocalSocket objects are closed, the Posix file</span></span><br><span class="line"><span class="comment">     * descriptors are released via a dup2() call which closes</span></span><br><span class="line"><span class="comment">     * the socket and substitutes an open descriptor to /dev/null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> [] fdsToClose = &#123; -<span class="number">1</span>, -<span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">    FileDescriptor fd = mSocket.getFileDescriptor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</span><br><span class="line">        fdsToClose[<span class="number">0</span>] = fd.getInt$();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = zygoteServer.getServerSocketFileDescriptor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</span><br><span class="line">        fdsToClose[<span class="number">1</span>] = fd.getInt$();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fork子进程</span></span><br><span class="line">    pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">            parsedArgs.runtimeFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">            parsedArgs.niceName, fdsToClose, fdsToIgnore, parsedArgs.startChildZygote,</span><br><span class="line">            parsedArgs.instructionSet, parsedArgs.appDataDir);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// in child</span></span><br><span class="line">            <span class="comment">// 子进程中(应用进程中)</span></span><br><span class="line">            zygoteServer.setForkChild();</span><br><span class="line"></span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">            IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">            serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> handleChildProc(parsedArgs, descriptors, childPipeFd,</span><br><span class="line">                    parsedArgs.startChildZygote);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//父进程中（zygote）</span></span><br><span class="line">            <span class="comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span></span><br><span class="line">            <span class="comment">// handleParentProc.</span></span><br><span class="line">            IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">            childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">            handleParentProc(pid, descriptors, serverPipeFd);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">        IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从当前链接socket中读取启动命令。如果读取成功，zygote将会fork出子进程，并且返回可以调用启动类的main方法的runnable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> handleChildProc(parsedArgs, descriptors, childPipeFd,</span><br><span class="line">                       parsedArgs.startChildZygote);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handles post-fork setup of child proc, closing sockets as appropriate,</span></span><br><span class="line"><span class="comment"> * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller</span></span><br><span class="line"><span class="comment"> * if successful or returning if failed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parsedArgs non-null; zygote args</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> descriptors null-ok; new file descriptors for stdio if available.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pipeFd null-ok; pipe for communication back to Zygote.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isZygote whether this new child process is itself a new Zygote.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs, FileDescriptor[] descriptors,</span></span></span><br><span class="line"><span class="function"><span class="params">        FileDescriptor pipeFd, <span class="keyword">boolean</span> isZygote)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By the time we get here, the native code has closed the two actual Zygote</span></span><br><span class="line"><span class="comment">     * socket connections, and substituted /dev/null in their place.  The LocalSocket</span></span><br><span class="line"><span class="comment">     * objects still need to be closed properly.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    closeSocket();</span><br><span class="line">    <span class="keyword">if</span> (descriptors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Os.dup2(descriptors[<span class="number">0</span>], STDIN_FILENO);</span><br><span class="line">            Os.dup2(descriptors[<span class="number">1</span>], STDOUT_FILENO);</span><br><span class="line">            Os.dup2(descriptors[<span class="number">2</span>], STDERR_FILENO);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (FileDescriptor fd: descriptors) &#123;</span><br><span class="line">                IoUtils.closeQuietly(fd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Error reopening stdio&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// End of the postFork event.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                VMRuntime.getCurrentInstructionSet(),</span><br><span class="line">                pipeFd, parsedArgs.remainingArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Should not get here.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;WrapperInit.execApplication unexpectedly returned&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isZygote) &#123;</span><br><span class="line">            <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ZygoteInit.childZygoteInit(parsedArgs.targetSdkVersion,</span><br><span class="line">                    parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终会调用：ZygoteInit.zygoteInit，这里就又回到了一开始创建system_server的流程了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isZygote) &#123;</span><br><span class="line">                <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs,</span><br><span class="line">                        <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ZygoteInit.childZygoteInit(parsedArgs.targetSdkVersion,</span><br><span class="line">                        parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>如果是启动APP进程，即AMS请求启动应用进程，启动类就是<code>ActivityThread.java</code>，<code>caller.run()</code>就会反射调用ActivityThread的<code>main</code>方法。最终启动一个新的应用进程。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">SongSong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2020/10/15/zygote01/">http://example.com/2020/10/15/zygote01/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/zygote/">zygote</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/16/binder_reg_jni/"><img class="prev-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">binder的jni函数注册</div></div></a></div><div class="next-post pull-right"><a href="/2020/10/14/Context%E7%90%86%E8%A7%A3/"><img class="next-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Context理解</div></div></a></div></nav></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By SongSong</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="http://makediffrencesong.github.io/">blog</a>!</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>