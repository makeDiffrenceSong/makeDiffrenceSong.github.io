<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AMS-04-应用启动流程（zygotefork出应用进程之后的流程） | Make a difference</title><meta name="keywords" content="android"><meta name="author" content="SongSong"><meta name="copyright" content="SongSong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="1.ActivityThread当zygotefork出应用进程之后，会调用ActivityThread的main方法 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public static void main(String[] args) &amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="AMS-04-应用启动流程（zygotefork出应用进程之后的流程）">
<meta property="og:url" content="http://example.com/2020/11/12/AMS-04-%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Make a difference">
<meta property="og:description" content="1.ActivityThread当zygotefork出应用进程之后，会调用ActivityThread的main方法 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public static void main(String[] args) &amp;#123;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2020-11-12T01:13:20.000Z">
<meta property="article:modified_time" content="2020-11-12T08:11:46.893Z">
<meta property="article:author" content="SongSong">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/11/12/AMS-04-%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-11-12 16:11:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Make a difference" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/friend.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">52</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-ActivityThread"><span class="toc-number">1.</span> <span class="toc-text">1.ActivityThread</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Make a difference</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">AMS-04-应用启动流程（zygotefork出应用进程之后的流程）</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-11-12T01:13:20.000Z" title="Created 2020-11-12 09:13:20">2020-11-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-11-12T08:11:46.893Z" title="Updated 2020-11-12 16:11:46">2020-11-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PKMS/">PKMS</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><img src="../images/AMS-04-%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/AMS-startActivity.bmp" alt="AMS-startActivity"></p>
<h1 id="1-ActivityThread"><a href="#1-ActivityThread" class="headerlink" title="1.ActivityThread"></a>1.ActivityThread</h1><p>当zygotefork出应用进程之后，会调用ActivityThread的main方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ActivityThreadMain&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">    <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">    <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the reporter for event logging in libcore</span></span><br><span class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></span><br><span class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the value for &#123;@link #PROC_START_SEQ_IDENT&#125; if provided on the command line.</span></span><br><span class="line">    <span class="comment">// It will be in the format &quot;seq=114&quot;</span></span><br><span class="line">    <span class="keyword">long</span> startSeq = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = args.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args[i] != <span class="keyword">null</span> &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) &#123;</span><br><span class="line">                startSeq = Long.parseLong(</span><br><span class="line">                        args[i].substring(PROC_START_SEQ_IDENT.length()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">&quot;ActivityThread&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用ActivityThread的attach进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">        sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">        mSystemThread = system;</span><br><span class="line">        <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">            ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    ensureJitEnabled();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            android.ddm.DdmHandleAppName.setAppName(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>,</span><br><span class="line">                                                    UserHandle.myUserId());</span><br><span class="line">            RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">            <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Watch for getting close to heap limit.</span></span><br><span class="line">            BinderInternal.addGcWatcher(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                    <span class="keyword">long</span> dalvikMax = runtime.maxMemory();</span><br><span class="line">                    <span class="keyword">long</span> dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                    <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_MEMORY_TRIM) Slog.d(TAG, <span class="string">&quot;Dalvik max=&quot;</span> + (dalvikMax/<span class="number">1024</span>)</span><br><span class="line">                                + <span class="string">&quot; total=&quot;</span> + (runtime.totalMemory()/<span class="number">1024</span>)</span><br><span class="line">                                + <span class="string">&quot; used=&quot;</span> + (dalvikUsed/<span class="number">1024</span>));</span><br><span class="line">                        mSomeActivitiesChanged = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mgr.releaseSomeActivities(mAppThread);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t set application object here -- if the system crashes,</span></span><br><span class="line">            <span class="comment">// we can&#x27;t display an alert, we just want to die die die.</span></span><br><span class="line">            android.ddm.DdmHandleAppName.setAppName(<span class="string">&quot;system_process&quot;</span>,</span><br><span class="line">                    UserHandle.myUserId());</span><br><span class="line">            <span class="keyword">try</span> &#123;<span class="comment">//systemServer走的流程</span></span><br><span class="line">                mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">                mInstrumentation.basicInit(<span class="keyword">this</span>);</span><br><span class="line">                ContextImpl context = ContextImpl.createAppContext(</span><br><span class="line">                        <span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line">                mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">                mInitialApplication.onCreate();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">&quot;Unable to instantiate Application():&quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add dropbox logging to libcore</span></span><br><span class="line">        DropBox.setReporter(<span class="keyword">new</span> DropBoxReporter());</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 为 ViewRootImpl 设置配置更新回调，</span></span><br><span class="line">  <span class="comment">//当系统资源配置（如：系统字体）发生变化时，通知系统配置发生变化</span></span><br><span class="line">        ViewRootImpl.ConfigChangedCallback configChangedCallback</span><br><span class="line">                = (Configuration globalConfig) -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">                <span class="comment">// We need to apply this change to the resources immediately, because upon returning</span></span><br><span class="line">                <span class="comment">// the view hierarchy will be informed about it.</span></span><br><span class="line">                <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(globalConfig,</span><br><span class="line">                        <span class="keyword">null</span> <span class="comment">/* compat */</span>)) &#123;</span><br><span class="line">                    updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                            mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// This actually changed the resources! Tell everyone about it.</span></span><br><span class="line">                    <span class="keyword">if</span> (mPendingConfiguration == <span class="keyword">null</span></span><br><span class="line">                            || mPendingConfiguration.isOtherSeqNewer(globalConfig)) &#123;</span><br><span class="line">                        mPendingConfiguration = globalConfig;</span><br><span class="line">                        sendMessage(H.CONFIGURATION_CHANGED, globalConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        ViewRootImpl.addConfigCallback(configChangedCallback);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>attach主要做了以下几件事：</p>
<p>1）获取AMS服务的本地代理，IActivityManager mgr = ActivityManager.getService()，并将应用进程的代理对象传入AMS中，mgr.attachApplication(mAppThread, startSeq);</p>
<p>2）为 ViewRootImpl 设置配置更新回调，当系统资源配置（如：系统字体）发生变化时，通知系统配置发生变化</p>
<p>后续调用到AMS中，并执行attachApplication方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//通过Binder获取传入的pid信息</span></span><br><span class="line">            <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">            attachApplicationLocked(thread, callingPid, callingUid, startSeq);</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> pid, <span class="keyword">int</span> callingUid, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Find the application record that is being attached...  either via</span></span><br><span class="line">      <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></span><br><span class="line">      <span class="comment">// next app record if we are emulating process with anonymous threads.</span></span><br><span class="line">      ProcessRecord app;</span><br><span class="line">      <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">      <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">              app = mPidsSelfLocked.get(pid);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          app = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// It&#x27;s possible that process called attachApplication before we got a chance to</span></span><br><span class="line">      <span class="comment">// update the internal state.</span></span><br><span class="line">      <span class="keyword">if</span> (app == <span class="keyword">null</span> &amp;&amp; startSeq &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">final</span> ProcessRecord pending = mPendingStarts.get(startSeq);</span><br><span class="line">          <span class="keyword">if</span> (pending != <span class="keyword">null</span> &amp;&amp; pending.startUid == callingUid</span><br><span class="line">                  &amp;&amp; handleProcessStartedLocked(pending, pid, pending.usingWrapper,</span><br><span class="line">                          startSeq, <span class="keyword">true</span>)) &#123;</span><br><span class="line">              app = pending;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">          Slog.w(TAG, <span class="string">&quot;No pending application record for pid &quot;</span> + pid</span><br><span class="line">                  + <span class="string">&quot; (IApplicationThread &quot;</span> + thread + <span class="string">&quot;); dropping process&quot;</span>);</span><br><span class="line">          EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</span><br><span class="line">          <span class="keyword">if</span> (pid &gt; <span class="number">0</span> &amp;&amp; pid != MY_PID) &#123;</span><br><span class="line">              killProcessQuiet(pid);</span><br><span class="line">              <span class="comment">//<span class="doctag">TODO:</span> killProcessGroup(app.info.uid, pid);</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  thread.scheduleExit();</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  <span class="comment">// Ignore exceptions.</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If this application record is still attached to a previous</span></span><br><span class="line">      <span class="comment">// process, clean it up now.</span></span><br><span class="line"><span class="comment">//如果当前的Application记录仍然依附到之前的进程中，则清理掉</span></span><br><span class="line">      <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">          handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell the process all about itself.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">              TAG, <span class="string">&quot;Binding process pid &quot;</span> + pid + <span class="string">&quot; to record &quot;</span> + app);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          AppDeathRecipient adr = <span class="keyword">new</span> AppDeathRecipient(</span><br><span class="line">                  app, pid, thread);</span><br><span class="line">          thread.asBinder().linkToDeath(adr, <span class="number">0</span>);</span><br><span class="line">          app.deathRecipient = adr;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">          app.resetPackageList(mProcessStats);</span><br><span class="line">          startProcessLocked(app, <span class="string">&quot;link fail&quot;</span>, processName);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);</span><br><span class="line"></span><br><span class="line">      app.makeActive(thread, mProcessStats);</span><br><span class="line">      app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">      app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">      app.forcingToImportant = <span class="keyword">null</span>;</span><br><span class="line">      updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">      app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">      app.debugging = <span class="keyword">false</span>;</span><br><span class="line">      app.cached = <span class="keyword">false</span>;</span><br><span class="line">      app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">      app.killed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// We carefully use the same state that PackageManager uses for</span></span><br><span class="line">      <span class="comment">// filtering, since we use this flag to decide if we need to install</span></span><br><span class="line">      <span class="comment">// providers when user is unlocked later</span></span><br><span class="line">      app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);</span><br><span class="line"></span><br><span class="line">      mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line"><span class="comment">//mProcessesReady这个变量在AMS的 systemReady 中被赋值为true，</span></span><br><span class="line"> 	 	<span class="comment">//所以这里的normalMode也为true</span></span><br><span class="line">      <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line">      List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (providers != <span class="keyword">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</span><br><span class="line">          Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</span><br><span class="line">          msg.obj = app;</span><br><span class="line">          mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      checkTime(startTime, <span class="string">&quot;attachApplicationLocked: before bindApplication&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!normalMode) &#123;</span><br><span class="line">          Slog.i(TAG, <span class="string">&quot;Launching preboot mode app: &quot;</span> + app);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">          TAG, <span class="string">&quot;New app record &quot;</span> + app</span><br><span class="line">          + <span class="string">&quot; thread=&quot;</span> + thread.asBinder() + <span class="string">&quot; pid=&quot;</span> + pid);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> testMode = ApplicationThreadConstants.DEBUG_OFF;</span><br><span class="line">          <span class="keyword">if</span> (mDebugApp != <span class="keyword">null</span> &amp;&amp; mDebugApp.equals(processName)) &#123;</span><br><span class="line">              testMode = mWaitForDebugger</span><br><span class="line">                  ? ApplicationThreadConstants.DEBUG_WAIT</span><br><span class="line">                  : ApplicationThreadConstants.DEBUG_ON;</span><br><span class="line">              app.debugging = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">if</span> (mDebugTransient) &#123;</span><br><span class="line">                  mDebugApp = mOrigDebugApp;</span><br><span class="line">                  mWaitForDebugger = mOrigWaitForDebugger;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">boolean</span> enableTrackAllocation = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">if</span> (mTrackAllocationApp != <span class="keyword">null</span> &amp;&amp; mTrackAllocationApp.equals(processName)) &#123;</span><br><span class="line">              enableTrackAllocation = <span class="keyword">true</span>;</span><br><span class="line">              mTrackAllocationApp = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If the app is being launched for restore or full backup, set it up specially</span></span><br><span class="line">          <span class="keyword">boolean</span> isRestrictedBackupMode = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">if</span> (mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupAppName.equals(processName)) &#123;</span><br><span class="line">              isRestrictedBackupMode = mBackupTarget.appInfo.uid &gt;= FIRST_APPLICATION_UID</span><br><span class="line">                      &amp;&amp; ((mBackupTarget.backupMode == BackupRecord.RESTORE)</span><br><span class="line">                              || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL)</span><br><span class="line">                              || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL));</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (app.instr != <span class="keyword">null</span>) &#123;</span><br><span class="line">              notifyPackageUse(app.instr.mClass.getPackageName(),</span><br><span class="line">                               PackageManager.NOTIFY_PACKAGE_USE_INSTRUMENTATION);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, <span class="string">&quot;Binding proc &quot;</span></span><br><span class="line">                  + processName + <span class="string">&quot; with config &quot;</span> + getGlobalConfiguration());</span><br><span class="line">          ApplicationInfo appInfo = app.instr != <span class="keyword">null</span> ? app.instr.mTargetInfo : app.info;</span><br><span class="line">          app.compat = compatibilityInfoForPackageLocked(appInfo);</span><br><span class="line"></span><br><span class="line">          ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">          String preBindAgent = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">if</span> (mProfileApp != <span class="keyword">null</span> &amp;&amp; mProfileApp.equals(processName)) &#123;</span><br><span class="line">              mProfileProc = app;</span><br><span class="line">              <span class="keyword">if</span> (mProfilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="comment">// Send a profiler info object to the app if either a file is given, or</span></span><br><span class="line">                  <span class="comment">// an agent should be loaded at bind-time.</span></span><br><span class="line">                  <span class="keyword">boolean</span> needsInfo = mProfilerInfo.profileFile != <span class="keyword">null</span></span><br><span class="line">                          || mProfilerInfo.attachAgentDuringBind;</span><br><span class="line">                  profilerInfo = needsInfo ? <span class="keyword">new</span> ProfilerInfo(mProfilerInfo) : <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">if</span> (mProfilerInfo.agent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      preBindAgent = mProfilerInfo.agent;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instr != <span class="keyword">null</span> &amp;&amp; app.instr.mProfileFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">              profilerInfo = <span class="keyword">new</span> ProfilerInfo(app.instr.mProfileFile, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                      <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (mAppAgentMap != <span class="keyword">null</span> &amp;&amp; mAppAgentMap.containsKey(processName)) &#123;</span><br><span class="line">              <span class="comment">// We need to do a debuggable check here. See setAgentApp for why the check is</span></span><br><span class="line">              <span class="comment">// postponed to here.</span></span><br><span class="line">              <span class="keyword">if</span> ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>) &#123;</span><br><span class="line">                  String agent = mAppAgentMap.get(processName);</span><br><span class="line">                  <span class="comment">// Do not overwrite already requested agent.</span></span><br><span class="line">                  <span class="keyword">if</span> (profilerInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      profilerInfo = <span class="keyword">new</span> ProfilerInfo(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                              mAppAgentMap.get(processName), <span class="keyword">true</span>);</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (profilerInfo.agent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      profilerInfo = profilerInfo.setAgent(mAppAgentMap.get(processName), <span class="keyword">true</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span> &amp;&amp; profilerInfo.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">              profilerInfo.profileFd = profilerInfo.profileFd.dup();</span><br><span class="line">              <span class="keyword">if</span> (TextUtils.equals(mProfileApp, processName) &amp;&amp; mProfilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  clearProfilerLocked();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// We deprecated Build.SERIAL and it is not accessible to</span></span><br><span class="line">          <span class="comment">// apps that target the v2 security sandbox and to apps that</span></span><br><span class="line">          <span class="comment">// target APIs higher than O MR1. Since access to the serial</span></span><br><span class="line">          <span class="comment">// is now behind a permission we push down the value.</span></span><br><span class="line">          <span class="keyword">final</span> String buildSerial = (appInfo.targetSandboxVersion &lt; <span class="number">2</span></span><br><span class="line">                  &amp;&amp; appInfo.targetSdkVersion &lt; Build.VERSION_CODES.P)</span><br><span class="line">                          ? sTheRealBuildSerial : Build.UNKNOWN;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Check if this is a secondary process that should be incorporated into some</span></span><br><span class="line">          <span class="comment">// currently active instrumentation.  (Note we do this AFTER all of the profiling</span></span><br><span class="line">          <span class="comment">// stuff above because profiling can currently happen only in the primary</span></span><br><span class="line">          <span class="comment">// instrumentation process.)</span></span><br><span class="line">          <span class="keyword">if</span> (mActiveInstrumentation.size() &gt; <span class="number">0</span> &amp;&amp; app.instr == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = mActiveInstrumentation.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; app.instr == <span class="keyword">null</span>; i--) &#123;</span><br><span class="line">                  ActiveInstrumentation aInstr = mActiveInstrumentation.get(i);</span><br><span class="line">                  <span class="keyword">if</span> (!aInstr.mFinished &amp;&amp; aInstr.mTargetInfo.uid == app.uid) &#123;</span><br><span class="line">                      <span class="keyword">if</span> (aInstr.mTargetProcesses.length == <span class="number">0</span>) &#123;</span><br><span class="line">                          <span class="comment">// This is the wildcard mode, where every process brought up for</span></span><br><span class="line">                          <span class="comment">// the target instrumentation should be included.</span></span><br><span class="line">                          <span class="keyword">if</span> (aInstr.mTargetInfo.packageName.equals(app.info.packageName)) &#123;</span><br><span class="line">                              app.instr = aInstr;</span><br><span class="line">                              aInstr.mRunningProcesses.add(app);</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                          <span class="keyword">for</span> (String proc : aInstr.mTargetProcesses) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (proc.equals(app.processName)) &#123;</span><br><span class="line">                                  app.instr = aInstr;</span><br><span class="line">                                  aInstr.mRunningProcesses.add(app);</span><br><span class="line">                                  <span class="keyword">break</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If we were asked to attach an agent on startup, do so now, before we&#x27;re binding</span></span><br><span class="line">          <span class="comment">// application code.</span></span><br><span class="line">          <span class="keyword">if</span> (preBindAgent != <span class="keyword">null</span>) &#123;</span><br><span class="line">              thread.attachAgent(preBindAgent);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="comment">// Figure out whether the app needs to run in autofill compat mode.</span></span><br><span class="line">          <span class="keyword">boolean</span> isAutofillCompatEnabled = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">if</span> (UserHandle.getAppId(app.info.uid) &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">              <span class="keyword">final</span> AutofillManagerInternal afm = LocalServices.getService(</span><br><span class="line">                      AutofillManagerInternal.class);</span><br><span class="line">              <span class="keyword">if</span> (afm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  isAutofillCompatEnabled = afm.isCompatibilityModeRequested(</span><br><span class="line">                          app.info.packageName, app.info.versionCode, app.userId);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          checkTime(startTime, <span class="string">&quot;attachApplicationLocked: immediately before bindApplication&quot;</span>);</span><br><span class="line">          mStackSupervisor.getActivityMetricsLogger().notifyBindApplication(app);</span><br><span class="line">          <span class="keyword">if</span> (app.isolatedEntryPoint != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// This is an isolated process which should just call an entry point instead of</span></span><br><span class="line">              <span class="comment">// being bound to an application.</span></span><br><span class="line">              thread.runIsolatedEntryPoint(app.isolatedEntryPoint, app.isolatedEntryPointArgs);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instr != <span class="keyword">null</span>) &#123;</span><br><span class="line">              thread.bindApplication(processName, appInfo, providers,</span><br><span class="line">                      app.instr.mClass,</span><br><span class="line">                      profilerInfo, app.instr.mArguments,</span><br><span class="line">                      app.instr.mWatcher,</span><br><span class="line">                      app.instr.mUiAutomationConnection, testMode,</span><br><span class="line">                      mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                      isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                      <span class="keyword">new</span> Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                      getCommonServicesLocked(app.isolated),</span><br><span class="line">                      mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                      buildSerial, isAutofillCompatEnabled);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              thread.bindApplication(processName, appInfo, providers, <span class="keyword">null</span>, profilerInfo,</span><br><span class="line">                      <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, testMode,</span><br><span class="line">                      mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                      isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                      <span class="keyword">new</span> Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                      getCommonServicesLocked(app.isolated),</span><br><span class="line">                      mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                      buildSerial, isAutofillCompatEnabled);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">              profilerInfo.closeFd();</span><br><span class="line">              profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          checkTime(startTime, <span class="string">&quot;attachApplicationLocked: immediately after bindApplication&quot;</span>);</span><br><span class="line">          updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">          checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after updateLruProcessLocked&quot;</span>);</span><br><span class="line">          app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="comment">// todo: Yikes!  What should we do?  For now we will try to</span></span><br><span class="line">          <span class="comment">// start another process, but that could easily get us in</span></span><br><span class="line">          <span class="comment">// an infinite loop of restarting processes...</span></span><br><span class="line">          Slog.wtf(TAG, <span class="string">&quot;Exception thrown during bind of &quot;</span> + app, e);</span><br><span class="line"></span><br><span class="line">          app.resetPackageList(mProcessStats);</span><br><span class="line">          app.unlinkDeathRecipient();</span><br><span class="line">          startProcessLocked(app, <span class="string">&quot;bind fail&quot;</span>, processName);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remove this record from the list of starting applications.</span></span><br><span class="line">      mPersistentStartingProcesses.remove(app);</span><br><span class="line">      <span class="keyword">if</span> (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</span><br><span class="line">              <span class="string">&quot;Attach application locked removing on hold: &quot;</span> + app);</span><br><span class="line">      mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">      <span class="comment">//上面说到，这里为true，进入StackSupervisor的attachApplication方法</span></span><br><span class="line">  	<span class="comment">//去真正启动Activity</span></span><br><span class="line">      <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                  didSomething = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              Slog.wtf(TAG, <span class="string">&quot;Exception thrown launching activities in &quot;</span> + app, e);</span><br><span class="line">              badApp = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Find any services that should be running in this process...</span></span><br><span class="line">      <span class="keyword">if</span> (!badApp) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">              checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after mServices.attachApplicationLocked&quot;</span>);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              Slog.wtf(TAG, <span class="string">&quot;Exception thrown starting services in &quot;</span> + app, e);</span><br><span class="line">              badApp = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check if a next-broadcast receiver is in this process...</span></span><br><span class="line">      <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              didSomething |= sendPendingBroadcastsLocked(app);</span><br><span class="line">              checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after sendPendingBroadcastsLocked&quot;</span>);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              <span class="comment">// If the app died trying to launch the receiver we declare it &#x27;bad&#x27;</span></span><br><span class="line">              Slog.wtf(TAG, <span class="string">&quot;Exception thrown dispatching broadcasts in &quot;</span> + app, e);</span><br><span class="line">              badApp = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check whether the next backup agent is in this process...</span></span><br><span class="line">      <span class="keyword">if</span> (!badApp &amp;&amp; mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupTarget.app == app) &#123;</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_BACKUP) Slog.v(TAG_BACKUP,</span><br><span class="line">                  <span class="string">&quot;New app is backup target, launching agent for &quot;</span> + app);</span><br><span class="line">          notifyPackageUse(mBackupTarget.appInfo.packageName,</span><br><span class="line">                           PackageManager.NOTIFY_PACKAGE_USE_BACKUP);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,</span><br><span class="line">                      compatibilityInfoForPackageLocked(mBackupTarget.appInfo),</span><br><span class="line">                      mBackupTarget.backupMode);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              Slog.wtf(TAG, <span class="string">&quot;Exception thrown creating backup agent in &quot;</span> + app, e);</span><br><span class="line">              badApp = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (badApp) &#123;</span><br><span class="line">          app.kill(<span class="string">&quot;error during init&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">          handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">          updateOomAdjLocked();</span><br><span class="line">          checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after updateOomAdjLocked&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;<span class="comment">//启动的进程名称</span></span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityDisplay display = mActivityDisplays.valueAt(displayNdx);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = display.getChildCount() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = display.getChildAt(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (!isFocusedStack(stack)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            stack.getAllRunningVisibleActivitiesLocked(mTmpActivityList);</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord top = stack.topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> size = mTmpActivityList.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityRecord activity = mTmpActivityList.get(i);</span><br><span class="line">                <span class="keyword">if</span> (activity.app == <span class="keyword">null</span> &amp;&amp; app.uid == activity.info.applicationInfo.uid</span><br><span class="line">                        &amp;&amp; processName.equals(activity.processName)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (realStartActivityLocked(activity, app,</span><br><span class="line">                                top == activity <span class="comment">/* andResume */</span>, <span class="keyword">true</span> <span class="comment">/* checkConfig */</span>)) &#123;</span><br><span class="line">                            didSomething = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;Exception in new application when starting activity &quot;</span></span><br><span class="line">                                + top.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">                        <span class="keyword">throw</span> e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">		 <span class="comment">// 直到所有的 onPause() 执行结束才会去启动新的 activity</span></span><br><span class="line">        <span class="keyword">if</span> (!allPausedActivitiesComplete()) &#123;</span><br><span class="line">            <span class="comment">// While there are activities pausing we skipping starting any new activities until</span></span><br><span class="line">            <span class="comment">// pauses are complete. <span class="doctag">NOTE:</span> that we also do this for activities that are starting in</span></span><br><span class="line">            <span class="comment">// the paused state because they will first be resumed then paused on the client side.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_PAUSE || DEBUG_STATES) Slog.v(TAG_PAUSE,</span><br><span class="line">                    <span class="string">&quot;realStartActivityLocked: Skipping start of r=&quot;</span> + r</span><br><span class="line">                    + <span class="string">&quot; some activities pausing...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = r.getTask();</span><br><span class="line">        <span class="keyword">final</span> ActivityStack stack = task.getStack();</span><br><span class="line"></span><br><span class="line">        beginDeferResume();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">            r.startLaunchTickingLocked();</span><br><span class="line"></span><br><span class="line">            r.setProcess(app);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getKeyguardController().isKeyguardLocked()) &#123;</span><br><span class="line">                r.notifyUnknownVisibilityLaunched();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Have the window manager re-evaluate the orientation of the screen based on the new</span></span><br><span class="line">            <span class="comment">// activity order.  Note that as a result of this, it can call back into the activity</span></span><br><span class="line">            <span class="comment">// manager with a new orientation.  We don&#x27;t care about that, because the activity is</span></span><br><span class="line">            <span class="comment">// not currently running so we are just restarting it anyway.</span></span><br><span class="line">            <span class="keyword">if</span> (checkConfig) &#123;</span><br><span class="line">                <span class="comment">// Deferring resume here because we&#x27;re going to launch new activity shortly.</span></span><br><span class="line">                <span class="comment">// We don&#x27;t want to perform a redundant launch of the same record while ensuring</span></span><br><span class="line">                <span class="comment">// configurations and trying to resume top activity of focused stack.</span></span><br><span class="line">                ensureVisibilityAndConfig(r, r.getDisplayId(),</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* markFrozenIfConfigChanged */</span>, <span class="keyword">true</span> <span class="comment">/* deferResume */</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r.getStack().checkKeyguardVisibility(r, <span class="keyword">true</span> <span class="comment">/* shouldBeVisible */</span>,</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/* isTop */</span>)) &#123;</span><br><span class="line">                <span class="comment">// We only set the visibility to true if the activity is allowed to be visible</span></span><br><span class="line">                <span class="comment">// based on</span></span><br><span class="line">                <span class="comment">// keyguard state. This avoids setting this into motion in window manager that is</span></span><br><span class="line">                <span class="comment">// later cancelled due to later calls to ensure visible activities that set</span></span><br><span class="line">                <span class="comment">// visibility back to false.</span></span><br><span class="line">                r.setVisibility(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> applicationInfoUid =</span><br><span class="line">                    (r.info.applicationInfo != <span class="keyword">null</span>) ? r.info.applicationInfo.uid : -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ((r.userId != app.userId) || (r.appInfo.uid != applicationInfoUid)) &#123;</span><br><span class="line">                Slog.wtf(TAG,</span><br><span class="line">                        <span class="string">&quot;User ID for activity changing for &quot;</span> + r</span><br><span class="line">                                + <span class="string">&quot; appInfo.uid=&quot;</span> + r.appInfo.uid</span><br><span class="line">                                + <span class="string">&quot; info.ai.uid=&quot;</span> + applicationInfoUid</span><br><span class="line">                                + <span class="string">&quot; old=&quot;</span> + r.app + <span class="string">&quot; new=&quot;</span> + app);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            app.waitingToKill = <span class="keyword">null</span>;</span><br><span class="line">            r.launchCount++;</span><br><span class="line">            r.lastLaunchTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ALL) Slog.v(TAG, <span class="string">&quot;Launching: &quot;</span> + r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> idx = app.activities.indexOf(r);</span><br><span class="line">            <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                app.activities.add(r);</span><br><span class="line">            &#125;</span><br><span class="line">            mService.updateLruProcessLocked(app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">            mService.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> LockTaskController lockTaskController = mService.getLockTaskController();</span><br><span class="line">            <span class="keyword">if</span> (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE</span><br><span class="line">                    || task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV</span><br><span class="line">                    || (task.mLockTaskAuth == LOCK_TASK_AUTH_WHITELISTED</span><br><span class="line">                            &amp;&amp; lockTaskController.getLockTaskModeState()</span><br><span class="line">                                    == LOCK_TASK_MODE_LOCKED)) &#123;</span><br><span class="line">                lockTaskController.startLockTaskMode(task, <span class="keyword">false</span>, <span class="number">0</span> <span class="comment">/* blank UID */</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</span><br><span class="line">                List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                    <span class="comment">// We don&#x27;t need to deliver new intents and/or set results if activity is going</span></span><br><span class="line">                    <span class="comment">// to pause immediately after launch.</span></span><br><span class="line">                    results = r.results;</span><br><span class="line">                    newIntents = r.newIntents;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH,</span><br><span class="line">                        <span class="string">&quot;Launching: &quot;</span> + r + <span class="string">&quot; icicle=&quot;</span> + r.icicle + <span class="string">&quot; with results=&quot;</span> + results</span><br><span class="line">                                + <span class="string">&quot; newIntents=&quot;</span> + newIntents + <span class="string">&quot; andResume=&quot;</span> + andResume);</span><br><span class="line">                EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY, r.userId,</span><br><span class="line">                        System.identityHashCode(r), task.taskId, r.shortComponentName);</span><br><span class="line">                <span class="keyword">if</span> (r.isActivityTypeHome()) &#123;</span><br><span class="line">                    <span class="comment">// Home process is the root process of the task.</span></span><br><span class="line">                    mService.mHomeProcess = task.mActivities.get(<span class="number">0</span>).app;</span><br><span class="line">                &#125;</span><br><span class="line">                mService.notifyPackageUse(r.intent.getComponent().getPackageName(),</span><br><span class="line">                        PackageManager.NOTIFY_PACKAGE_USE_ACTIVITY);</span><br><span class="line">                r.sleeping = <span class="keyword">false</span>;</span><br><span class="line">                r.forceNewConfig = <span class="keyword">false</span>;</span><br><span class="line">                mService.getAppWarningsLocked().onStartActivity(r);</span><br><span class="line">                mService.showAskCompatModeDialogLocked(r);</span><br><span class="line">                r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</span><br><span class="line">                ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (mService.mProfileApp != <span class="keyword">null</span> &amp;&amp; mService.mProfileApp.equals(app.processName)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mService.mProfileProc == <span class="keyword">null</span> || mService.mProfileProc == app) &#123;</span><br><span class="line">                        mService.mProfileProc = app;</span><br><span class="line">                        ProfilerInfo profilerInfoSvc = mService.mProfilerInfo;</span><br><span class="line">                        <span class="keyword">if</span> (profilerInfoSvc != <span class="keyword">null</span> &amp;&amp; profilerInfoSvc.profileFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (profilerInfoSvc.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    profilerInfoSvc.profileFd = profilerInfoSvc.profileFd.dup();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                    profilerInfoSvc.closeFd();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            profilerInfo = <span class="keyword">new</span> ProfilerInfo(profilerInfoSvc);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                app.hasShownUi = <span class="keyword">true</span>;</span><br><span class="line">                app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line">                app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line">                <span class="comment">// Because we could be starting an Activity in the system process this may not go</span></span><br><span class="line">                <span class="comment">// across a Binder interface which would create a new Configuration. Consequently</span></span><br><span class="line">                <span class="comment">// we have to always create a new Configuration here.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> MergedConfiguration mergedConfiguration = <span class="keyword">new</span> MergedConfiguration(</span><br><span class="line">                        mService.getGlobalConfiguration(), r.getMergedOverrideConfiguration());</span><br><span class="line">                r.setLastReportedConfiguration(mergedConfiguration);</span><br><span class="line"></span><br><span class="line">                logIfTransactionTooLarge(r.intent, r.icicle);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Create activity launch transaction.</span></span><br><span class="line">                <span class="keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(app.thread,</span><br><span class="line">                        r.appToken);</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                        <span class="comment">// and override configs.</span></span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">                        r.persistentState, results, newIntents, mService.isNextTransitionForward(),</span><br><span class="line">                        profilerInfo));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set desired final state.</span></span><br><span class="line">                <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">                <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                    lifecycleItem = ResumeActivityItem.obtain(mService.isNextTransitionForward());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">                &#125;</span><br><span class="line">                clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Schedule transaction.</span></span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((app.info.privateFlags &amp; ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span></span><br><span class="line">                        &amp;&amp; mService.mHasHeavyWeightFeature) &#123;</span><br><span class="line">                    <span class="comment">// This may be a heavy-weight process!  Note that the package</span></span><br><span class="line">                    <span class="comment">// manager will ensure that only activity can run in the main</span></span><br><span class="line">                    <span class="comment">// process of the .apk, which is the only thing that will be</span></span><br><span class="line">                    <span class="comment">// considered heavy-weight.</span></span><br><span class="line">                    <span class="keyword">if</span> (app.processName.equals(app.info.packageName)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; mService.mHeavyWeightProcess != app) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">&quot;Starting new heavy weight process &quot;</span> + app</span><br><span class="line">                                    + <span class="string">&quot; when already running &quot;</span></span><br><span class="line">                                    + mService.mHeavyWeightProcess);</span><br><span class="line">                        &#125;</span><br><span class="line">                        mService.mHeavyWeightProcess = app;</span><br><span class="line">                        Message msg = mService.mHandler.obtainMessage(</span><br><span class="line">                                ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);</span><br><span class="line">                        msg.obj = r;</span><br><span class="line">                        mService.mHandler.sendMessage(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.launchFailed) &#123;</span><br><span class="line">                    <span class="comment">// This is the second time we failed -- finish activity</span></span><br><span class="line">                    <span class="comment">// and give up.</span></span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Second failure launching &quot;</span></span><br><span class="line">                            + r.intent.getComponent().flattenToShortString()</span><br><span class="line">                            + <span class="string">&quot;, giving up&quot;</span>, e);</span><br><span class="line">                    mService.appDiedLocked(app);</span><br><span class="line">                    stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="string">&quot;2nd-crash&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// This is the first time we failed -- restart process and</span></span><br><span class="line">                <span class="comment">// retry.</span></span><br><span class="line">                r.launchFailed = <span class="keyword">true</span>;</span><br><span class="line">                app.activities.remove(r);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            endDeferResume();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.launchFailed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (stack.updateLRUListLocked(r)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Activity &quot;</span> + r + <span class="string">&quot; being launched, but already in LRU list&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO(lifecycler): Resume or pause requests are done as part of launch transaction,</span></span><br><span class="line">        <span class="comment">// so updating the state should be done accordingly.</span></span><br><span class="line">        <span class="keyword">if</span> (andResume &amp;&amp; readyToResume()) &#123;</span><br><span class="line">            <span class="comment">// As part of the process of launching, ActivityThread also performs</span></span><br><span class="line">            <span class="comment">// a resume.</span></span><br><span class="line">            stack.minimalResumeActivityLocked(r);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This activity is not starting in the resumed state... which should look like we asked</span></span><br><span class="line">            <span class="comment">// it to pause+stop (but remain visible), and it has done so and reported back the</span></span><br><span class="line">            <span class="comment">// current icicle and other state.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES,</span><br><span class="line">                    <span class="string">&quot;Moving to PAUSED: &quot;</span> + r + <span class="string">&quot; (starting in paused state)&quot;</span>);</span><br><span class="line">            r.setState(PAUSED, <span class="string">&quot;realStartActivityLocked&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Launch the new version setup screen if needed.  We do this -after-</span></span><br><span class="line">        <span class="comment">// launching the initial activity (that is, home), so that it can have</span></span><br><span class="line">        <span class="comment">// a chance to initialize itself while in the background, making the</span></span><br><span class="line">        <span class="comment">// switch back to it faster and look better.</span></span><br><span class="line">        <span class="keyword">if</span> (isFocusedStack(stack)) &#123;</span><br><span class="line">            mService.getActivityStartController().startSetupActivity();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update any services we are bound to that might care about whether</span></span><br><span class="line">        <span class="comment">// their client may have activities.</span></span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mService.mServices.updateServiceConnectionActivitiesLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule a transaction, which may consist of multiple callbacks and a lifecycle request.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transaction A sequence of client transaction items.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RemoteException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ClientTransaction</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> IApplicationThread client = transaction.getClient();<span class="comment">//这个是获取到IApplicationThread的代理对象</span></span><br><span class="line">        transaction.schedule();</span><br><span class="line">        <span class="keyword">if</span> (!(client <span class="keyword">instanceof</span> Binder)) &#123;</span><br><span class="line">            <span class="comment">// If client is not an instance of Binder - it&#x27;s a remote call and at this point it is</span></span><br><span class="line">            <span class="comment">// safe to recycle the object. All objects used for local calls will be recycled after</span></span><br><span class="line">            <span class="comment">// the transaction is executed on client in ActivityThread.</span></span><br><span class="line">            transaction.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * Schedule the transaction after it was initialized. It will be send to client and all its</span><br><span class="line">     * individual parts will be applied in the following sequence:</span><br><span class="line">     * 1. The client calls &#123;@link #preExecute(ClientTransactionHandler)&#125;, which triggers all work</span><br><span class="line">     *    that needs to be done before actually scheduling the transaction for callbacks and</span><br><span class="line">     *    lifecycle state request.</span><br><span class="line">     * 2. The transaction message is scheduled.</span><br><span class="line">     * 3. The client calls &#123;@link TransactionExecutor#execute(ClientTransaction)&#125;, which executes</span><br><span class="line">     *    all callbacks and necessary lifecycle transitions.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void schedule() throws RemoteException &#123;</span><br><span class="line">        mClient.scheduleTransaction(this);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            ActivityThread.<span class="keyword">this</span>.scheduleTransaction(transaction);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>调用ClientTransactionHandler的scheduleTransaction方法，并发送msg给H，H接收消息并进程处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Prepare and schedule transaction for execution. */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        transaction.preExecute(<span class="keyword">this</span>);</span><br><span class="line">        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在H中：</span></span><br><span class="line"><span class="keyword">case</span> EXECUTE_TRANSACTION:</span><br><span class="line">    <span class="keyword">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;</span><br><span class="line">    mTransactionExecutor.execute(transaction);</span><br><span class="line">    <span class="keyword">if</span> (isSystem()) &#123;</span><br><span class="line">        <span class="comment">// Client transactions inside system process are recycled on the client side</span></span><br><span class="line">        <span class="comment">// instead of ClientLifecycleManager to avoid being cleared before this</span></span><br><span class="line">        <span class="comment">// message is handled.</span></span><br><span class="line">        transaction.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolve transaction.</span></span><br><span class="line"><span class="comment">     * First all callbacks will be executed in the order they appear in the list. If a callback</span></span><br><span class="line"><span class="comment">     * requires a certain pre- or post-execution state, the client will be transitioned accordingly.</span></span><br><span class="line"><span class="comment">     * Then the client will cycle to the final lifecycle state if provided. Otherwise, it will</span></span><br><span class="line"><span class="comment">     * either remain in the initial state, or last state needed by a callback.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> IBinder token = transaction.getActivityToken();</span><br><span class="line">        log(<span class="string">&quot;Start resolving transaction for client: &quot;</span> + mTransactionHandler + <span class="string">&quot;, token: &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">        executeCallbacks(transaction);</span><br><span class="line"></span><br><span class="line">        executeLifecycleState(transaction);</span><br><span class="line">        mPendingActions.clear();</span><br><span class="line">        log(<span class="string">&quot;End resolving transaction&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeCallbacks</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;ClientTransactionItem&gt; callbacks = transaction.getCallbacks();</span><br><span class="line">        <span class="keyword">if</span> (callbacks == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No callbacks to execute, return early.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log(<span class="string">&quot;Resolving callbacks&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> IBinder token = transaction.getActivityToken();</span><br><span class="line">        ActivityClientRecord r = mTransactionHandler.getActivityClient(token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In case when post-execution state of the last callback matches the final state requested</span></span><br><span class="line">        <span class="comment">// for the activity in this transaction, we won&#x27;t do the last transition here and do it when</span></span><br><span class="line">        <span class="comment">// moving to final state instead (because it may contain additional parameters from server).</span></span><br><span class="line">        <span class="keyword">final</span> ActivityLifecycleItem finalStateRequest = transaction.getLifecycleStateRequest();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> finalState = finalStateRequest != <span class="keyword">null</span> ? finalStateRequest.getTargetState()</span><br><span class="line">                : UNDEFINED;</span><br><span class="line">        <span class="comment">// Index of the last callback that requests some post-execution state.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> lastCallbackRequestingState = lastCallbackRequestingState(transaction);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> size = callbacks.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">            <span class="keyword">final</span> ClientTransactionItem item = callbacks.get(i);</span><br><span class="line">            log(<span class="string">&quot;Resolving callback: &quot;</span> + item);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> postExecutionState = item.getPostExecutionState();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> closestPreExecutionState = mHelper.getClosestPreExecutionState(r,</span><br><span class="line">                    item.getPostExecutionState());</span><br><span class="line">            <span class="keyword">if</span> (closestPreExecutionState != UNDEFINED) &#123;</span><br><span class="line">                cycleToPath(r, closestPreExecutionState);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            item.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">            item.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Launch activity request will create an activity record.</span></span><br><span class="line">                r = mTransactionHandler.getActivityClient(token);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (postExecutionState != UNDEFINED &amp;&amp; r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Skip the very last transition and perform it by explicit state request instead.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> shouldExcludeLastTransition =</span><br><span class="line">                        i == lastCallbackRequestingState &amp;&amp; finalState == postExecutionState;</span><br><span class="line">                cycleToPath(r, postExecutionState, shouldExcludeLastTransition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>调用LaunchActivityItem：item.execute(mTransactionHandler, token, mPendingActions);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityStart&quot;</span>);</span><br><span class="line">        ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord(token, mIntent, mIdent, mInfo,</span><br><span class="line">                mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,</span><br><span class="line">                mPendingResults, mPendingNewIntents, mIsForward,</span><br><span class="line">                mProfilerInfo, client);</span><br><span class="line">        client.handleLaunchActivity(r, pendingActions, <span class="keyword">null</span> <span class="comment">/* customIntent */</span>);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最终进入到ActivityThread的handleLaunchActivity：开始走activity的生命周期（启动activity，加载并显示界面—&gt;UI的绘制流程）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Activity <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">        <span class="comment">// we are back active so skip it.</span></span><br><span class="line">        unscheduleGcIdler();</span><br><span class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mProfiler.setProfiler(r.profilerInfo);</span><br><span class="line">            mProfiler.startProfiling();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure we are running with the most recent config.</span></span><br><span class="line">        handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">            TAG, <span class="string">&quot;Handling launch of &quot;</span> + r);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize before creating the activity</span></span><br><span class="line">        <span class="keyword">if</span> (!ThreadedRenderer.sRendererDisabled) &#123;</span><br><span class="line">            GraphicsEnvironment.earlyInitEGL();</span><br><span class="line">        &#125;</span><br><span class="line">        WindowManagerGlobal.initialize();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">            reportSizeConfigurations(r);</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; pendingActions != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pendingActions.setOldState(r.state);</span><br><span class="line">                pendingActions.setRestoreInstanceState(<span class="keyword">true</span>);</span><br><span class="line">                pendingActions.setCallOnPostCreate(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If there was an error, for any reason, tell the activity manager to stop us.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManager.getService()</span><br><span class="line">                        .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                                Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">SongSong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2020/11/12/AMS-04-%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">http://example.com/2020/11/12/AMS-04-%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/android/">android</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/12/AMS-05-HookActivity/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">AMS-05-HookActivity</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/10/AMS-03-%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">AMS-03-车载模块应用启动流程（Launcher--&gt;AMS--&gt;zygote）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/10/04/CustomizeView-04/" title="动态换肤原理分析"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg2.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-04</div><div class="title">动态换肤原理分析</div></div></a></div><div><a href="/2020/09/30/CustomizeView/" title="CustomizeView"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg2.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-30</div><div class="title">CustomizeView</div></div></a></div><div><a href="/2020/10/02/CustomizeView-03/" title="View树创建流程分析"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg3.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-02</div><div class="title">View树创建流程分析</div></div></a></div><div><a href="/2020/10/14/Context理解/" title="Context理解"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-14</div><div class="title">Context理解</div></div></a></div><div><a href="/2020/10/13/ViewLayout/" title="View绘制流程分析"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-13</div><div class="title">View绘制流程分析</div></div></a></div><div><a href="/2020/10/16/binder_reg_jni/" title="binder的jni函数注册"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-16</div><div class="title">binder的jni函数注册</div></div></a></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By SongSong</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="http://makediffrencesong.github.io/">blog</a>!</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>