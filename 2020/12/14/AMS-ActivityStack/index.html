<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AMS-ActivityStack | Make a difference</title><meta name="keywords" content="android"><meta name="author" content="SongSong"><meta name="copyright" content="SongSong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="ActivityRecord1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969">
<meta property="og:type" content="article">
<meta property="og:title" content="AMS-ActivityStack">
<meta property="og:url" content="http://example.com/2020/12/14/AMS-ActivityStack/index.html">
<meta property="og:site_name" content="Make a difference">
<meta property="og:description" content="ActivityRecord1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2020-12-14T07:00:38.000Z">
<meta property="article:modified_time" content="2020-12-14T12:16:44.897Z">
<meta property="article:author" content="SongSong">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/12/14/AMS-ActivityStack/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-12-14 20:16:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Make a difference" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/friend.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">56</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ActivityRecord"><span class="toc-number">1.</span> <span class="toc-text">ActivityRecord</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TaskRecord"><span class="toc-number">2.</span> <span class="toc-text">TaskRecord</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ActivityStack"><span class="toc-number">3.</span> <span class="toc-text">ActivityStack</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ActivityDisplay"><span class="toc-number">4.</span> <span class="toc-text">ActivityDisplay</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ActivityContainer"><span class="toc-number">5.</span> <span class="toc-text">ActivityContainer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ActivityStackSupervisor"><span class="toc-number">6.</span> <span class="toc-text">ActivityStackSupervisor</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ProcessRecord"><span class="toc-number">7.</span> <span class="toc-text">ProcessRecord</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E5%85%B3%E7%B3%BB"><span class="toc-number">8.</span> <span class="toc-text">整体关系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%8D%9A%E5%AE%A2"><span class="toc-number">9.</span> <span class="toc-text">参考博客</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Make a difference</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">AMS-ActivityStack</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-12-14T07:00:38.000Z" title="Created 2020-12-14 15:00:38">2020-12-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-12-14T12:16:44.897Z" title="Updated 2020-12-14 20:16:44">2020-12-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AMS/">AMS</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><img src="/images/AMS-ActivityStack/v2-86a554a0bbecdf13fa70feaa373bf164_720w.jpg" alt="img"></p>
<p><img src="/images/AMS-ActivityStack/19954663-236fc1f056295414.jpg" alt="img"></p>
<h1 id="ActivityRecord"><a href="#ActivityRecord" class="headerlink" title="ActivityRecord"></a>ActivityRecord</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ActivityManagerService service; <span class="comment">// owner</span></span><br><span class="line"><span class="keyword">final</span> IApplicationToken.Stub appToken; <span class="comment">// window manager token</span></span><br><span class="line">AppWindowContainerController mWindowContainerController;</span><br><span class="line"><span class="keyword">final</span> ActivityInfo info; <span class="comment">// all about me</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> This is duplicated state already contained in info.applicationInfo - remove</span></span><br><span class="line">ApplicationInfo appInfo; <span class="comment">// information about activity&#x27;s app</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> launchedFromPid; <span class="comment">// always the pid who started the activity.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> launchedFromUid; <span class="comment">// always the uid who started the activity.</span></span><br><span class="line"><span class="keyword">final</span> String launchedFromPackage; <span class="comment">// always the package who started the activity.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> userId;          <span class="comment">// Which user is this running for?</span></span><br><span class="line"><span class="keyword">final</span> Intent intent;    <span class="comment">// the original intent that generated us</span></span><br><span class="line"><span class="keyword">final</span> ComponentName realActivity;  <span class="comment">// the intent component, or target of an alias.</span></span><br><span class="line"><span class="keyword">final</span> String shortComponentName; <span class="comment">// the short component name of the intent</span></span><br><span class="line"><span class="keyword">final</span> String resolvedType; <span class="comment">// as per original caller;</span></span><br><span class="line"><span class="keyword">final</span> String packageName; <span class="comment">// the package implementing intent&#x27;s component</span></span><br><span class="line"><span class="keyword">final</span> String processName; <span class="comment">// process where this component wants to run</span></span><br><span class="line"><span class="keyword">final</span> String taskAffinity; <span class="comment">// as per ActivityInfo.taskAffinity</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> stateNotNeeded; <span class="comment">// As per ActivityInfo.flags</span></span><br><span class="line"><span class="keyword">boolean</span> fullscreen; <span class="comment">// The activity is opaque and fills the entire space of this task.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> See if it possible to combine this with the fullscreen field.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> hasWallpaper; <span class="comment">// Has a wallpaper window as a background.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> noDisplay;  <span class="comment">// activity is not displayed?</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> componentSpecified;  <span class="comment">// did caller specify an explicit component?</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> rootVoiceInteraction;  <span class="comment">// was this the root activity of a voice interaction?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> CharSequence nonLocalizedLabel;  <span class="comment">// the label information from the package mgr.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> labelRes;           <span class="comment">// the label information from the package mgr.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> icon;               <span class="comment">// resource identifier of activity&#x27;s icon.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> logo;               <span class="comment">// resource identifier of activity&#x27;s logo.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> theme;              <span class="comment">// resource identifier of activity&#x27;s theme.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> realTheme;          <span class="comment">// actual theme resource we will use, never 0.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> windowFlags;        <span class="comment">// custom window flags for preview window.</span></span><br><span class="line"><span class="keyword">private</span> TaskRecord task;        <span class="comment">// the task this is in.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> createTime = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">long</span> lastVisibleTime;   <span class="comment">// last time this activity became visible</span></span><br><span class="line"><span class="keyword">long</span> cpuTimeAtResume;   <span class="comment">// the cpu time of host process at the time of resuming activity</span></span><br><span class="line"><span class="keyword">long</span> pauseTime;         <span class="comment">// last time we started pausing the activity</span></span><br><span class="line"><span class="keyword">long</span> launchTickTime;    <span class="comment">// base time for launch tick messages</span></span><br><span class="line"><span class="comment">// Last configuration reported to the activity in the client process.</span></span><br><span class="line"><span class="keyword">private</span> MergedConfiguration mLastReportedConfiguration;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mLastReportedDisplayId;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mLastReportedMultiWindowMode;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mLastReportedPictureInPictureMode;</span><br><span class="line">CompatibilityInfo compat;<span class="comment">// last used compatibility mode</span></span><br><span class="line">ActivityRecord resultTo; <span class="comment">// who started this entry, so will get our reply</span></span><br><span class="line"><span class="keyword">final</span> String resultWho; <span class="comment">// additional identifier for use by resultTo.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> requestCode;  <span class="comment">// code given by requester (resultTo)</span></span><br><span class="line">ArrayList&lt;ResultInfo&gt; results; <span class="comment">// pending ActivityResult objs we have received</span></span><br><span class="line">HashSet&lt;WeakReference&lt;PendingIntentRecord&gt;&gt; pendingResults; <span class="comment">// all pending intents for this act</span></span><br><span class="line">ArrayList&lt;ReferrerIntent&gt; newIntents; <span class="comment">// any pending new intents for single-top mode</span></span><br><span class="line">ActivityOptions pendingOptions; <span class="comment">// most recently given options</span></span><br><span class="line">ActivityOptions returningOptions; <span class="comment">// options that are coming back via convertToTranslucent</span></span><br><span class="line">AppTimeTracker appTimeTracker; <span class="comment">// set if we are tracking the time in this app/task/activity</span></span><br><span class="line">HashSet&lt;ConnectionRecord&gt; connections; <span class="comment">// All ConnectionRecord we hold</span></span><br><span class="line">UriPermissionOwner uriPermissions; <span class="comment">// current special URI access perms.</span></span><br><span class="line">ProcessRecord app;      <span class="comment">// if non-null, hosting application</span></span><br><span class="line"><span class="keyword">private</span> ActivityState mState;    <span class="comment">// current state we are in</span></span><br><span class="line">Bundle  icicle;         <span class="comment">// last saved activity state</span></span><br><span class="line">PersistableBundle persistentState; <span class="comment">// last persistently saved activity state</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> See if this is still needed.</span></span><br><span class="line"><span class="keyword">boolean</span> frontOfTask;    <span class="comment">// is this the root activity of its task?</span></span><br><span class="line"><span class="keyword">boolean</span> launchFailed;   <span class="comment">// set if a launched failed, to abort on 2nd try</span></span><br><span class="line"><span class="keyword">boolean</span> haveState;      <span class="comment">// have we gotten the last activity state?</span></span><br><span class="line"><span class="keyword">boolean</span> stopped;        <span class="comment">// is activity pause finished?</span></span><br><span class="line"><span class="keyword">boolean</span> delayedResume;  <span class="comment">// not yet resumed because of stopped app switches?</span></span><br><span class="line"><span class="keyword">boolean</span> finishing;      <span class="comment">// activity in pending finish list?</span></span><br><span class="line"><span class="keyword">boolean</span> deferRelaunchUntilPaused;   <span class="comment">// relaunch of activity is being deferred until pause is</span></span><br><span class="line">                                    <span class="comment">// completed</span></span><br><span class="line"><span class="keyword">boolean</span> preserveWindowOnDeferredRelaunch; <span class="comment">// activity windows are preserved on deferred relaunch</span></span><br><span class="line"><span class="keyword">int</span> configChangeFlags;  <span class="comment">// which config values have changed</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> keysPaused;     <span class="comment">// has key dispatching been paused for it?</span></span><br><span class="line"><span class="keyword">int</span> launchMode;         <span class="comment">// the launch mode activity attribute.</span></span><br><span class="line"><span class="keyword">int</span> lockTaskLaunchMode; <span class="comment">// the lockTaskMode manifest attribute, subject to override</span></span><br><span class="line"><span class="keyword">boolean</span> visible;        <span class="comment">// does this activity&#x27;s window need to be shown?</span></span><br><span class="line"><span class="keyword">boolean</span> visibleIgnoringKeyguard; <span class="comment">// is this activity visible, ignoring the fact that Keyguard</span></span><br><span class="line">                                 <span class="comment">// might hide this activity?</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mDeferHidingClient; <span class="comment">// If true we told WM to defer reporting to the client</span></span><br><span class="line">                                    <span class="comment">// process that it is hidden.</span></span><br><span class="line"><span class="keyword">boolean</span> sleeping;       <span class="comment">// have we told the activity to sleep?</span></span><br><span class="line"><span class="keyword">boolean</span> nowVisible;     <span class="comment">// is this activity&#x27;s window visible?</span></span><br><span class="line"><span class="keyword">boolean</span> drawn;          <span class="comment">// is this activity&#x27;s window drawn?</span></span><br><span class="line"><span class="keyword">boolean</span> mClientVisibilityDeferred;<span class="comment">// was the visibility change message to client deferred?</span></span><br><span class="line"><span class="keyword">boolean</span> idle;           <span class="comment">// has the activity gone idle?</span></span><br><span class="line"><span class="keyword">boolean</span> hasBeenLaunched;<span class="comment">// has this activity ever been launched?</span></span><br><span class="line"><span class="keyword">boolean</span> frozenBeforeDestroy;<span class="comment">// has been frozen but not yet destroyed.</span></span><br><span class="line"><span class="keyword">boolean</span> immersive;      <span class="comment">// immersive mode (don&#x27;t interrupt if possible)</span></span><br><span class="line"><span class="keyword">boolean</span> forceNewConfig; <span class="comment">// force re-create with new config next time</span></span><br><span class="line"><span class="keyword">boolean</span> supportsEnterPipOnTaskSwitch;  <span class="comment">// This flag is set by the system to indicate that the</span></span><br><span class="line">    <span class="comment">// activity can enter picture in picture while pausing (only when switching to another task)</span></span><br><span class="line">PictureInPictureParams pictureInPictureArgs = <span class="keyword">new</span> PictureInPictureParams.Builder().build();</span><br><span class="line">    <span class="comment">// The PiP params used when deferring the entering of picture-in-picture.</span></span><br><span class="line"><span class="keyword">int</span> launchCount;        <span class="comment">// count of launches since last state</span></span><br><span class="line"><span class="keyword">long</span> lastLaunchTime;    <span class="comment">// time of last launch of this activity</span></span><br><span class="line">ComponentName requestedVrComponent; <span class="comment">// the requested component for handling VR mode.</span></span><br><span class="line"></span><br><span class="line">String stringName;      <span class="comment">// for caching of toString().</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> inHistory;  <span class="comment">// are we in the history stack?</span></span><br><span class="line"><span class="keyword">final</span> ActivityStackSupervisor mStackSupervisor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STARTING_WINDOW_NOT_SHOWN = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STARTING_WINDOW_SHOWN = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STARTING_WINDOW_REMOVED = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> mStartingWindowState = STARTING_WINDOW_NOT_SHOWN;</span><br><span class="line"><span class="keyword">boolean</span> mTaskOverlay = <span class="keyword">false</span>; <span class="comment">// Task is always on-top of other activities in the task.</span></span><br><span class="line"></span><br><span class="line">TaskDescription taskDescription; <span class="comment">// the recents information for this activity</span></span><br><span class="line"><span class="keyword">boolean</span> mLaunchTaskBehind; <span class="comment">// this activity is actively being launched with</span></span><br></pre></td></tr></table></figure>

<p>ActivityRecord是AMS调度Activity的基本单位，它需要记录AndroidManifest.xml中所定义Activity的静态特征，同时， 也需要记录Activity在被调度时的状态变化,</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ActivityInfo</td>
<td>从<activity>标签中解析出来的信息，包含launchMode，permission，taskAffinity等</activity></td>
</tr>
<tr>
<td>mActivityType</td>
<td>Activity的类型有三种：APPLICATION_ACTIVITY_TYPE(应用)、HOME_ACTIVITY_TYPE(桌面)、RECENTS_ACTIVITY_TYPE(最近使用)</td>
</tr>
<tr>
<td>ComponentName realActivity</td>
<td>the intent component, or target of an alias.</td>
</tr>
<tr>
<td>appToken</td>
<td>当前ActivityRecord的标识</td>
</tr>
<tr>
<td>packageName</td>
<td>当前所属的包名，这是由<activity>静态定义的</activity></td>
</tr>
<tr>
<td>processName</td>
<td>当前所属的进程名，大部分情况都是由<activity>静态定义的，但也有例外</activity></td>
</tr>
<tr>
<td>taskAffinity</td>
<td>相同taskAffinity的Activity会被分配到同一个任务栈中</td>
</tr>
<tr>
<td>intent</td>
<td>启动当前Activity的Intent</td>
</tr>
<tr>
<td>launchedFromUid</td>
<td>启动当前Activity的UID，即发起者的UID</td>
</tr>
<tr>
<td>userId;</td>
<td>Which user is this running for?</td>
</tr>
<tr>
<td>launchedFromPackage</td>
<td>启动当前Activity的包名，即发起者的包名</td>
</tr>
<tr>
<td>resultTo</td>
<td>在当前ActivityRecord看来，resultTo表示上一个启动它的ActivityRecord，当需要启动另一个ActivityRecord，会把自己作为resultTo，传递给下一个ActivityRecord</td>
</tr>
<tr>
<td>state</td>
<td>ActivityRecord所处的状态，初始值是ActivityState.INITIALIZING</td>
</tr>
<tr>
<td>app</td>
<td>ActivityRecord的宿主进程</td>
</tr>
<tr>
<td>task</td>
<td>ActivityRecord的宿主任务</td>
</tr>
<tr>
<td>inHistory</td>
<td>标识当前的ActivityRecord是否已经置入任务栈中</td>
</tr>
<tr>
<td>frontOfTask</td>
<td>标识当前的ActivityRecord是否处于任务栈的根部，即是否为进入任务栈的第一个ActivityRecord</td>
</tr>
<tr>
<td>newIntents</td>
<td>Intent数组，用于暂存还没有调度到应用进程Activity的Intent</td>
</tr>
</tbody></table>
<p>由于ActivityRecord是一个最基本的数据结构，所以其行为相对较少，大都是一些用于判定和更新当前ActivityRecord状态的函数：</p>
<table>
<thead>
<tr>
<th>行为</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>putInHistory(), takeFromHistory(), isInHistory()</td>
<td>基于inHistory属性，来判定和更新ActivityRecord是否在任务栈的状态值</td>
</tr>
<tr>
<td>isHomeActivity(), isRecentsActivity(), isApplicationActivity()</td>
<td>基于mActivityType属性，判定Activity的类型</td>
</tr>
<tr>
<td>setTask()</td>
<td>设置ActivityRecord的宿主任务</td>
</tr>
<tr>
<td>deliverNewIntentLocked()</td>
<td>向当前ActivityRecord继续派发Intent。在一些场景下，位于任务栈顶的ActivityRecord会继续接受新的Intent(譬如以singleTop方式启动的同一个Activity)，这时候，会触发调度Activity.onNewIntent()函数</td>
</tr>
<tr>
<td>addNewIntentLocked()</td>
<td>如果Intent没有派发到应用进程，则通过该函数往newIntents数组中添加一个元素。</td>
</tr>
</tbody></table>
<p>要理解ActivityRecord这个数据结构，可以从其构造函数出发，理解其属性在什么场景下会发生变化。 每次需要启动一个新的Activity时，都会构建一个ActivityRecord对象，这在ActivityStackSupervisor.startActivityLocked()函数中完成，构造一个ActivityRecord要传入的参数是相当多的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">ActivityRecord(ActivityManagerService _service, ProcessRecord _caller,</span><br><span class="line">      <span class="keyword">int</span> _launchedFromUid, String _launchedFromPackage, Intent _intent, String _resolvedType,</span><br><span class="line">      ActivityInfo aInfo, Configuration _configuration,</span><br><span class="line">      ActivityRecord _resultTo, String _resultWho, <span class="keyword">int</span> _reqCode,</span><br><span class="line">      <span class="keyword">boolean</span> _componentSpecified, ActivityStackSupervisor supervisor,</span><br><span class="line">      ActivityContainer container, Bundle options) &#123;</span><br><span class="line">    service = _service; <span class="comment">// AMS对象</span></span><br><span class="line">    appToken = <span class="keyword">new</span> Token(<span class="keyword">this</span>); <span class="comment">//appToken可以进行跨进程传递，标识一个AR对象</span></span><br><span class="line">    info = aInfo; <span class="comment">//从AndroidManifest.xml中解析得到的Activity信息</span></span><br><span class="line">    launchedFromUid = _launchedFromUid; <span class="comment">//譬如从浏览器启动当前AR，那么该属性记录的就是浏览器的UID</span></span><br><span class="line">    launchedFromPackage = _launchedFromPackage;</span><br><span class="line">    userId = UserHandle.getUserId(aInfo.applicationInfo.uid);</span><br><span class="line">    intent = _intent; <span class="comment">//启动当前AR的Intent</span></span><br><span class="line">    shortComponentName = _intent.getComponent().flattenToShortString();</span><br><span class="line">    resolvedType = _resolvedType;</span><br><span class="line">    componentSpecified = _componentSpecified;</span><br><span class="line">    configuration = _configuration;</span><br><span class="line">    resultTo = _resultTo; <span class="comment">//记录上一个AR对象</span></span><br><span class="line">    resultWho = _resultWho; <span class="comment">//reslutTo的字符串标识</span></span><br><span class="line">    requestCode = _reqCode; <span class="comment">//上一个AR对象设定的Request Code</span></span><br><span class="line">    state = ActivityState.INITIALIZING; <span class="comment">//AR的状态，Activity调度时发生改变</span></span><br><span class="line">    frontOfTask = <span class="keyword">false</span>; <span class="comment">//是否处于Task的根部，调整任务栈中AR顺序时，可能发生改变</span></span><br><span class="line">    launchFailed = <span class="keyword">false</span>;</span><br><span class="line">    stopped = <span class="keyword">false</span>; <span class="comment">//pause操作完成状态位</span></span><br><span class="line">    delayedResume = <span class="keyword">false</span>;</span><br><span class="line">    finishing = <span class="keyword">false</span>; <span class="comment">//stoped到finished之间的过渡状态位</span></span><br><span class="line">    configDestroy = <span class="keyword">false</span>;</span><br><span class="line">    keysPaused = <span class="keyword">false</span>; <span class="comment">//如果置为true，则当前AR不再接受用户输入</span></span><br><span class="line">    inHistory = <span class="keyword">false</span>; <span class="comment">//将AR压入任务栈后，该状态位被置为true</span></span><br><span class="line">    visible = <span class="keyword">true</span>;</span><br><span class="line">    waitingVisible = <span class="keyword">false</span>;</span><br><span class="line">    nowVisible = <span class="keyword">false</span>;</span><br><span class="line">    idle = <span class="keyword">false</span>;</span><br><span class="line">    hasBeenLaunched = <span class="keyword">false</span>;</span><br><span class="line">    mStackSupervisor = supervisor;</span><br><span class="line">    mInitialActivityContainer = container;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pendingOptions = <span class="keyword">new</span> ActivityOptions(options);</span><br><span class="line">        mLaunchTaskBehind = pendingOptions.getLaunchTaskBehind();</span><br><span class="line">    &#125;</span><br><span class="line">    haveState = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//根据aInfo给realActivity, taskAffinity, processName等属性赋值</span></span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//没有aInfo的情况下，赋予默认值</span></span><br><span class="line">        realActivity = <span class="keyword">null</span>;</span><br><span class="line">        taskAffinity = <span class="keyword">null</span>;</span><br><span class="line">        stateNotNeeded = <span class="keyword">false</span>;</span><br><span class="line">        appInfo = <span class="keyword">null</span>;</span><br><span class="line">        processName = <span class="keyword">null</span>;</span><br><span class="line">        packageName = <span class="keyword">null</span>;</span><br><span class="line">        fullscreen = <span class="keyword">true</span>;</span><br><span class="line">        noDisplay = <span class="keyword">false</span>;</span><br><span class="line">        mActivityType = APPLICATION_ACTIVITY_TYPE;</span><br><span class="line">        immersive = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="TaskRecord"><a href="#TaskRecord" class="headerlink" title="TaskRecord"></a>TaskRecord</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> taskId;       <span class="comment">// Unique identifier for this task.</span></span><br><span class="line">String affinity;        <span class="comment">// The affinity name for this task, or null; may change identity.</span></span><br><span class="line">String rootAffinity;    <span class="comment">// Initial base affinity, or null; does not change from initial root.</span></span><br><span class="line"><span class="keyword">final</span> IVoiceInteractionSession voiceSession;    <span class="comment">// Voice interaction session driving task</span></span><br><span class="line"><span class="keyword">final</span> IVoiceInteractor voiceInteractor;         <span class="comment">// Associated interactor to provide to app</span></span><br><span class="line">Intent intent;          <span class="comment">// The original intent that started the task. Note that this value can</span></span><br><span class="line"><span class="comment">// be null.</span></span><br><span class="line">Intent affinityIntent;  <span class="comment">// Intent of affinity-moved activity that started this task.</span></span><br><span class="line"><span class="keyword">int</span> effectiveUid;       <span class="comment">// The current effective uid of the identity of this task.</span></span><br><span class="line">ComponentName origActivity; <span class="comment">// The non-alias activity component of the intent.</span></span><br><span class="line">ComponentName realActivity; <span class="comment">// The actual activity component that started the task.</span></span><br><span class="line"><span class="keyword">boolean</span> realActivitySuspended; <span class="comment">// True if the actual activity component that started the</span></span><br><span class="line"><span class="comment">// task is suspended.</span></span><br><span class="line"><span class="keyword">boolean</span> inRecents;      <span class="comment">// Actually in the recents list?</span></span><br><span class="line"><span class="keyword">long</span> lastActiveTime;    <span class="comment">// Last time this task was active in the current device session,</span></span><br><span class="line"><span class="comment">// including sleep. This time is initialized to the elapsed time when</span></span><br><span class="line"><span class="comment">// restored from disk.</span></span><br><span class="line"><span class="keyword">boolean</span> isAvailable;    <span class="comment">// Is the activity available to be launched?</span></span><br><span class="line"><span class="keyword">boolean</span> rootWasReset;   <span class="comment">// True if the intent at the root of the task had</span></span><br><span class="line"><span class="comment">// the FLAG_ACTIVITY_RESET_TASK_IF_NEEDED flag.</span></span><br><span class="line"><span class="keyword">boolean</span> autoRemoveRecents;  <span class="comment">// If true, we should automatically remove the task from</span></span><br><span class="line"><span class="comment">// recents when activity finishes</span></span><br><span class="line"><span class="keyword">boolean</span> askedCompatMode;<span class="comment">// Have asked the user about compat mode for this task.</span></span><br><span class="line"><span class="keyword">boolean</span> hasBeenVisible; <span class="comment">// Set if any activities in the task have been visible to the user.</span></span><br><span class="line"></span><br><span class="line">String stringName;      <span class="comment">// caching of toString() result.</span></span><br><span class="line"><span class="keyword">int</span> userId;             <span class="comment">// user for which this task was created</span></span><br><span class="line"><span class="keyword">boolean</span> mUserSetupComplete; <span class="comment">// The user set-up is complete as of the last time the task activity</span></span><br><span class="line"><span class="comment">// was changed.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> numFullscreen;      <span class="comment">// Number of fullscreen activities.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mResizeMode;        <span class="comment">// The resize mode of this task and its activities.</span></span><br><span class="line"><span class="comment">// Based on the &#123;@link ActivityInfo#resizeMode&#125; of the root activity.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mSupportsPictureInPicture;  <span class="comment">// Whether or not this task and its activities</span></span><br><span class="line"><span class="comment">// support PiP. Based on the &#123;@link ActivityInfo#FLAG_SUPPORTS_PICTURE_IN_PICTURE&#125; flag</span></span><br><span class="line"><span class="comment">// of the root activity.</span></span><br><span class="line"><span class="comment">/** Can&#x27;t be put in lockTask mode. */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LOCK_TASK_AUTH_DONT_LOCK = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/** Can enter app pinning with user approval. Can never start over existing lockTask task. */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LOCK_TASK_AUTH_PINNABLE = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** Starts in LOCK_TASK_MODE_LOCKED automatically. Can start over existing lockTask task. */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LOCK_TASK_AUTH_LAUNCHABLE = <span class="number">2</span>;</span><br><span class="line"><span class="comment">/** Can enter lockTask without user approval. Can start over existing lockTask task. */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LOCK_TASK_AUTH_WHITELISTED = <span class="number">3</span>;</span><br><span class="line"><span class="comment">/** Priv-app that starts in LOCK_TASK_MODE_LOCKED automatically. Can start over existing</span></span><br><span class="line"><span class="comment">     * lockTask task. */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LOCK_TASK_AUTH_LAUNCHABLE_PRIV = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">int</span> mLockTaskAuth = LOCK_TASK_AUTH_PINNABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mLockTaskUid = -<span class="number">1</span>;  <span class="comment">// The uid of the application that called startLockTask().</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This represents the last resolved activity values for this task</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> This value needs to be persisted with each task</span></span><br><span class="line">TaskDescription lastTaskDescription = <span class="keyword">new</span> TaskDescription();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** List of all activities in the task arranged in history order */</span></span><br><span class="line"><span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; mActivities;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Current stack. Setter must always be used to update the value. */</span></span><br><span class="line"><span class="keyword">private</span> ActivityStack mStack;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The process that had previously hosted the root activity of this task.</span></span><br><span class="line"><span class="comment">     * Used to know that we should try harder to keep this process around, in case the</span></span><br><span class="line"><span class="comment">     * user wants to return to it. */</span></span><br><span class="line"><span class="keyword">private</span> ProcessRecord mRootProcess;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Takes on same value as first root activity */</span></span><br><span class="line"><span class="keyword">boolean</span> isPersistable = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">int</span> maxRecents;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Only used for persistable tasks, otherwise 0. The last time this task was moved. Used for</span></span><br><span class="line"><span class="comment">     * determining the order when restoring. Sign indicates whether last task movement was to front</span></span><br><span class="line"><span class="comment">     * (positive) or back (negative). Absolute value indicates time. */</span></span><br><span class="line"><span class="keyword">long</span> mLastTimeMoved = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** If original intent did not allow relinquishing task identity, save that information */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mNeverRelinquishIdentity = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used in the unique case where we are clearing the task in order to reuse it. In that case we</span></span><br><span class="line"><span class="comment">// do not want to delete the stack when the task goes empty.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mReuseTask = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">CharSequence lastDescription; <span class="comment">// Last description captured for this item.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mAffiliatedTaskId; <span class="comment">// taskId of parent affiliation or self if no parent.</span></span><br><span class="line"><span class="keyword">int</span> mAffiliatedTaskColor; <span class="comment">// color of the parent task affiliation.</span></span><br><span class="line">TaskRecord mPrevAffiliate; <span class="comment">// previous task in affiliated chain.</span></span><br><span class="line"><span class="keyword">int</span> mPrevAffiliateTaskId = INVALID_TASK_ID; <span class="comment">// previous id for persistence.</span></span><br><span class="line">TaskRecord mNextAffiliate; <span class="comment">// next task in affiliated chain.</span></span><br><span class="line"><span class="keyword">int</span> mNextAffiliateTaskId = INVALID_TASK_ID; <span class="comment">// next id for persistence.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// For relaunching the task from recents as though it was launched by the original launcher.</span></span><br><span class="line"><span class="keyword">int</span> mCallingUid;</span><br><span class="line">String mCallingPackage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Rect mTmpStableBounds = <span class="keyword">new</span> Rect();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Rect mTmpNonDecorBounds = <span class="keyword">new</span> Rect();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Rect mTmpRect = <span class="keyword">new</span> Rect();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Last non-fullscreen bounds the task was launched in or resized to.</span></span><br><span class="line"><span class="comment">// The information is persisted and used to determine the appropriate stack to launch the</span></span><br><span class="line"><span class="comment">// task into on restore.</span></span><br><span class="line">Rect mLastNonFullscreenBounds = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// Minimal width and height of this task when it&#x27;s resizeable. -1 means it should use the</span></span><br><span class="line"><span class="comment">// default minimal width/height.</span></span><br><span class="line"><span class="keyword">int</span> mMinWidth;</span><br><span class="line"><span class="keyword">int</span> mMinHeight;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ranking (from top) of this task among all visible tasks. (-1 means it&#x27;s not visible)</span></span><br><span class="line"><span class="comment">// This number will be assigned when we evaluate OOM scores for all visible tasks.</span></span><br><span class="line"><span class="keyword">int</span> mLayerRank = -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>TaskRecord的职责是管理多个ActivityRecord，本文所述的任务、任务栈指的就是TaskRecord。 启动Activity时，需要找到Activity的宿主任务，如果不存在，则需要新建一个，也就是说所有的ActivityRecord都必须有宿主。 TaskRecord与ActivityRecord是一对多的关系，TaskRecord的属性中包含了ActivityRecord的数组; 同时，TaskRecord还需要维护任务栈本身的状态。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>taskid</td>
<td>TaskRecord的唯一标识</td>
</tr>
<tr>
<td>taskType</td>
<td>任务栈的类型，等同于ActivityRecord的类型，是由任务栈的第一个ActivityRecord决定的</td>
</tr>
<tr>
<td>intent</td>
<td>在当前任务栈中启动的第一个Activity的Intent将会被记录下来，后续如果有相同的Intent时，会与已有任务栈的Intent进行匹配，如果匹配上了，就不需要再新建一个TaskRecord了</td>
</tr>
<tr>
<td>realActivity, origActivity</td>
<td>启动任务栈的Activity，这两个属性是用包名(CompentName)表示的，real和orig是为了区分Activity有无别名(alias)的情况，如果AndroidManifest.xml中定义的Activity是一个alias，则此处real表示Activity的别名，orig表示真实的Activity</td>
</tr>
<tr>
<td>affinity</td>
<td>TaskRecord把Activity的affinity记录下来，后续启动Activity时，会从已有的任务栈中匹配affinity，如果匹配上了，则不需要新建TaskRecord</td>
</tr>
<tr>
<td>rootAffinity</td>
<td>记录任务栈中最底部Activity的affinity，一经设定后就不再改变</td>
</tr>
<tr>
<td>mActivities</td>
<td>这是TaskRecord最重要的一个属性，TaskRecord是一个栈结构，栈的元素是ActivityRecord，其内部实现是一个数组mActivities</td>
</tr>
<tr>
<td>stack</td>
<td>当前TaskRecord所在的ActivityStack</td>
</tr>
</tbody></table>
<p>TaskRecord的行为侧重在TaskRecord本身的管理：增/删/改/查任务栈中的元素。</p>
<table>
<thead>
<tr>
<th>行为</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>getRootActivity(), getTopActivity()</td>
<td>任务栈有根部(Root)和顶部(Top)，可以通过这两个函数分别获取到根部和顶部的ActivityRecord。获取的过程就是对TaskRecord.mActivities进行遍历，如果ActivityRecord的状态不是finishing，就认为是有效的ActivityRecord</td>
</tr>
<tr>
<td>topRunningActivityLocked()</td>
<td>虽然也是从顶至底对任务栈进行遍历获取顶部的ActivityRecord，但这个函数同getTopActivity()有区别：输入参数notTop，表示在遍历的过程中需要排除notTop这个ActivityRecord;</td>
</tr>
<tr>
<td>addActivityToTop(), addActivityAtBottom()</td>
<td>将ActivityRecord添加到任务栈的顶部或底部</td>
</tr>
<tr>
<td>moveActivityToFrontLocked()</td>
<td>该函数将一个ActivityRecord移至TaskRecord的顶部，实现方法就是先删除已有的，再在栈顶添加一个新的</td>
</tr>
<tr>
<td>setFrontOfTask()</td>
<td>ActivityRecord有一个属性是frontOfTask，表示ActivityRecord是否为TaskRecord的根Activity。该函数设置TaskRecord中所有ActivityRecord的frontOfTask属性，从栈底往上开始遍历，第一个不处于finishing状态的ActivityRecord的frontOfTask属性置成true，其他都为false</td>
</tr>
<tr>
<td>performClearTaskLocked()</td>
<td>清除TaskRecord中的ActivityRecord。当启动Activity时，用了Intent.FLAG_ACTIVITY_CLEAR_TOP参数，那么在宿主任务中，待启动ActivityRecord之上的其他ActivityRecord都会被清除</td>
</tr>
</tbody></table>
<p>仅仅把类的属性和行为罗列出来，当然不足以理解TaskRecord的工作原理。 接下来，将深入部分函数的代码，分析TaskRecord在一些场景下的具体执行逻辑。</p>
<p><code>场景 1</code> 启动一个Activity时，通常需要将ActivityRecord压入任务栈顶，addActivityToTop()就是为此功能设计：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addActivityToTop</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    addActivityAtIndex(mActivities.size(), r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将ActivityRecord压入栈顶，其实就是在mActivities数组末尾添加一个元素，所以，实际压入栈顶的操作是由addActivityAtIndex()完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addActivityAtIndex</span><span class="params">(<span class="keyword">int</span> index, ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 移除已有的ActivityRecord对象</span></span><br><span class="line">    <span class="keyword">if</span> (!mActivities.remove(r) &amp;&amp; r.fullscreen) &#123;</span><br><span class="line">        numFullscreen++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. 根据任务栈是否为空，设置状态</span></span><br><span class="line">    <span class="keyword">if</span> (mActivities.isEmpty()) &#123;</span><br><span class="line">        taskType = r.mActivityType;</span><br><span class="line">        isPersistable = r.isPersistable();</span><br><span class="line">        mCallingUid = r.launchedFromUid;</span><br><span class="line">        mCallingPackage = r.launchedFromPackage;</span><br><span class="line">        maxRecents = Math.min(Math.max(r.info.maxRecents, <span class="number">1</span>),</span><br><span class="line">                ActivityManager.getMaxAppRecentsLimitStatic());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.mActivityType = taskType;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. 在指定的位置添加ActivityRecord</span></span><br><span class="line">    mActivities.add(index, r);</span><br><span class="line">    <span class="comment">// 4. 更新任务栈关联的Intent</span></span><br><span class="line">    updateEffectiveIntent();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数会经过以下处理过程：</p>
<ol>
<li>移除任务栈中已有的ActivityRecord对象，即任务栈中不会出现两个同样的ActivityRecord对象。此处需要注意，两次启动同一个Activity，是会产生两个不同的ActivityRecord对象的;</li>
<li>如果任务栈为空，则设置任务栈的初始状态，否则，设置ActivityRecord的类型为任务栈的类型。由此可见，同一个任务栈中，所有ActivityRecord的类型都是一样的，而且是由任务栈的第一个ActivityRecord的类型决定的;</li>
<li>此处的位置就是任务栈顶，也就是mActivities属性的末尾;</li>
<li>任务栈中元素发生了变化，所以需要更新任务栈关联的Intent，这是通过调用updateEffectiveIntent()实现的，函数的具体逻辑，在<code>场景 3</code>中再行分析。</li>
</ol>
<p><code>场景 2</code> 当待显示的Activity压入任务栈后，就需要设置栈顶ActivityRecord的状态，这时候，会调用topRunningActivityLocked()函数来获取栈顶的元素，为了更好的分析topRunningActivityLocked()的使用场景，笔者把另一个与其功能相似的函数getTopActivity()也列出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ActivityRecord <span class="title">getTopActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mActivities.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord r = mActivities.get(i);</span><br><span class="line">        <span class="keyword">if</span> (r.finishing) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ActivityRecord <span class="title">topRunningActivityLocked</span><span class="params">(ActivityRecord notTop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> activityNdx = mActivities.size() - <span class="number">1</span>; activityNdx &gt;= <span class="number">0</span>; --activityNdx) &#123;</span><br><span class="line">        ActivityRecord r = mActivities.get(activityNdx);</span><br><span class="line">        <span class="comment">// 除了要求ActivityRecord不是finishing状态以外，还要求不是当前给定输入的ActivityRecord</span></span><br><span class="line">        <span class="keyword">if</span> (!r.finishing &amp;&amp; r != notTop &amp;&amp; stack.okToShowLocked(r)) &#123;</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两者是从顶到底对任务栈进行遍历，但实现逻辑不同，topRunningActivityLocked()接受一个输入参数notTop，在寻找时，要求排除notTop指定的ActivityRecord，通常，传入的notTop都是null，隐含的意思就是栈顶的ActivityRecord还没有被销毁。从函数命名topRunning，也可以看出其与getTop的区别：getTop不管栈顶的死活，拿到就好; topRunning要求拿到的一定是活的栈顶。</p>
<p>另外，topRunningActivityLocked()还有一个限制条件： ActivityRecord是可以被显示的(okToShow)，这是通过ActivityStack.okToShowLocked()来判定的，主要是为了应多多用户或锁屏显示的Activity，一般情况下，函数返回值都为true。</p>
<p><code>场景 3</code> 假定在启动一个Activity时，设置了Intent的FLAG_ACTIVITY_REORDER_TO_FRONT，表示要将Activity重排序到任务栈顶。 如果目标的Activity在任务栈中已经启动过，则需要将其挪至栈顶。譬如目标任务栈从底到顶是 <code>A - B - C</code>， 然后，又以FLAG_ACTIVITY_REORDER_TO_FRONT启动了 A，那最终任务栈会变化为 <code>B - C - A</code> 。 这就会调用到moveActivityToFrontLocked()函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">moveActivityToFrontLocked</span><span class="params">(ActivityRecord newTop)</span> </span>&#123;</span><br><span class="line">    mActivities.remove(newTop);</span><br><span class="line">    mActivities.add(newTop);</span><br><span class="line">    updateEffectiveIntent();</span><br><span class="line">    setFrontOfTask();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数需要调整任务栈中ActivityRecord的顺序，延用上述例子， A 将作为参数newTop。 首先，会将 A 从任务栈中移除; 然后，再将 A 添加到任务栈顶; 接着，会调用updateEffectiveIntent()函数来更新任务栈关联的Intent：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateEffectiveIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> effectiveRootIndex = findEffectiveRootIndex();</span><br><span class="line">    <span class="keyword">final</span> ActivityRecord r = mActivities.get(effectiveRootIndex);</span><br><span class="line">    setIntent(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数会找到一个有效的Root Index，即任务栈底部的索引，根据这个索引值取出对应的ActivityRecord。 延续上述例子，B 会被调整为任务栈的根部ActivityRecord，通过调用setIntent()来设置当前任务栈关联的Intent为启动 B 的Intent，然而，这里可不止改变TaskRecord.intent这一个属性这个简单，与Taskrecord的发起者相关的属性值都要更改， 譬如mCallingUid，mCallingPackage都得更改为 B 的发起者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setIntent</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    setIntent(r.intent, r.info);</span><br><span class="line">    mCallingUid = r.launchedFromUid;</span><br><span class="line">    mCallingPackage = r.launchedFromPackage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里还有一个重载的setIntent()函数，不再展开分析了，只需要知道诸如affinity， realActivity等属性都会被重置即可。</p>
<p>更新完TaskRecord的Intent，再回到moveActivityToFrontLocked()函数中，需要继续更新任务栈的Front。 之前任务栈的Front是 A，在发生变化后， Front需要更新为 B，然而，TaskRecord并没有一个属性用来记录当前的Front， 它是根据任务栈中每一个ActivityRecord的frontOfTask属性来判定的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setFrontOfTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> foundFront = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numActivities = mActivities.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> activityNdx = <span class="number">0</span>; activityNdx &lt; numActivities; ++activityNdx) &#123;</span><br><span class="line">        <span class="comment">// 从栈底往上遍历</span></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord r = mActivities.get(activityNdx);</span><br><span class="line">        <span class="keyword">if</span> (foundFront || r.finishing) &#123;</span><br><span class="line">            <span class="comment">// 其他ActivityRecord的这个属性都置为false</span></span><br><span class="line">            r.frontOfTask = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不为finishing状态，表示已经找到了front的ActivityRecord</span></span><br><span class="line">            r.frontOfTask = <span class="keyword">true</span>;</span><br><span class="line">            foundFront = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!foundFront &amp;&amp; numActivities &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mActivities.get(<span class="number">0</span>).frontOfTask = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数从底到顶对任务栈进行遍历，找到的第一个未结束(finishing = faulse)的ActivityRecord， 将其frontOfTask属性设置成true;其他所有ActivtyRecord的frontOfTask属性设置为false。</p>
<h1 id="ActivityStack"><a href="#ActivityStack" class="headerlink" title="ActivityStack"></a>ActivityStack</h1><p>ActivityStack的职责是管理多个任务栈(TaskRecord)，它是一个栈式结构，栈中的元素是TaskRecord。 每个Activity在特定的时刻都会有一个状态，譬如显示、销毁等， 在应用进程看来，这些状态的变化就是在执行Activity的生命周期函数; 在系统进程看来，这些状态的变化都需要经过ActivityStack来驱动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ActivityState</span> </span>&#123;</span><br><span class="line">    INITIALIZING,</span><br><span class="line">    RESUMED,</span><br><span class="line">    PAUSING,</span><br><span class="line">    PAUSED,</span><br><span class="line">    STOPPING,</span><br><span class="line">    STOPPED,</span><br><span class="line">    FINISHING,</span><br><span class="line">    DESTROYING,</span><br><span class="line">    DESTROYED</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="comment">/* The various modes for the method &#123;@link #removeTask&#125;. */</span></span><br><span class="line"><span class="comment">// Task is being completely removed from all stacks in the system.</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REMOVE_TASK_MODE_DESTROYING = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// Task is being removed from this stack so we can add it to another stack. In the case we are</span></span><br><span class="line"><span class="comment">// moving we don&#x27;t want to perform some operations on the task like removing it from window</span></span><br><span class="line"><span class="comment">// manager or recents.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REMOVE_TASK_MODE_MOVING = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// Similar to &#123;@link #REMOVE_TASK_MODE_MOVING&#125; and the task will be added to the top of its new</span></span><br><span class="line"><span class="comment">// stack and the new stack will be on top of all stacks.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REMOVE_TASK_MODE_MOVING_TO_TOP = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The height/width divide used when fitting a task within a bounds with method</span></span><br><span class="line"><span class="comment">// &#123;@link #fitWithinBounds&#125;.</span></span><br><span class="line"><span class="comment">// We always want the task to to be visible in the bounds without affecting its size when</span></span><br><span class="line"><span class="comment">// fitting. To make sure this is the case, we don&#x27;t adjust the task left or top side pass</span></span><br><span class="line"><span class="comment">// the input bounds right or bottom side minus the width or height divided by this value.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIT_WITHIN_BOUNDS_DIVIDER = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WindowManagerService mWindowManager;</span><br><span class="line">T mWindowContainerController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The back history of all previous (and possibly still</span></span><br><span class="line"><span class="comment"> * running) activities.  It contains #TaskRecord objects.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;TaskRecord&gt; mTaskHistory = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * List of running activities, sorted by recent usage.</span></span><br><span class="line"><span class="comment"> * The first entry in the list is the least recently used.</span></span><br><span class="line"><span class="comment"> * It contains HistoryRecord objects.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; mLRUActivities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * When we are in the process of pausing an activity, before starting the</span></span><br><span class="line"><span class="comment"> * next one, this variable holds the activity that is currently being paused.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ActivityRecord mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is the last activity that we put into the paused state.  This is</span></span><br><span class="line"><span class="comment"> * used to determine if we need to do an activity transition while sleeping,</span></span><br><span class="line"><span class="comment"> * when we normally hold the top activity paused.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ActivityRecord mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Activities that specify No History must be removed once the user navigates away from them.</span></span><br><span class="line"><span class="comment"> * If the device goes to sleep with such an activity in the paused state then we save it here</span></span><br><span class="line"><span class="comment"> * and finish it later if another activity replaces it on wakeup.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ActivityRecord mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Current activity that is resumed, or null if there is none.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ActivityRecord mResumedActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The topmost Activity passed to convertToTranslucent(). When non-null it means we are</span></span><br><span class="line"><span class="comment">// waiting for all Activities in mUndrawnActivitiesBelowTopTranslucent to be removed as they</span></span><br><span class="line"><span class="comment">// are drawn. When the last member of mUndrawnActivitiesBelowTopTranslucent is removed the</span></span><br><span class="line"><span class="comment">// Activity in mTranslucentActivityWaiting is notified via</span></span><br><span class="line"><span class="comment">// Activity.onTranslucentConversionComplete(false). If a timeout occurs prior to the last</span></span><br><span class="line"><span class="comment">// background activity being drawn then the same call will be made with a true value.</span></span><br><span class="line">ActivityRecord mTranslucentActivityWaiting = <span class="keyword">null</span>;</span><br><span class="line">ArrayList&lt;ActivityRecord&gt; mUndrawnActivitiesBelowTopTranslucent = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set when we know we are going to be calling updateConfiguration()</span></span><br><span class="line"><span class="comment"> * soon, so want to skip intermediate config checks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> mConfigWillChange;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * When set, will force the stack to report as invisible.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> mForceHidden = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mUpdateBoundsDeferred;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mUpdateBoundsDeferredCalled;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Rect mDeferredBounds = <span class="keyword">new</span> Rect();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Rect mDeferredTaskBounds = <span class="keyword">new</span> Rect();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Rect mDeferredTaskInsetBounds = <span class="keyword">new</span> Rect();</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mCurrentUser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> mStackId;</span><br><span class="line"><span class="comment">/** The attached Display&#x27;s unique identifier, or -1 if detached */</span></span><br><span class="line"><span class="keyword">int</span> mDisplayId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;Rect&gt; mTmpBounds = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;Rect&gt; mTmpInsetBounds = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Rect mTmpRect2 = <span class="keyword">new</span> Rect();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ActivityOptions mTmpOptions = ActivityOptions.makeBasic();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** List for processing through a set of activities */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; mTmpActivities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Run all ActivityStacks through this */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ActivityStackSupervisor mStackSupervisor;</span><br></pre></td></tr></table></figure>

<p>从INITIALIZING到DESTROYED，所定义状态值示意了Activity生命周期的走向。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>stackId</td>
<td>每一个ActivityStack都有一个编号，从0开始递增。编号为0，表示桌面(Launcher)所在的ActivityStack，叫做Home Stack</td>
</tr>
<tr>
<td>mTaskHistory</td>
<td>TaskRecord数组，ActivityStack栈就是通过这个数组实现的</td>
</tr>
<tr>
<td>mPausingActivity</td>
<td>在发生Activity切换时，正处于Pausing状态的Activity</td>
</tr>
<tr>
<td>mResumedActivity</td>
<td>当前处于Resumed状态的ActivityRecord</td>
</tr>
<tr>
<td>mStacks</td>
<td>ActivityStack会绑定到一个显示设备上，譬如手机屏幕、投影仪等，在AMS中，通过ActivityDisplay这个类来抽象表示一个显示设备，ActivityDisplay.mStacks表示当前已经绑定到显示设备的所有ActivityStack。当执行一次绑定操作时，就会将ActivityStack.mStacks这个属性赋值成ActivityDisplay.mStacks，否则，ActivityStack.mStacks就为null。简而言之，当mStacks不为null时，表示当前ActivityStack已经绑定到了一个显示设备</td>
</tr>
</tbody></table>
<p>Activity状态的变迁，不仅仅是给ActivityRecord.state赋一个状态值那么简单，ActivityStack要对栈进行调整：之前的Activity要销毁或者挪到后台，待显示的Activity要挪到栈顶，这一调整，涉及到的工作就多了。</p>
<table>
<thead>
<tr>
<th>行为</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>findTaskLocked()</td>
<td>该函数的功能是找到目标ActivityRecord(target)所在的任务栈(TaskRecord)，如果找到，则返回栈顶的ActivityRecord，否则，返回null</td>
</tr>
<tr>
<td>findActivityLocked()</td>
<td>根据Intent和ActivityInfo这两个参数可以获取一个Activity的包名，该函数会从栈顶至栈底遍历ActivityStack中的所有Activity，如果包名匹配成功，就返回</td>
</tr>
<tr>
<td>moveToFront)</td>
<td>该函数用于将当前的ActivityStack挪到前台，执行时，调用ActivityStack中的其他一些判定函数</td>
</tr>
<tr>
<td>isAttached()</td>
<td>用于判定当前ActivityStack是否已经绑定到显示设备</td>
</tr>
<tr>
<td>isOnHomeDisplay()</td>
<td>用于判定当前是否为默认的显示设备(Display.DEFAULT_DISPLAY)，通常，默认的显示设备就是手机屏幕</td>
</tr>
<tr>
<td>isHomeStack()</td>
<td>用于判定当前ActivityStack是否为Home Stack，即判定当前显示的是否为桌面(Launcher)</td>
</tr>
<tr>
<td>moveTaskToFrontLocked()</td>
<td>该函数用于将指定的任务栈挪到当前ActivityStack的最前面。在Activity状态变化时，需要对已有的ActivityStack中的任务栈进行调整，待显示Activity的宿主任务需要挪到前台</td>
</tr>
<tr>
<td>insertTaskAtTop()</td>
<td>将任务插入ActivityStack栈顶</td>
</tr>
</tbody></table>
<p>ActivityStack还有很多与迁移Activity状态相关的行为： startActivityLocked()， resumeTopActivityLocked()， completeResumeLocked()， startPausingLocked()， completePauseLocked()， stopActivityLocked()， activityPausedLocked()， finishActivityLocked()， activityDestroyedLocked()， 它们与Activity的生命周期调度息息相关。</p>
<p><code>场景 1</code> 以singleTask的方式启动一个处于后台的Activity，那么，就需要将Activity挪到前台。怎么挪呢？</p>
<p>第一步，findTaskLocked(): 找到Activity所在TaskRecord;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ActivityRecord <span class="title">findTaskLocked</span><span class="params">(ActivityRecord target)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = mTaskHistory.get(taskNdx);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord r = task.getTopActivity();</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> Intent taskIntent = task.intent;</span><br><span class="line">        <span class="keyword">final</span> Intent affinityIntent = task.affinityIntent;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!isDocument &amp;&amp; !taskIsDocument &amp;&amp; task.rootAffinity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (task.rootAffinity.equals(target.taskAffinity)) &#123;</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (taskIntent != <span class="keyword">null</span> &amp;&amp; taskIntent.getComponent() != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            taskIntent.getComponent().compareTo(cls) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            Objects.equals(documentData, taskDocumentData)) &#123;</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="function"><span class="keyword">if</span> <span class="title">if</span> <span class="params">(affinityIntent != <span class="keyword">null</span> &amp;&amp; affinityIntent.getComponent()</span> !</span>= <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            affinityIntent.getComponent().compareTo(cls) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            Objects.equals(documentData, taskDocumentData)) &#123;</span><br><span class="line">            <span class="keyword">return</span> r</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数的功能是找到target ActivityRecord所在的Task，如果找到，则返回Task栈顶的ActivityRecord，否则，返回null。 主体逻辑是对ActivityStack中的所有Task进行遍历，以下几种情况表示找到了ActivityRecord的宿主task：</p>
<ul>
<li>Affinity相同。rootAffinity表示第一次启动该task时affinity值，如果一个ActivityRecord的taskAffinity属性与其相等， 那么这个task自然是ActivityRecord的宿主;</li>
<li>Intent的包名相同。</li>
<li>Affinity Intent的包名相同。</li>
</ul>
<p>第二步，moveToFront(): 将TaskRecord所在的ActivityStack挪到前台;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">moveToFront</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isAttached()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isOnHomeDisplay()) &#123;</span><br><span class="line">            mStackSupervisor.moveHomeStack(isHomeStack(), reason);</span><br><span class="line">        &#125;</span><br><span class="line">        mStacks.remove(<span class="keyword">this</span>);</span><br><span class="line">        mStacks.add(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = topTask();</span><br><span class="line">        <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mWindowManager.moveTaskToTop(task.taskId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，会有一些判定：</p>
<ul>
<li>isAttached()： 只有在当前ActivityStack绑定到显示设备的情况下，才需要挪到;</li>
<li>isOnHomeDisplay()： 如果当前是默认的显示设备，则对HomeStack(桌面)进行挪动， 这涉及到对多个ActivityStack的操作，所以需要通过ActivityStackSupervisor完成;</li>
<li>isHomeStack()： 如果当前是HomeStack，则将其挪到前后; 否则，将HomeStack挪到后台</li>
</ul>
<p>然后，就是对mStacks这个属性进行操作：在mStacks数组中，删除已有的ActivityStack对象，并添加一个新的，这样做其实达到了一个目的，前台的ActivityStacks处于mStacks末尾。</p>
<p>最后，调用WMS.moveTaskToTop()通知窗口的进行变化调整。</p>
<p>第三步， moveTaskToFrontLocked(): 将TaskRecord挪到ActivityStack的栈顶;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">moveTaskToFrontLocked</span><span class="params">(TaskRecord tr, ActivityRecord source, Bundle options,</span></span></span><br><span class="line"><span class="function"><span class="params">            String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numTasks = mTaskHistory.size();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> index = mTaskHistory.indexOf(tr);</span><br><span class="line">    <span class="comment">// 判定ActivityStack是否需要挪动任务栈</span></span><br><span class="line">    <span class="keyword">if</span> (numTasks == <span class="number">0</span> || index &lt; <span class="number">0</span>)  &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调整ActivityStack</span></span><br><span class="line">    insertTaskAtTop(tr);</span><br><span class="line">    moveToFront(reason);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 将栈顶的Activity置为Resumed状态</span></span><br><span class="line">    mStackSupervisor.resumeTopActivitiesLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，会经过判定：如果当前的ActivityStack为空，或者不存在要挪动的任务，则不需要对当前ActivityStack进行调整;</p>
<p>然后，确定目标任务在当前ActivityStack中，则对ActivityStack进行调整，将目标任务插入ActivityStack栈顶。</p>
<ul>
<li>insertTaskAtTop()，会先将已有的目标任务删除，再重新添加到栈顶位置;</li>
<li>moveToFront()，在第二步中执行过一次，因为在某些场景下，只会调用moveToFront()，不会调用moveTaskToFrontLocked(); 一旦要将任务挪到ActivityStack栈顶，意味着ActivityStack也一定要挪到前台;</li>
</ul>
<p>最后，将任务栈顶的Activity置为Resumed状态，这里是通过ActivityStackSupervisor完成的。因为可能同时存在多个显示设备，所以需要对多个ActivityStack进行操作。</p>
<blockquote>
<p>Activity管理中有两个栈顶：一是ActivityStack的栈顶，它对应到要显示的TaskRecord; 二是TaskRecord的栈顶，它对应到要显示的Activity。简单来说，当前显示的Activity一定是位于其所属的TaskRecord的栈顶，TaskRecord也一定位于其所属的ActivityStack的栈顶。</p>
</blockquote>
<h1 id="ActivityDisplay"><a href="#ActivityDisplay" class="headerlink" title="ActivityDisplay"></a>ActivityDisplay</h1><p>Android支持多屏显示，在不同的显示设备上可以有不同的ActivityStack。</p>
<p>所有的ActivityStack都是通过ActivityStackSupervisor管理起来的。ActivityDisplay对应到一个显示设备，默认的显示设备是手机屏幕。 ActivityStackSupervisor间接通过ActivityDisplay来维护多个ActivityStack的状态。 ActivityStack有一个属性是mStacks，当mStacks不为空时，表示ActivityStack已经绑定到了显示设备， 其实ActivityStack.mStacks只是一个副本，真正的对象在ActivityDisplay中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ActivityStackSupervisor mSupervisor;</span><br><span class="line"><span class="comment">/** Actual Display this object tracks. */</span></span><br><span class="line"><span class="keyword">int</span> mDisplayId;</span><br><span class="line">Display mDisplay;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * All of the stacks on this display. Order matters, topmost stack is in front of all other</span></span><br><span class="line"><span class="comment"> * stacks, bottommost behind. Accessed directly by ActivityManager package classes. Any calls</span></span><br><span class="line"><span class="comment"> * changing the list should also call &#123;<span class="doctag">@link</span> #onStackOrderChanged()&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ActivityStack&gt; mStacks = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> ArrayList&lt;OnStackOrderChangedListener&gt; mStackOrderChangedCallbacks = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Array of all UIDs that are present on the display. */</span></span><br><span class="line"><span class="keyword">private</span> IntArray mDisplayAccessUIDs = <span class="keyword">new</span> IntArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** All tokens used to put activities on this stack to sleep (including mOffToken) */</span></span><br><span class="line"><span class="keyword">final</span> ArrayList&lt;ActivityManagerInternal.SleepToken&gt; mAllSleepTokens = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">/** The token acquired by ActivityStackSupervisor to put stacks on the display to sleep */</span></span><br><span class="line">ActivityManagerInternal.SleepToken mOffToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mSleeping;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cached reference to some special stacks we tend to get a lot so we don&#x27;t need to loop</span></span><br><span class="line"><span class="comment">// through the list to find them.</span></span><br><span class="line"><span class="keyword">private</span> ActivityStack mHomeStack = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> ActivityStack mRecentsStack = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> ActivityStack mPinnedStack = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> ActivityStack mSplitScreenPrimaryStack = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used in updating the display size</span></span><br><span class="line"><span class="keyword">private</span> Point mTmpDisplaySize = <span class="keyword">new</span> Point();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DisplayWindowController mWindowContainerController;</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>mDisplayId</td>
<td>显示设备的唯一标识</td>
</tr>
<tr>
<td>mDisplay</td>
<td>获取显示设备信息的工具类，</td>
</tr>
<tr>
<td>mDisplayInfo</td>
<td>显示设备信息的数据结构，包括类型、大小、分辨率等</td>
</tr>
<tr>
<td>mStacks</td>
<td>/**<br>     * All of the stacks on this display. Order matters, topmost stack is in front of all other<br>     * stacks, bottommost behind. Accessed directly by ActivityManager package classes. Any calls<br>     * changing the list should also call {@link #onStackOrderChanged()}.<br>     */  绑定到显示设备上的ActivityStack</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>行为</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>attachActivities()</td>
<td>将一个ActivityStack绑定到显示设备</td>
</tr>
<tr>
<td>setVisibleBehindActivity()</td>
<td>设置后台显示的Activity</td>
</tr>
<tr>
<td>moveHomeStack()</td>
<td>移动HomeStack</td>
</tr>
</tbody></table>
<h1 id="ActivityContainer"><a href="#ActivityContainer" class="headerlink" title="ActivityContainer"></a>ActivityContainer</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityContainer</span> <span class="keyword">extends</span> <span class="title">WindowManagerState</span>.<span class="title">ConfigurationContainer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> mFullscreen;</span><br><span class="line">    <span class="keyword">protected</span> Rect mBounds;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> mMinWidth = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> mMinHeight = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ActivityContainer(ConfigurationContainerProto proto) &#123;</span><br><span class="line">        <span class="keyword">super</span>(proto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Rect <span class="title">getBounds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBounds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isFullscreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mFullscreen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMinWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMinWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMinHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMinHeight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="ActivityStackSupervisor"><a href="#ActivityStackSupervisor" class="headerlink" title="ActivityStackSupervisor"></a>ActivityStackSupervisor</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">	...........</span><br><span class="line">	mStackSupervisor = createStackSupervisor();</span><br><span class="line">    mStackSupervisor.onConfigurationChanged(mTempConfig);</span><br><span class="line">    mKeyguardController = mStackSupervisor.getKeyguardController();</span><br><span class="line">    mCompatModePackages = <span class="keyword">new</span> CompatModePackages(<span class="keyword">this</span>, systemDir, mHandler);</span><br><span class="line">    mIntentFirewall = <span class="keyword">new</span> IntentFirewall(<span class="keyword">new</span> IntentFirewallInterface(), mHandler);</span><br><span class="line">    mTaskChangeNotificationController =</span><br><span class="line">        <span class="keyword">new</span> TaskChangeNotificationController(<span class="keyword">this</span>, mStackSupervisor, mHandler);</span><br><span class="line">    mActivityStartController = <span class="keyword">new</span> ActivityStartController(<span class="keyword">this</span>);</span><br><span class="line">    mRecentTasks = createRecentTasks();</span><br><span class="line">    mStackSupervisor.setRecentTasks(mRecentTasks);</span><br><span class="line">    mLockTaskController = <span class="keyword">new</span> LockTaskController(mContext, mStackSupervisor, mHandler);</span><br><span class="line">    .............</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ActivityStackSupervisor <span class="title">createStackSupervisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityStackSupervisor supervisor = <span class="keyword">new</span> 					ActivityStackSupervisor(<span class="keyword">this</span>,mHandler.getLooper());</span><br><span class="line">        supervisor.initialize();</span><br><span class="line">        <span class="keyword">return</span> supervisor;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/AMS-ActivityStack/image-20201214155050544.png" alt="image-20201214155050544"></p>
<p>ActivityStackSupervisor是ActivityStack的管理者，内部管理了mHomeStack、mFocusedStack和mLastFocusedStack三个ActivityStack。其中，mHomeStack管理的是Launcher相关的Activity栈， stackId为0；mFocusedStack管理的是当前显示在前台Activity的Activity栈；mLastFocusedStack管理的是上一次显示在前台Activity的Activity栈。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** The stack containing the launcher app. Assumed to always be attached to</span></span><br><span class="line"><span class="comment">     * Display.DEFAULT_DISPLAY. */</span></span><br><span class="line">    ActivityStack mHomeStack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The stack currently receiving input or launching the next activity. */</span></span><br><span class="line">    ActivityStack mFocusedStack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** If this is the same as mFocusedStack then the activity on the top of the focused stack has</span></span><br><span class="line"><span class="comment">     * been resumed. If stacks are changing position this will hold the old stack until the new</span></span><br><span class="line"><span class="comment">     * stack becomes resumed after which it will be set to mFocusedStack. */</span></span><br><span class="line">    <span class="keyword">private</span> ActivityStack mLastFocusedStack;</span><br></pre></td></tr></table></figure>

<p>ActivityStackSupervisor的职责是管理多个ActivityStack。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>mHomeStack</td>
<td>主屏(桌面)所在ActivityStack</td>
</tr>
<tr>
<td>mFocusedStack</td>
<td>表示焦点ActivityStack，它能够获取用户输入</td>
</tr>
<tr>
<td>mLastFocusedStack</td>
<td>上一个焦点ActivityStack</td>
</tr>
<tr>
<td>mActivityDisplays</td>
<td>表示当前的显示设备，ActivityDisplay中绑定了若干ActivityStack。通过该属性就能间接获取所有ActivityStack的信息</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>行为</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>setFocusedStack()</td>
<td>设置当前的焦点ActivityStack</td>
</tr>
<tr>
<td>adjustStackFocus()</td>
<td></td>
</tr>
<tr>
<td>startHomeActivity()</td>
<td>启动桌面</td>
</tr>
</tbody></table>
<p>ActivityStackSupervisor有很多与ActivityStack功能类似的行为，不过都是针对多个ActivityStack进行操作。 譬如findTaskLocked()， findActivityLocked()， topRunningActivityLocked(), ensureActivitiesVisibleLocked()等，</p>
<p><code>场景 1</code> 在启动一个新的Activity时，需要设置当前的焦点，通过AMS.setFocusedActivityLocked()函数，就能设置一个 ActivityRecord为当前的焦点Activity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setFocusedActivityLocked</span><span class="params">(ActivityRecord r, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFocusedActivity != r) &#123;</span><br><span class="line">        mFocusedActivity = r;</span><br><span class="line">        ...</span><br><span class="line">        mStackSupervisor.setFocusedStack(r, reason + <span class="string">&quot; setFocusedActivity&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mWindowManager.setFocusedApp(r.appToken, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        applyUpdateLockStateLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数的逻辑很简单，如果当前的焦点(mFocusedActivity)不是待显示的(r)，则需要更新焦点; 然后，就发起了其他函数调用。 这里，需要通过ActivityStackSupervisor完成对ActivityStack的管理，通过调用setFocusedStack()来设置当前的焦点Stack， 焦点Stack就是焦点Activity所属的ActivityStack。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFocusedStack</span><span class="params">(ActivityRecord r, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = r.task;</span><br><span class="line">        <span class="comment">// 判断输入的ActivityRecord是否为HomeActivity</span></span><br><span class="line">        <span class="keyword">boolean</span> isHomeActivity = !r.isApplicationActivity();</span><br><span class="line">        <span class="keyword">if</span> (!isHomeActivity &amp;&amp; task != <span class="keyword">null</span>) &#123;</span><br><span class="line">            isHomeActivity = !task.isApplicationTask();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isHomeActivity &amp;&amp; task != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord parent = task.stack.mActivityContainer.mParentActivity;</span><br><span class="line">            isHomeActivity = parent != <span class="keyword">null</span> &amp;&amp; parent.isHomeActivity();</span><br><span class="line">        &#125;</span><br><span class="line">        moveHomeStack(isHomeActivity, reason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只有前台的ActivityStack才能获取焦点，所以，该函数的功能就是要将待显示的Activity所在的ActivityStack挪到前台。 很重要的一个处理逻辑就是判定待显示的ActivityRecord的类型是否为HomeActivity，判定细节此处不表。结果是： 如果待显示的ActivityRecord类型为HomeActivity，则需要将HomeStack挪到前台; 否则，意味着要将HomeStack挪到后台。 挪动HomeStack，是通过moveHomeStack()这个函数实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveHomeStack</span><span class="params">(<span class="keyword">boolean</span> toFront, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 获取当前的Top Stack</span></span><br><span class="line">    ArrayList&lt;ActivityStack&gt; stacks = mHomeStack.mStacks;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> topNdx = stacks.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (topNdx &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ActivityStack topStack = stacks.get(topNdx);</span><br><span class="line">    <span class="comment">// 2. 判定HomeStack是否需要挪动</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> homeInFront = topStack == mHomeStack;</span><br><span class="line">    <span class="keyword">if</span> (homeInFront != toFront) &#123;</span><br><span class="line">        mLastFocusedStack = topStack;</span><br><span class="line">        stacks.remove(mHomeStack);</span><br><span class="line">        stacks.add(toFront ? topNdx : <span class="number">0</span>, mHomeStack);</span><br><span class="line">        mFocusedStack = stacks.get(topNdx);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 3. 判定当前AMS是否完成启动</span></span><br><span class="line">    <span class="keyword">if</span> (mService.mBooting || !mService.mBooted) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord r = topRunningActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; r.idle) &#123;</span><br><span class="line">            checkFinishBootingLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.获取当前的Top Stack，其实就是获取mStacks这个数组最后的元素。mStacks这个属性在ActivityStack和ActivityDisplay中都见过，它们是同一个东西，ActivityStackSupervisor要管理的就是这个东西;</p>
<p>2.判定当前HomeStack是否需要挪动。有四种情况：</p>
<ul>
<li>homeInFront = true, toFront = false： 表示HomeStack在前台，要将其挪到后台，则需要将HomeStack挪到mStacks的0号位置;</li>
<li>homeInFront = true, toFront = true： 表示HomeStack在前台，要将其挪到前台，则不需要对mStacks进行调整;</li>
<li>homeInFront = false, toFront = true： 表示HomeStack在后台，要将其挪到前台，则需要将HomeStack挪到mStacks的末尾;</li>
<li>homeInFront = false, toFront = false： 表示HomeStack在后台，要将其挪到后台，则不需要对mStacks进行调整。</li>
</ul>
<p>3.判断当前AMS是否完成启动。如果当前是刚开机，AMS都还未启动完成，需要显示的Activity还处于idle状态，则需要发起一次是否启动完成的检查</p>
<h1 id="ProcessRecord"><a href="#ProcessRecord" class="headerlink" title="ProcessRecord"></a>ProcessRecord</h1><p>AMS采用ProcessRecord这个数据结构来维护进程运行时的状态信息，当创建系统进程(system_process)或应用进程的时候，就会通过AMS初始化一个ProcessRecord。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Full information about a particular process that</span></span><br><span class="line"><span class="comment"> * is currently running.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = TAG_WITH_CLASS_NAME ? <span class="string">&quot;ProcessRecord&quot;</span> : TAG_AM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService; <span class="comment">// where we came from</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BatteryStatsImpl mBatteryStats; <span class="comment">// where to collect runtime statistics</span></span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo info; <span class="comment">// all about the first app in the process</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isolated;     <span class="comment">// true if this is a special isolated process</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid;              <span class="comment">// uid of process; may be different from &#x27;info&#x27; if isolated</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId;           <span class="comment">// user of process.</span></span><br><span class="line">    <span class="keyword">final</span> String processName;   <span class="comment">// name of the process</span></span><br><span class="line">    <span class="comment">// List of packages running in the process</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, ProcessStats.ProcessStateHolder&gt; pkgList = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> ProcessList.ProcStateMemTracker procStateMemTracker</span><br><span class="line">            = <span class="keyword">new</span> ProcessList.ProcStateMemTracker();</span><br><span class="line">    UidRecord uidRecord;        <span class="comment">// overall state of process&#x27;s uid.</span></span><br><span class="line">    ArraySet&lt;String&gt; pkgDeps;   <span class="comment">// additional packages we have a dependency on</span></span><br><span class="line">    IApplicationThread thread;  <span class="comment">// the actual proc...  may be null only if</span></span><br><span class="line">                                <span class="comment">// &#x27;persistent&#x27; is true (in which case we</span></span><br><span class="line">                                <span class="comment">// are in the process of launching the app)</span></span><br><span class="line">    ProcessState baseProcessTracker;</span><br><span class="line">    BatteryStatsImpl.Uid.Proc curProcBatteryStats;</span><br><span class="line">    <span class="keyword">int</span> pid;                    <span class="comment">// The process of this application; 0 if none</span></span><br><span class="line">    String procStatFile;        <span class="comment">// path to /proc/&lt;pid&gt;/stat</span></span><br><span class="line">    <span class="keyword">int</span>[] gids;                 <span class="comment">// The gids this process was launched with</span></span><br><span class="line">    String requiredAbi;         <span class="comment">// The ABI this process was launched with</span></span><br><span class="line">    String instructionSet;      <span class="comment">// The instruction set this process was launched with</span></span><br><span class="line">    <span class="keyword">boolean</span> starting;           <span class="comment">// True if the process is being started</span></span><br><span class="line">    <span class="keyword">long</span> lastActivityTime;      <span class="comment">// For managing the LRU list</span></span><br><span class="line">    <span class="keyword">long</span> lastPssTime;           <span class="comment">// Last time we retrieved PSS data</span></span><br><span class="line">    <span class="keyword">long</span> nextPssTime;           <span class="comment">// Next time we want to request PSS data</span></span><br><span class="line">    <span class="keyword">long</span> lastStateTime;         <span class="comment">// Last time setProcState changed</span></span><br><span class="line">    <span class="keyword">long</span> initialIdlePss;        <span class="comment">// Initial memory pss of process for idle maintenance.</span></span><br><span class="line">    <span class="keyword">long</span> lastPss;               <span class="comment">// Last computed memory pss.</span></span><br><span class="line">    <span class="keyword">long</span> lastSwapPss;           <span class="comment">// Last computed SwapPss.</span></span><br><span class="line">    <span class="keyword">long</span> lastCachedPss;         <span class="comment">// Last computed pss when in cached state.</span></span><br><span class="line">    <span class="keyword">long</span> lastCachedSwapPss;     <span class="comment">// Last computed SwapPss when in cached state.</span></span><br><span class="line">    <span class="keyword">int</span> maxAdj;                 <span class="comment">// Maximum OOM adjustment for this process</span></span><br><span class="line">    <span class="keyword">int</span> curRawAdj;              <span class="comment">// Current OOM unlimited adjustment for this process</span></span><br><span class="line">    <span class="keyword">int</span> setRawAdj;              <span class="comment">// Last set OOM unlimited adjustment for this process</span></span><br><span class="line">    <span class="keyword">int</span> curAdj;                 <span class="comment">// Current OOM adjustment for this process</span></span><br><span class="line">    <span class="keyword">int</span> setAdj;                 <span class="comment">// Last set OOM adjustment for this process</span></span><br><span class="line">    <span class="keyword">int</span> verifiedAdj;            <span class="comment">// The last adjustment that was verified as actually being set</span></span><br><span class="line">    <span class="keyword">int</span> curSchedGroup;          <span class="comment">// Currently desired scheduling class</span></span><br><span class="line">    <span class="keyword">int</span> setSchedGroup;          <span class="comment">// Last set to background scheduling class</span></span><br><span class="line">    <span class="keyword">int</span> vrThreadTid;            <span class="comment">// Thread currently set for VR scheduling</span></span><br><span class="line">    <span class="keyword">int</span> trimMemoryLevel;        <span class="comment">// Last selected memory trimming level</span></span><br><span class="line">    <span class="keyword">int</span> curProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Currently computed process state</span></span><br><span class="line">    <span class="keyword">int</span> repProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Last reported process state</span></span><br><span class="line">    <span class="keyword">int</span> setProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Last set process state in process tracker</span></span><br><span class="line">    <span class="keyword">int</span> pssProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Currently requesting pss for</span></span><br><span class="line">    <span class="keyword">int</span> pssStatType;            <span class="comment">// The type of stat collection that we are currently requesting</span></span><br><span class="line">    <span class="keyword">int</span> savedPriority;          <span class="comment">// Previous priority value if we&#x27;re switching to non-SCHED_OTHER</span></span><br><span class="line">    <span class="keyword">int</span> renderThreadTid;        <span class="comment">// TID for RenderThread</span></span><br><span class="line">    <span class="keyword">boolean</span> serviceb;           <span class="comment">// Process currently is on the service B list</span></span><br><span class="line">    <span class="keyword">boolean</span> serviceHighRam;     <span class="comment">// We are forcing to service B list due to its RAM use</span></span><br><span class="line">    <span class="keyword">boolean</span> notCachedSinceIdle; <span class="comment">// Has this process not been in a cached state since last idle?</span></span><br><span class="line">    <span class="keyword">boolean</span> hasClientActivities;  <span class="comment">// Are there any client services with activities?</span></span><br><span class="line">    <span class="keyword">boolean</span> hasStartedServices; <span class="comment">// Are there any started services running in this process?</span></span><br><span class="line">    <span class="keyword">boolean</span> foregroundServices; <span class="comment">// Running any services that are foreground?</span></span><br><span class="line">    <span class="keyword">boolean</span> foregroundActivities; <span class="comment">// Running any activities that are foreground?</span></span><br><span class="line">    <span class="keyword">boolean</span> repForegroundActivities; <span class="comment">// Last reported foreground activities.</span></span><br><span class="line">    <span class="keyword">boolean</span> systemNoUi;         <span class="comment">// This is a system process, but not currently showing UI.</span></span><br><span class="line">    <span class="keyword">boolean</span> hasShownUi;         <span class="comment">// Has UI been shown in this process since it was started?</span></span><br><span class="line">    <span class="keyword">boolean</span> hasTopUi;           <span class="comment">// Is this process currently showing a non-activity UI that the user</span></span><br><span class="line">                                <span class="comment">// is interacting with? E.g. The status bar when it is expanded, but</span></span><br><span class="line">                                <span class="comment">// not when it is minimized. When true the</span></span><br><span class="line">                                <span class="comment">// process will be set to use the ProcessList#SCHED_GROUP_TOP_APP</span></span><br><span class="line">                                <span class="comment">// scheduling group to boost performance.</span></span><br><span class="line">    <span class="keyword">boolean</span> hasOverlayUi;       <span class="comment">// Is the process currently showing a non-activity UI that</span></span><br><span class="line">                                <span class="comment">// overlays on-top of activity UIs on screen. E.g. display a window</span></span><br><span class="line">                                <span class="comment">// of type</span></span><br><span class="line">                                <span class="comment">// android.view.WindowManager.LayoutParams#TYPE_APPLICATION_OVERLAY</span></span><br><span class="line">                                <span class="comment">// When true the process will oom adj score will be set to</span></span><br><span class="line">                                <span class="comment">// ProcessList#PERCEPTIBLE_APP_ADJ at minimum to reduce the chance</span></span><br><span class="line">                                <span class="comment">// of the process getting killed.</span></span><br><span class="line">    <span class="keyword">boolean</span> runningRemoteAnimation; <span class="comment">// Is the process currently running a RemoteAnimation? When true</span></span><br><span class="line">                                <span class="comment">// the process will be set to use the</span></span><br><span class="line">                                <span class="comment">// ProcessList#SCHED_GROUP_TOP_APP scheduling group to boost</span></span><br><span class="line">                                <span class="comment">// performance, as well as oom adj score will be set to</span></span><br><span class="line">                                <span class="comment">// ProcessList#VISIBLE_APP_ADJ at minimum to reduce the chance</span></span><br><span class="line">                                <span class="comment">// of the process getting killed.</span></span><br><span class="line">    <span class="keyword">boolean</span> pendingUiClean;     <span class="comment">// Want to clean up resources from showing UI?</span></span><br><span class="line">    <span class="keyword">boolean</span> hasAboveClient;     <span class="comment">// Bound using BIND_ABOVE_CLIENT, so want to be lower</span></span><br><span class="line">    <span class="keyword">boolean</span> treatLikeActivity;  <span class="comment">// Bound using BIND_TREAT_LIKE_ACTIVITY</span></span><br><span class="line">    <span class="keyword">boolean</span> bad;                <span class="comment">// True if disabled in the bad process list</span></span><br><span class="line">    <span class="keyword">boolean</span> killedByAm;         <span class="comment">// True when proc has been killed by activity manager, not for RAM</span></span><br><span class="line">    <span class="keyword">boolean</span> killed;             <span class="comment">// True once we know the process has been killed</span></span><br><span class="line">    <span class="keyword">boolean</span> procStateChanged;   <span class="comment">// Keep track of whether we changed &#x27;setAdj&#x27;.</span></span><br><span class="line">    <span class="keyword">boolean</span> reportedInteraction;<span class="comment">// Whether we have told usage stats about it being an interaction</span></span><br><span class="line">    <span class="keyword">boolean</span> unlocked;           <span class="comment">// True when proc was started in user unlocked state</span></span><br><span class="line">    <span class="keyword">long</span> interactionEventTime;  <span class="comment">// The time we sent the last interaction event</span></span><br><span class="line">    <span class="keyword">long</span> fgInteractionTime;     <span class="comment">// When we became foreground for interaction purposes</span></span><br><span class="line">    String waitingToKill;       <span class="comment">// Process is waiting to be killed when in the bg, and reason</span></span><br><span class="line">    Object forcingToImportant;  <span class="comment">// Token that is forcing this process to be important</span></span><br><span class="line">    <span class="keyword">int</span> adjSeq;                 <span class="comment">// Sequence id for identifying oom_adj assignment cycles</span></span><br><span class="line">    <span class="keyword">int</span> completedAdjSeq;        <span class="comment">// Sequence id for identifying oom_adj assignment cycles</span></span><br><span class="line">    <span class="keyword">boolean</span> containsCycle;      <span class="comment">// Whether this app has encountered a cycle in the most recent update</span></span><br><span class="line">    <span class="keyword">int</span> lruSeq;                 <span class="comment">// Sequence id for identifying LRU update cycles</span></span><br><span class="line">    CompatibilityInfo compat;   <span class="comment">// last used compatibility mode</span></span><br><span class="line">    IBinder.DeathRecipient deathRecipient; <span class="comment">// Who is watching for the death.</span></span><br><span class="line">    ActiveInstrumentation instr;<span class="comment">// Set to currently active instrumentation running in process</span></span><br><span class="line">    <span class="keyword">boolean</span> usingWrapper;       <span class="comment">// Set to true when process was launched with a wrapper attached</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;BroadcastRecord&gt; curReceivers = <span class="keyword">new</span> ArraySet&lt;BroadcastRecord&gt;();<span class="comment">// receivers currently running in the app</span></span><br><span class="line">    <span class="keyword">long</span> whenUnimportant;       <span class="comment">// When (uptime) the process last became unimportant</span></span><br><span class="line">    <span class="keyword">long</span> lastCpuTime;           <span class="comment">// How long proc has run CPU at last check</span></span><br><span class="line">    <span class="keyword">long</span> curCpuTime;            <span class="comment">// How long proc has run CPU most recently</span></span><br><span class="line">    <span class="keyword">long</span> lastRequestedGc;       <span class="comment">// When we last asked the app to do a gc</span></span><br><span class="line">    <span class="keyword">long</span> lastLowMemory;         <span class="comment">// When we last told the app that memory is low</span></span><br><span class="line">    <span class="keyword">long</span> lastProviderTime;      <span class="comment">// The last time someone else was using a provider in this process.</span></span><br><span class="line">    <span class="keyword">long</span> lastTopTime;           <span class="comment">// The last time the process was in the TOP state or greater.</span></span><br><span class="line">    <span class="keyword">boolean</span> reportLowMemory;    <span class="comment">// Set to true when waiting to report low mem</span></span><br><span class="line">    <span class="keyword">boolean</span> empty;              <span class="comment">// Is this an empty background process?</span></span><br><span class="line">    <span class="keyword">boolean</span> cached;             <span class="comment">// Is this a cached process?</span></span><br><span class="line">    String adjType;             <span class="comment">// Debugging: primary thing impacting oom_adj.</span></span><br><span class="line">    <span class="keyword">int</span> adjTypeCode;            <span class="comment">// Debugging: adj code to report to app.</span></span><br><span class="line">    Object adjSource;           <span class="comment">// Debugging: option dependent object.</span></span><br><span class="line">    <span class="keyword">int</span> adjSourceProcState;     <span class="comment">// Debugging: proc state of adjSource&#x27;s process.</span></span><br><span class="line">    Object adjTarget;           <span class="comment">// Debugging: target component impacting oom_adj.</span></span><br><span class="line">    Runnable crashHandler;      <span class="comment">// Optional local handler to be invoked in the process crash.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// all activities running in the process</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; activities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// any tasks this process had run root activities in</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;TaskRecord&gt; recentTasks = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// all ServiceRecord running in this process</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;ServiceRecord&gt; services = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="comment">// services that are currently executing code (need to remain foreground).</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;ServiceRecord&gt; executingServices = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="comment">// All ConnectionRecord this process holds</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;ConnectionRecord&gt; connections = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="comment">// all IIntentReceivers that are registered from this process.</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;ReceiverList&gt; receivers = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="comment">// class (String) -&gt; ContentProviderRecord</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, ContentProviderRecord&gt; pubProviders = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// All ContentProviderRecord process is using</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;ContentProviderConnection&gt; conProviders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    String isolatedEntryPoint;  <span class="comment">// Class to run on start if this is a special isolated process.</span></span><br><span class="line">    String[] isolatedEntryPointArgs; <span class="comment">// Arguments to pass to isolatedEntryPoint&#x27;s main().</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> execServicesFg;     <span class="comment">// do we need to be executing services in the foreground?</span></span><br><span class="line">    <span class="keyword">boolean</span> persistent;         <span class="comment">// always keep this application running?</span></span><br><span class="line">    <span class="keyword">boolean</span> crashing;           <span class="comment">// are we in the process of crashing?</span></span><br><span class="line">    Dialog crashDialog;         <span class="comment">// dialog being displayed due to crash.</span></span><br><span class="line">    <span class="keyword">boolean</span> forceCrashReport;   <span class="comment">// suppress normal auto-dismiss of crash dialog &amp; report UI?</span></span><br><span class="line">    <span class="keyword">boolean</span> notResponding;      <span class="comment">// does the app have a not responding dialog?</span></span><br><span class="line">    Dialog anrDialog;           <span class="comment">// dialog being displayed due to app not resp.</span></span><br><span class="line">    <span class="keyword">boolean</span> removed;            <span class="comment">// has app package been removed from device?</span></span><br><span class="line">    <span class="keyword">boolean</span> debugging;          <span class="comment">// was app launched for debugging?</span></span><br><span class="line">    <span class="keyword">boolean</span> waitedForDebugger;  <span class="comment">// has process show wait for debugger dialog?</span></span><br><span class="line">    Dialog waitDialog;          <span class="comment">// current wait for debugger dialog</span></span><br><span class="line"></span><br><span class="line">    String shortStringName;     <span class="comment">// caching of toShortString() result.</span></span><br><span class="line">    String stringName;          <span class="comment">// caching of toString() result.</span></span><br><span class="line">    <span class="keyword">boolean</span> pendingStart;       <span class="comment">// Process start is pending.</span></span><br><span class="line">    <span class="keyword">long</span> startSeq;              <span class="comment">// Seq no. indicating the latest process start associated with</span></span><br><span class="line">                                <span class="comment">// this process record.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// These reports are generated &amp; stored when an app gets into an error condition.</span></span><br><span class="line">    <span class="comment">// They will be &quot;null&quot; when all is OK.</span></span><br><span class="line">    ActivityManager.ProcessErrorStateInfo crashingReport;</span><br><span class="line">    ActivityManager.ProcessErrorStateInfo notRespondingReport;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Who will be notified of the error. This is usually an activity in the</span></span><br><span class="line">    <span class="comment">// app that installed the package.</span></span><br><span class="line">    ComponentName errorReportReceiver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process is currently hosting a backup agent for backup or restore</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> inFullBackup;</span><br><span class="line">    <span class="comment">// App is allowed to manage whitelists such as temporary Power Save mode whitelist.</span></span><br><span class="line">    <span class="keyword">boolean</span> whitelistManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Params used in starting this process.</span></span><br><span class="line">    String hostingType;</span><br><span class="line">    String hostingNameStr;</span><br><span class="line">    String seInfo;</span><br><span class="line">    <span class="keyword">long</span> startTime;</span><br><span class="line">    <span class="comment">// This will be same as &#123;@link #uid&#125; usually except for some apps used during factory testing.</span></span><br><span class="line">    <span class="keyword">int</span> startUid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>BatteryStats</td>
<td>电量统计的接口</td>
</tr>
<tr>
<td>ApplicationInfo</td>
<td>系统进程的ApplicationInfo是从android包中解析出来的数据; 应用程序的ApplicationInfo是从AndroidManifest.xml中解析出来的数据</td>
</tr>
<tr>
<td>Process Name</td>
<td>进程名称</td>
</tr>
<tr>
<td>UID</td>
<td>进程的UID。系统进程的UID是1000(Process.SYSTEM_UID); 应用进程的UID是从10000(Process.FIRST_APPLICATION_UID)开始分配的</td>
</tr>
<tr>
<td>maxAdj, curAdj, setAdj</td>
<td>各种不同的OOM Adjustment值</td>
</tr>
<tr>
<td>lastPss， lastPssTime</td>
<td>物理内存(PSS)相关，进程中有对象创建或销毁时，PSS相关的属性会被更新。</td>
</tr>
<tr>
<td>activities, services, receivers</td>
<td>进程中的Android组件，随着进程的运行，这些信息都可能需要更新。譬如Activity的启动时，ProcessRecord.activies会增加一个实例; 销毁时，对将对应的实例从activities删除</td>
</tr>
<tr>
<td>pkgList</td>
<td>进程中运行的包</td>
</tr>
<tr>
<td>thread</td>
<td>该属性是IApplicationThread类型的对象</td>
</tr>
</tbody></table>
<p>ProcessRecord有“激活(Active)”和“非激活(Inactive)”两种状态，只有将ProcessRecord绑定到一个实际进程的时候，才是激活状态。 绑定成功后，thread属性就被赋值，表示ProcessRecord已经激活。 激活后，AMS就可以通过这个接口完成对应用进程的管理，譬如启动Activity、派发广播等</p>
<table>
<thead>
<tr>
<th>行为</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>makeActive()</td>
<td>将ProcessRecord置成激活状态</td>
</tr>
<tr>
<td>makeInactive()</td>
<td>将ProcessRecord置成非激活状态</td>
</tr>
<tr>
<td>addPackage()</td>
<td>向ProcessRecord添加包</td>
</tr>
</tbody></table>
<h1 id="整体关系"><a href="#整体关系" class="headerlink" title="整体关系"></a>整体关系</h1><p>MS运行在SystemServer进程中。SystemServer进程启动时，会通过SystemServer.startBootstrapServices()来创建一个AMS的对象;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">        ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>AMS通过ActivityStackSupervisor来管理Activity。AMS对象只会存在一个，在初始化的时候，会创建一个唯一的ActivityStackSupervisor对象;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mStackSupervisor = createStackSupervisor();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ActivityStackSupervisor <span class="title">createStackSupervisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityStackSupervisor supervisor = <span class="keyword">new</span> ActivityStackSupervisor(<span class="keyword">this</span>, mHandler.getLooper());</span><br><span class="line">        supervisor.initialize();</span><br><span class="line">        <span class="keyword">return</span> supervisor;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>ActivityStackSupervisor中维护了显示设备的信息。当有新的显示设备添加时，会创建一个新的ActivityDisplay对象;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createStackOnDisplay</span><span class="params">(<span class="keyword">int</span> displayId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    enforceCallingPermission(MANAGE_ACTIVITY_STACKS, <span class="string">&quot;createStackOnDisplay()&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityDisplay display =</span><br><span class="line">            mStackSupervisor.getActivityDisplayOrCreateLocked(displayId);</span><br><span class="line">        <span class="keyword">if</span> (display == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> INVALID_STACK_ID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// TODO(multi-display): Have the caller pass in the windowing mode and activity type.</span></span><br><span class="line">        <span class="keyword">final</span> ActivityStack stack = display.createStack(</span><br><span class="line">            WINDOWING_MODE_FULLSCREEN_OR_SPLIT_SCREEN_SECONDARY, ACTIVITY_TYPE_STANDARD,</span><br><span class="line">            ON_TOP);</span><br><span class="line">        <span class="keyword">return</span> (stack != <span class="keyword">null</span>) ? stack.mStackId : INVALID_STACK_ID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>AMS维护了所有进程的信息ProcessRecord。当需要创建一个新的进程时， 会通过AMS.newProcessRecordLocked()函数来创建一个ProcessRecord对象， ProcessRecord对象都保存在AMS.mPidsSelfLocked这个属性中;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过ActivityStackSupervisor来创建ActivityRecord。当SystemServer进程收到来自应用进程的启动Activity请求时， 会通过ActivityStackSupervisor来创建一个ActivityRecord对象;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, ...)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">   ActivityRecord r  = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">           intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">           requestCode, componentSpecified, <span class="keyword">this</span>, container, options);</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在ActivityStack上创建TaskRecord。当需要创建新的任务栈时，就会通过ActivityStack对象来创建一个TaskRecord对象， 这样就建立了ActivityStack和TaskRecord的关联;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TaskRecord <span class="title">createTaskRecord</span><span class="params">(<span class="keyword">int</span> taskId, ActivityInfo info, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> toTop)</span> </span>&#123;</span><br><span class="line">    TaskRecord task = <span class="keyword">new</span> TaskRecord(mService, taskId, info, intent, voiceSession,</span><br><span class="line">            voiceInteractor);</span><br><span class="line">    addTask(task, toTop, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ActivityRecord的宿主TaskRecord。每一个ActivityRecord都需要找到自己的宿主TaskRecord，通过ActivityRecord.setTask()函数 就能建立ActivityRecord和TaskRecord的关联;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setTask</span><span class="params">(TaskRecord newTask, TaskRecord taskToAffiliateWith)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    task = newTask;</span><br><span class="line">    setTaskToAffiliateWith(taskToAffiliateWith);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>进程中运行的Activity信息。Activity在应用进程中运行，AMS中记录了进程中所有运行的Activity的信息，在ActivityRecord创建后， 会通过ProcessRecord.addPackage()函数，在ProcessRecord中登记ActivityRecord的信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">    ...</span><br><span class="line">    app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/krislight1105/tag/ActivityStackSupervisor/">https://www.cnblogs.com/krislight1105/tag/ActivityStackSupervisor/</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">SongSong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2020/12/14/AMS-ActivityStack/">http://example.com/2020/12/14/AMS-ActivityStack/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/android/">android</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/14/AMS-ProcessRecord/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">AMS-ProcessRecord</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/11/log%E6%A1%86%E6%9E%B6%E6%80%BB%E8%BF%B0/"><img class="next-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">log框架总述</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/10/04/CustomizeView-04/" title="动态换肤原理分析"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg2.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-04</div><div class="title">动态换肤原理分析</div></div></a></div><div><a href="/2020/09/30/CustomizeView/" title="CustomizeView"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg2.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-30</div><div class="title">CustomizeView</div></div></a></div><div><a href="/2020/10/02/CustomizeView-03/" title="View树创建流程分析"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg3.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-02</div><div class="title">View树创建流程分析</div></div></a></div><div><a href="/2020/10/14/Context理解/" title="Context理解"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-14</div><div class="title">Context理解</div></div></a></div><div><a href="/2020/10/13/ViewLayout/" title="View绘制流程分析"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-13</div><div class="title">View绘制流程分析</div></div></a></div><div><a href="/2020/10/16/binder_reg_jni/" title="binder的jni函数注册"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-16</div><div class="title">binder的jni函数注册</div></div></a></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By SongSong</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="http://makediffrencesong.github.io/">blog</a>!</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>